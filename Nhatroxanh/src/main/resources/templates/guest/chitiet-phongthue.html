<!DOCTYPE html>
<html lang="vi">

<head th:replace="~{/layouts/head}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<head>
    <title>Chi Tiết Phòng Đang Thuê</title>
    <link rel="stylesheet" th:href="@{/css/chitiet-phongthue-guest.css}">
    <style>
        /* Rating Modal Styles */
        .rating-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 16px 0;
        }

        .star {
            font-size: 32px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .rating-text {
            font-size: 16px;
            font-weight: 600;
            color: #3e83cc;
            margin-top: 12px;
        }

        .rating-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .rating-category {
            background: rgba(62, 131, 204, 0.05);
            border: 1px solid rgba(62, 131, 204, 0.1);
            border-radius: 12px;
            padding: 16px;
        }

        .category-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-stars {
            display: flex;
            gap: 4px;
        }

        .category-stars .star {
            font-size: 20px;
        }

        @media (max-width: 992px) {
            .rating-categories {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 768px) {
            .rating-categories {
                grid-template-columns: 1fr;
            }
        }

        .amenities-horizontal-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-left: 0;
            margin: 0;
            list-style: none;
        }

        .amenity-item-guest {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background-color: #f0f2f5;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
            border: 1px solid #ccc;
        }

        .amenity-item-guest i {
            margin-right: 6px;
            color: #28a745;
            /* Màu xanh thành công */
        }

        .custom-toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .custom-toast {
            display: flex;
            align-items: center;
            background-color: #e6f7f0;
            color: #1a2e05;
            padding: 12px 16px;
            border-left: 5px solid #10b981;
            border-radius: 10px;
            min-width: 320px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            font-size: 15px;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .custom-toast.error {
            background-color: #fff0f0;
            border-left-color: #ef4444;
            color: #7f1d1d;
        }

        .toast-icon {
            margin-right: 10px;
            font-size: 18px;
            color: #10b981;
        }

        .custom-toast.error .toast-icon {
            color: #ef4444;
        }

        .toast-message {
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Nhóm 2 nút sát nhau và căn giữa */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        /* Nút chỉnh sửa */
        .btn-edit-icon {
            background-color: #1976d2;
            /* xanh dương */
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-edit-icon i {
            margin-right: 4px;
        }

        .btn-edit-icon:hover {
            background-color: #1565c0;
        }

        /* Nút xóa */
        .btn-delete-icon {
            background-color: #f44336;
            /* đỏ */
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-delete-icon i {
            margin-right: 4px;
        }

        .btn-delete-icon:hover {
            background-color: #d32f2f;
        }

        .contract-utilities-list-guest {
            list-style-type: none;
            /* Ẩn dấu chấm */
            padding-left: 0;
            /* Bỏ khoảng cách bên trái */
            margin: 0;
        }

        .contract-terms-box {
            white-space: pre-wrap;
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            color: #333;
            line-height: 1.6;
            font-size: 15px;
        }
    </style>
</head>

<body class="detail-body-guest">
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/navbar}"></div>

    <div class="main-container-guest">
        <!-- Breadcrumb -->
        <nav class="breadcrumb-guest">
            <a href="/khach-thue/quan-ly-thue-tra" style="text-decoration: none;">
                <i class="fas fa-arrow-left"></i>
                Quản lý thuê trả
            </a>
            <span class="mx-2">/</span>
            <span class="active" th:text="'Thông tin phòng ' + ${contract.room.namerooms}">
            </span>
        </nav>
        <div class="custom-toast-container">
            <div th:if="${successMessage}" class="custom-toast success">
                <i class="toast-icon fas fa-check-circle"></i>
                <span class="toast-message" th:text="${successMessage}"></span>
                <button class="toast-close" aria-label="Đóng">×</button>
            </div>
            <div th:if="${errorMessage}" class="custom-toast error">
                <i class="toast-icon fas fa-exclamation-circle"></i>
                <span class="toast-message" th:text="${errorMessage}"></span>
                <button class="toast-close" aria-label="Đóng">×</button>
            </div>
        </div>
        <div class="page-header-guest">
            <div>
                <h1 class="page-title-guest">Chi Tiết Phòng Đang Thuê</h1>
                <p class="page-subtitle-guest"
                    th:text="'Thông tin chi tiết và báo cáo sự cố của phòng ' + ${contract.room.namerooms} + ' - ' + ${contract.room.category.name}">
                </p>
            </div>
        </div>

        <!-- Room Details Section -->
        <div class="section-card-guest">
            <h2 class="section-header-guest">
                <i class="fas fa-door-open"></i>
                Thông Tin Phòng
            </h2>

            <div class="room-info-section-guest">
                <div class="room-title-section-guest">
                    <div class="room-title-info-guest">
                        <h3 class="room-name-guest"
                            th:text="${contract.room.namerooms} + ' - ' + ${contract.room.category.name}">
                            Phòng A101 - Deluxe</h3>
                        <p class="room-type-guest" th:text="${contract.room.description}">
                            Phòng cao cấp với đầy đủ tiện nghi</p>
                        <div class="room-price-guest"
                            th:text="${#numbers.formatInteger(contract.price, 0, 'COMMA')} + ' VNĐ/tháng'">
                            1,200,000 VNĐ/tháng</div>
                    </div>
                    <div class="room-status-badge-guest">
                        <i class="fas fa-circle"></i>
                        <span th:text="${contract.status.name() == 'ACTIVE' ? 'Đang thuê' : 'Đã hoàn thành'}">Đang
                            thuê</span>

                    </div>
                </div>

                <div class="info-grid-guest">
                    <div class="info-item-guest">
                        <span class="info-label-guest">
                            <i class="fas fa-calendar-alt"></i>
                            Ngày thuê
                        </span>
                        <span class="info-value-guest"
                            th:text="${#dates.format(contract.startDate, 'dd/MM/yyyy')}">15/12/2024</span>
                    </div>
                    <div class="info-item-guest">
                        <span class="info-label-guest">
                            <i class="fas fa-calendar-check"></i>
                            Ngày hết hạn
                        </span>
                        <span class="info-value-guest"
                            th:text="${#dates.format(contract.endDate, 'dd/MM/yyyy')}">20/12/2024</span>
                    </div>
                    <div class="info-item-guest">
                        <span class="info-label-guest">
                            <i class="fas fa-users"></i>
                            Số khách
                        </span>
                        <span class="info-value-guest" th:text="${contract.room.max_tenants} + ' người'">2 người</span>
                    </div>
                    <div class="info-item-guest">
                        <span class="info-label-guest">
                            <i class="fas fa-expand-arrows-alt"></i>
                            Diện tích
                        </span>
                        <span class="info-value-guest" th:text="${contract.room.acreage} + ' m²'">35 m²</span>
                    </div>
                </div>

                <div class="amenities-section-guest">
                    <h4 class="amenities-title-guest">
                        <i class="fas fa-star"></i>
                        Tiện nghi phòng
                    </h4>
                    <div class="amenities-grid-guest">
                        <p th:if="${utilities == null or #sets.isEmpty(utilities)}" class="text-muted">
                            Phòng này hiện không có tiện ích nào.
                        </p>
                        <ul th:unless="${utilities == null or #sets.isEmpty(utilities)}"
                            class="amenities-horizontal-list">
                            <li class="amenity-item-guest" th:each="utility : ${utilities}">
                                <i class="fas fa-check-circle"></i>
                                <span th:text="${utility.name != null ? utility.name : 'Tiện ích không xác định'}">WiFi
                                    miễn phí</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="action-buttons-guest">
                <a href="/khach-thue/quan-ly-thue-tra">
                    <button class="action-btn-guest btn-back-guest">
                        <i class="fas fa-arrow-left"></i>
                        Quay lại
                    </button>
                </a>
                <a class="action-btn-guest btn-extend-guest"
                    th:href="@{/khach-thue/gia-han/{id}(id=${contract.contractId})}">
                    <i class="fas fa-calendar-plus"></i>
                    Gia hạn
                </a>
                <a class="action-btn-guest btn-return-guest"
                    th:href="@{'/khach-thue/tra-phong/' + ${contract.contractId}}">
                    <i class="fas fa-sign-out-alt"></i> Trả phòng
                </a>
                <button class="action-btn-guest btn-report-guest"
                    th:onclick="'openReportModal(' + ${contract.room.roomId} + ')'">
                    <i class="fas fa-exclamation-triangle"></i>
                    Báo cáo sự cố
                </button>
                <a th:href="@{/khach-thue/danh-gia(contractId=${contract.contractId})}"
                    class="action-btn-guest btn-rate-guest">
                    <i class="fas fa-star"></i>
                    Đánh giá
                </a>
            </div>
        </div>

        <!-- Contract Information Section -->
        <div class="section-card-guest">
            <h2 class="section-header-guest">
                <i class="fas fa-file-contract"></i>
                Thông Tin Hợp Đồng
            </h2>

            <div class="contract-info-section-guest">
                <div class="contract-header-guest">
                    <div class="contract-title-info-guest">
                        <h3 class="contract-number-guest" th:text="'Hợp đồng #' + ${contract.contractId}">
                            Hợp đồng #HD2024001</h3>
                        <p class="contract-type-guest">Hợp đồng thuê phòng trọ</p>
                    </div>
                    <div class="contract-status-badge-guest contract-active-guest">
                        <i class="fas fa-check-circle"></i>
                        <span th:text="${contract.status.name() == 'ACTIVE' ? 'Đang thuê' : 'Đã hoàn thành'}">Đang
                            thuê</span>
                    </div>
                </div>

                <div class="contract-compact-grid-guest">
                    <div class="contract-compact-row-guest">
                        <div class="contract-compact-item-guest">
                            <span class="contract-compact-icon-guest">
                                <i class="fas fa-home"></i>
                            </span>
                            <div class="contract-compact-content-guest">
                                <span class="contract-compact-label-guest">Địa chỉ</span>
                                <span th:text="${contract.room.hostel.address != null ? 
      contract.room.hostel.address.street + ', ' + 
      contract.room.hostel.address.ward.name + ', ' +
      contract.room.hostel.address.ward.district.name + ', ' +
      contract.room.hostel.address.ward.district.province.name 
      : 'Chưa xác định'}">
                                </span>

                            </div>
                        </div>
                        <div class="contract-compact-item-guest">
                            <span class="contract-compact-icon-guest">
                                <i class="fas fa-calendar-times"></i>
                            </span>
                            <div class="contract-compact-content-guest">
                                <span class="contract-compact-label-guest">Hết hạn</span>
                                <div class="contract-compact-expiry-guest">
                                    <span class="contract-compact-value-guest"
                                        th:text="${#dates.format(contract.endDate, 'dd/MM/yyyy')}">2024-12-31</span>
                                    <!-- <span th:if="${#temporals.dayDifference(#temporals.today(), contract.endDate) >= 0}"
                                        th:text="'Còn ' + ${#temporals.dayDifference(#temporals.today(), contract.endDate)} + ' ngày'"></span>
                                    <span
                                        th:unless="${#temporals.dayDifference(#temporals.today(), contract.endDate) >= 0}"
                                        th:text="'Đã quá hạn ' + ${-#temporals.dayDifference(#temporals.today(), contract.endDate)} + ' ngày'"></span> -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="contract-compact-row-guest">
                        <div class="contract-compact-item-guest">
                            <span class="contract-compact-icon-guest">
                                <i class="fas fa-user-tie"></i>
                            </span>
                            <div class="contract-compact-content-guest">
                                <span class="contract-compact-label-guest">Chủ nhà</span>
                                <span class="contract-compact-value-guest" th:text="${contract.owner.fullname}">
                                    Chị Nguyễn Thị Mai</span>
                            </div>
                        </div>
                        <div class="contract-compact-item-guest">
                            <span class="contract-compact-icon-guest">
                                <i class="fas fa-money-bill-wave"></i>
                            </span>
                            <div class="contract-compact-content-guest">
                                <span class="contract-compact-label-guest">Giá thuê</span>
                                <span class="contract-compact-price-guest"
                                    th:text="${#numbers.formatInteger(contract.price, 0, 'COMMA')} + ' VNĐ/tháng'">
                                    8,000,000 VNĐ/tháng</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="contract-actions-guest">
                    <button class="action-btn-guest btn-contract-view-guest"
                        th:onclick="'openContractDetailModal(' + ${contract.contractId} + ')'">
                        <i class="fas fa-eye"></i>
                        Xem hợp đồng đầy đủ
                    </button>
                    <button class="action-btn-guest btn-contract-download-guest" onclick="downloadContractAsPDF()">
                        <i class="fas fa-download"></i>
                        Tải xuống PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Incident Reports Section -->
        <div class="table-section-guest">
            <div
                style="background: linear-gradient(135deg, #3e83cc 0%, #549eed 100%); color: white; padding: 16px 20px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-exclamation-circle"></i>
                Báo Cáo Sự Cố
            </div>

            <div class="table-container-guest">
                <table class="reports-table-guest">
                    <thead>
                        <tr>
                            <th>Mã BC</th>
                            <th>Tiêu đề</th>
                            <th>Mô tả</th>
                            <th>Mức độ</th>
                            <th>Ngày báo cáo</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="report : ${incidentReports}"
                            th:onclick="'viewReportDetail(' + ${report.reportId} + ')'">
                            <td style="font-weight: 600;" th:text="'#BC' + ${report.reportId}">BC001</td>
                            <td style="text-align: left; font-weight: 600;" th:text="${report.incidentType}">
                                Điều hòa không hoạt động</td>
                            <td style="text-align: left; max-width: 200px;" th:text="${report.description}">
                                Điều hòa không thể bật</td>
                            <td>
                                <span class="priority-badge-guest" th:classappend="${report.level.name() == 'CAO' ? 'priority-high-guest' :
                       report.level.name() == 'TRUNG_BINH' ? 'priority-medium-guest' : 
                       'priority-low-guest'}" th:text="${report.level.name() == 'CAO' ? 'Cao' :
                report.level.name() == 'TRUNG_BINH' ? 'Trung bình' : 'Thấp'}">
                                </span>
                            </td>
                            <td th:text="${#dates.format(report.reportedAt, 'dd/MM/yyyy')}">16/12/2024</td>
                            <td>
                                <span class="status-badge-guest" th:classappend="${report.status.name() == 'CHUA_XU_LY' ? 'status-pending-guest' :
                       report.status.name() == 'DANG_XU_LY' ? 'status-processing-guest' : 
                       'status-resolved-guest'}" th:text="${report.status.name() == 'CHUA_XU_LY' ? 'Chưa xử lý' :
                report.status.name() == 'DANG_XU_LY' ? 'Đang xử lý' : 'Đã giải quyết'}">
                                </span>
                            </td>
                            <td class="action-buttons">
                                <!-- Nút chỉnh sửa -->
                                <a th:href="@{/khach-thue/chitiet-phongthue/{cid}(cid=${contract.contractId}, editId=${report.reportId})}"
                                    class="btn-edit-icon text-decoration-none" title="Chỉnh sửa báo cáo">
                                    <i class="fa-solid fa-pen-to-square"></i> Sửa
                                </a>
                                <!-- Nút xóa -->
                                <button type="button" class="btn-delete-icon " title="Xóa báo cáo"
                                    th:onclick="'confirmDeleteReport(' + ${report.reportId} + ',' + ${contract.contractId} + ')'">
                                    <i class="fa-solid fa-trash-can"></i> Xóa
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mobile-cards-container-guest">
                <div class="report-card-mobile-guest" th:each="report : ${incidentReports}"
                    th:onclick="'viewReportDetail(' + ${report.reportId} + ')'">
                    <div class="report-card-header-guest">
                        <div class="report-card-id-guest" th:text="'#BC' + ${report.reportId}">#BC001</div>
                        <span class="priority-badge-guest" th:classappend="${report.level.name() == 'CAO' ? 'priority-high-guest' :
                       report.level.name() == 'TRUNG_BINH' ? 'priority-medium-guest' : 
                       'priority-low-guest'}" th:text="${report.level.name() == 'CAO' ? 'Cao' :
                report.level.name() == 'TRUNG_BINH' ? 'Trung bình' : 'Thấp'}">
                        </span>
                    </div>
                    <div class="report-card-body-guest">
                        <div class="report-card-title-guest" th:text="${report.incidentType}">
                            Điều hòa không hoạt động</div>
                        <div class="report-card-description-guest" th:text="${report.description}">
                            Điều hòa không thể bật</div>
                        <div class="report-card-info-guest">
                            <div class="report-card-info-item-guest">
                                <div class="report-card-info-label-guest">Ngày báo cáo</div>
                                <div class="report-card-info-value-guest"
                                    th:text="${#dates.format(report.reportedAt, 'dd/MM/yyyy')}">16/12/2024</div>
                            </div>
                            <div class="report-card-info-item-guest">
                                <div class="report-card-info-label-guest">Trạng thái</div>
                                <div class="report-card-info-value-guest">
                                    <span class="status-badge-guest" th:classappend="${report.status.name() == 'CHUA_XU_LY' ? 'status-pending-guest' :
                       report.status.name() == 'DANG_XU_LY' ? 'status-processing-guest' : 
                       'status-resolved-guest'}" th:text="${report.status.name() == 'CHUA_XU_LY' ? 'Chưa xử lý' :
                report.status.name() == 'DANG_XU_LY' ? 'Đang xử lý' : 'Đã giải quyết'}">
                                    </span>

                                </div>
                            </div>
                            <div class="report-card-actions-guest mt-2 d-flex gap-2 justify-content-center">
                                <a th:href="@{/khach-thue/chitiet-phongthue/{cid}(cid=${contract.contractId}, editId=${report.reportId})}"
                                    class="btn-edit-icon text-decoration-none" title="Chỉnh sửa báo cáo">
                                    <i class="fa-solid fa-pen-to-square"></i> Sửa
                                </a>
                                <button type="button" class="btn-delete-icon"
                                    th:onclick="'confirmDeleteReport(' + ${report.reportId} + ',' + ${contract.contractId} + ')'">
                                    <i class="fa-solid fa-trash-can"></i> Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Detail Modal -->
        <div class="modal-overlay-guest" id="contractDetailModal">
            <div class="modal-container-guest contract-modal-container-guest">
                <div class="modal-header-guest">
                    <h3 class="modal-title-guest">
                        <i class="fas fa-file-contract"></i>
                        Hợp đồng thuê nhà trọ
                    </h3>
                    <button class="modal-close-guest" onclick="closeContractDetailModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body-guest contract-modal-body-guest">
                    <div class="contract-full-content-guest">
                        <div class="contract-detail-header-guest">
                            <div class="contract-id-badge-guest">
                                <i class="fas fa-file-alt"></i>
                                <span th:text="'Mã hợp đồng: #CT' + ${contract.contractId}">#CT001</span>
                            </div>
                            <div class="contract-actions-header-guest">
                                <button class="contract-action-btn-guest" onclick="downloadContractAsPDF()">
                                    <i class="fas fa-download"></i>
                                    Tải file hợp đồng
                                </button>
                                <button class="contract-action-btn-guest" onclick="printContract()">
                                    <i class="fas fa-print"></i>
                                    In
                                </button>
                            </div>
                        </div>

                        <div class="contract-section-blue-guest">
                            <h4 class="contract-section-title-blue-guest">
                                <i class="fas fa-info-circle"></i>
                                Thông tin tổng quan
                            </h4>
                            <div class="contract-general-info-guest">
                                <div class="contract-date-item-guest">
                                    <span class="contract-date-label-guest">Ngày ký hợp đồng</span>
                                    <div class="contract-date-value-guest">
                                        <i class="fas fa-calendar"></i>
                                        <span th:text="${#dates.format(contract.startDate, 'dd/MM/yyyy')}">
                                            2024-05-01</span>
                                    </div>
                                </div>
                                <div class="contract-date-item-guest">
                                    <span class="contract-date-label-guest">Ngày hết hạn</span>
                                    <div class="contract-date-value-guest">
                                        <i class="fas fa-calendar"></i>
                                        <span th:text="${#dates.format(contract.endDate, 'dd/MM/yyyy')}">
                                            2024-12-31</span>
                                    </div>
                                </div>
                                <div class="contract-date-item-guest">
                                    <span class="contract-date-label-guest">Thời hạn hợp đồng</span>
                                    <div class="contract-duration-value-guest"
                                        th:text="${contract.duration} + ' tháng'">12 tháng</div>
                                </div>
                            </div>
                        </div>

                        <div class="contract-section-guest">
                            <h4 class="contract-section-title-guest">
                                <i class="fas fa-home"></i>
                                Thông tin phòng trọ
                            </h4>
                            <div class="contract-property-info-guest">
                                <div class="contract-property-row-guest">
                                    <div class="contract-property-item-guest">
                                        <span class="contract-property-label-guest">Địa chỉ</span>
                                        <span class="contract-property-value-guest" th:text="${contract.room.hostel.address != null ? 
      contract.room.hostel.address.street + ', ' + 
      contract.room.hostel.address.ward.name + ', ' +
      contract.room.hostel.address.ward.district.name + ', ' +
      contract.room.hostel.address.ward.district.province.name 
      : 'Chưa xác định'}">
                                        </span>
                                    </div>
                                    <div class="contract-property-item-guest">
                                        <span class="contract-property-label-guest">Diện tích</span>
                                        <span class="contract-property-value-guest"
                                            th:text="${contract.room.acreage} + ' m²'">25 m²</span>
                                    </div>
                                </div>

                                <div class="contract-property-utilities-guest">
                                    <span class="contract-property-label-guest">Tiện ích có sẵn phòng</span>
                                    <p th:if="${utilities == null or #sets.isEmpty(utilities)}" class="text-muted">
                                        Phòng này hiện không có tiện ích nào.
                                    </p>
                                    <ul th:unless="${utilities == null or #sets.isEmpty(utilities)}"
                                        class="contract-utilities-list-guest">
                                        <li class="contract-utility-item-guest" th:each="utility : ${utilities}">
                                            <i class="fas fa-check-circle"></i>
                                            <span
                                                th:text="${utility.name != null ? utility.name : 'Tiện ích không xác định'}">WiFi
                                                miễn phí</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="contract-section-guest">
                            <h4 class="contract-section-title-guest">
                                <i class="fas fa-dollar-sign"></i>
                                Điều khoản tài chính
                            </h4>
                            <div class="contract-financial-grid-guest">
                                <div class="contract-financial-card-guest contract-rental-card-guest">
                                    <div class="contract-financial-label-guest">Tiền thuê hàng tháng</div>
                                    <div class="contract-financial-amount-guest"
                                        th:text="${#numbers.formatInteger(contract.price, 0, 'COMMA')} + ' VNĐ'">
                                        8,000,000 VNĐ</div>
                                    <div class="contract-financial-note-guest">Thanh toán vào ngày 1 hàng tháng</div>
                                </div>
                                <div class="contract-financial-card-guest contract-deposit-card-guest">
                                    <div class="contract-financial-label-guest">Tiền cọc đặt cọc</div>
                                    <div class="contract-financial-amount-guest"
                                        th:text="${#numbers.formatInteger(contract.deposit, 0, 'COMMA')} + ' VNĐ'">
                                        16,000,000 VNĐ</div>
                                    <div class="contract-financial-note-guest">Hoàn trả khi kết thúc hợp đồng</div>
                                </div>
                            </div>
                        </div>

                        <div class="contract-parties-section-guest">
                            <div class="contract-party-card-guest">
                                <h4 class="contract-party-title-guest">
                                    <i class="fas fa-user-tie"></i>
                                    Thông tin chủ nhà (Bên cho thuê)
                                </h4>
                                <div class="contract-party-details-guest">
                                    <div class="contract-party-field-guest">
                                        <span class="contract-party-label-guest">Họ tên</span>
                                        <span class="contract-party-value-guest" th:text="${contract.owner.fullname}">
                                            Chị Nguyễn Thị Mai</span>
                                    </div>
                                    <div class="contract-party-field-guest">
                                        <span class="contract-party-label-guest">Số điện thoại</span>
                                        <span class="contract-party-value-guest">
                                            <i class="fas fa-phone"></i>
                                            <span th:text="${contract.owner.phone}">0901234567</span>
                                        </span>
                                    </div>
                                    <div class="contract-party-field-guest">
                                        <span class="contract-party-label-guest">Email</span>
                                        <span class="contract-party-value-guest">
                                            <i class="fas fa-envelope"></i>
                                            <span th:text="${contract.owner.email}">mai.nguyen@gmail.com</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="contract-party-card-guest">
                                <h4 class="contract-party-title-guest">
                                    <i class="fas fa-user"></i>
                                    Thông tin người thuê (Bên thuê)
                                </h4>
                                <div class="contract-party-details-guest">
                                    <div class="contract-party-field-guest">
                                        <span class="contract-party-label-guest">Họ tên</span>
                                        <span class="contract-party-value-guest" th:text="${contract.tenant.fullname}">
                                            Anh Trần Văn Nam</span>
                                    </div>
                                    <div class="contract-party-field-guest">
                                        <span class="contract-party-label-guest">Số điện thoại</span>
                                        <span class="contract-party-value-guest">
                                            <i class="fas fa-phone"></i>
                                            <span th:text="${contract.tenant.phone}">0987654321</span>
                                        </span>
                                    </div>
                                    <div class="contract-party-field-guest">
                                        <span class="contract-party-label-guest">Email</span>
                                        <span class="contract-party-value-guest">
                                            <i class="fas fa-envelope"></i>
                                            <span th:text="${contract.tenant.email}">nam.tran@gmail.com</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="contract-section-guest p-3 rounded shadow-sm" style="background-color: #f9f9f9;">
                            <h4 class="contract-section-title-guest mb-3" style="font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-list-ul me-2 text-primary"></i> Điều khoản và điều kiện
                            </h4>
                            <pre class="contract-terms-box" th:text="${contract.terms}">Không có điều khoản</pre>
                        </div>
                        <div class="contract-signature-section-guest">
                            <div class="contract-signature-card-guest">
                                <h5 class="contract-signature-title-guest">CHỮ KÝ BÊN CHO THUÊ</h5>
                                <div class="contract-signature-date-guest"
                                    th:text="'Ngày ký: ' + ${#dates.format(contract.startDate, 'dd/MM/yyyy')}">
                                    Ngày ký: 2024-05-01</div>
                                <div class="contract-signature-name-guest" th:text="${contract.owner.fullname}">
                                    Chị Nguyễn Thị Mai</div>
                                <div class="contract-signature-area-guest">
                                    <div class="contract-signature-placeholder-guest">
                                        (Chữ ký)
                                    </div>
                                </div>
                            </div>

                            <div class="contract-signature-card-guest">
                                <h5 class="contract-signature-title-guest">CHỮ KÝ BÊN THUÊ</h5>
                                <div class="contract-signature-date-guest"
                                    th:text="'Ngày ký: ' + ${#dates.format(contract.startDate, 'dd/MM/yyyy')}">
                                    Ngày ký: 2024-05-01</div>
                                <div class="contract-signature-name-guest" th:text="${contract.tenant.fullname}">
                                    Anh Trần Văn Nam</div>
                                <div class="contract-signature-area-guest">
                                    <div class="contract-signature-placeholder-guest">
                                        (Chữ ký)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="contract-footer-note-guest">
                            <p>Hợp đồng này được lập thành 02 bản có giá trị pháp lý như nhau, mỗi bên giữ 01 bản.</p>
                            <p th:text="'Ngày lập: ' + ${#dates.format(contract.startDate, 'dd/MM/yyyy')}">
                                Ngày lập: 01/05/2024</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer-guest">
                    <button class="modal-btn-guest modal-btn-secondary-guest" onclick="closeContractDetailModal()">
                        <i class="fas fa-times"></i>
                        Đóng
                    </button>
                    <button class="contract-action-btn-guest" onclick="downloadContractAsPDF()">
                        <i class="fas fa-download"></i>
                        Tải xuống PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Detail Modal -->
        <div class="modal-overlay-guest" id="reportDetailModal">
            <div class="modal-container-guest">
                <div class="modal-header-guest">
                    <h3 class="modal-title-guest" id="reportDetailTitle">
                        <i class="fas fa-info-circle"></i>
                        Chi tiết báo cáo
                    </h3>
                    <button class="modal-close-guest" onclick="closeReportDetailModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body-guest" id="reportDetailContent">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <div class="modal-footer-guest" id="reportDetailFooter">
                    <!-- Footer will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Create/Edit Report Modal -->
        <div class="modal-overlay-guest" id="reportModal">
            <div class="modal-container-guest">
                <div class="modal-header-guest">
                    <h3 class="modal-title-guest">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span th:text="${editReport != null} ? 'Chỉnh Sửa Báo Cáo' : 'Báo Cáo Sự Cố'">Báo Cáo Sự
                            Cố</span>
                    </h3>
                    <button class="modal-close-guest" onclick="closeReportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body-guest">
                    <form id="reportForm" method="post" enctype="multipart/form-data"
                        th:action="${editReport != null} ? @{/khach-thue/cap-nhat-bao-cao} : @{/khach-thue/bao-cao}">
                        <input type="hidden" name="contractId" th:value="${contract.contractId}" />
                        <input type="hidden" name="roomId" th:value="${contract.room.roomId}" />
                        <input type="hidden" name="reportId" th:if="${editReport != null}"
                            th:value="${editReport.reportId}" />
                        <div class="form-group-guest">
                            <label><i class="fas fa-heading"></i> Tiêu đề sự cố</label>
                            <input type="text" name="incidentType" class="form-input-guest" required
                                placeholder="Nhập tiêu đề ngắn gọn..."
                                th:value="${editReport != null} ? ${editReport.incidentType} : ''" />
                        </div>
                        <div class="form-group-guest">
                            <label><i class="fas fa-flag"></i> Mức độ ưu tiên</label>
                            <select name="level" class="form-select-guest" required>
                                <option value="">Chọn mức độ ưu tiên</option>
                                <option value="THAP" th:selected="${editReport?.level?.name() == 'THAP'}">Thấp</option>
                                <option value="TRUNG_BINH" th:selected="${editReport?.level?.name() == 'TRUNG_BINH'}">
                                    Trung bình</option>
                                <option value="CAO" th:selected="${editReport?.level?.name() == 'CAO'}">Cao</option>
                            </select>
                        </div>
                        <div class="form-group-guest">
                            <label><i class="fas fa-comment-alt"></i> Mô tả chi tiết</label>
                            <textarea name="description" rows="4" class="form-input-guest form-textarea-guest" required
                                placeholder="Mô tả chi tiết về sự cố..."
                                th:text="${editReport != null} ? ${editReport.description} : ''"></textarea>
                        </div>
                        <div class="image-upload-section-guest">
                            <label><i class="fas fa-images"></i> Hình ảnh minh họa (tùy chọn)</label>
                            <div id="imageUploadArea" class="image-upload-area-guest">
                                <input type="file" name="images" id="imageInput" class="form-input-guest"
                                    accept="image/*" multiple hidden>
                                <div class="image-upload-icon-guest">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="image-upload-text-guest">Nhấp để chọn ảnh hoặc kéo thả vào đây</div>
                                <div class="image-upload-hint-guest">Hỗ trợ JPG, PNG, GIF, WEBP (tối đa 5MB mỗi ảnh)
                                </div>
                            </div>
                            <div id="imagePreviewContainer" class="image-preview-container-guest mt-3"></div>
                            <div class="image-preview-container-guest mt-3"
                                th:if="${editReport != null && editReport.images != null}">
                                <div th:each="img : ${editReport.images}" class="image-old-preview-item"
                                    th:id="'img-' + ${img.id}">
                                    <img th:src="@{${img.url}}" alt="Ảnh báo cáo"
                                        style="max-width: 100px; height: auto; margin: 5px; border-radius: 4px;" />

                                    <button type="button" class="btn btn-sm btn-danger mt-2"
                                        th:onclick="'deleteOldImage(' + ${img.id} + ')'">
                                        Xóa ảnh
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer-guest mt-4">
                            <button type="button" class="modal-btn-guest modal-btn-secondary-guest"
                                onclick="closeReportModal()">
                                <i class="fas fa-times"></i> Hủy bỏ
                            </button>
                            <button type="submit" class="modal-btn-guest modal-btn-primary-guest">
                                <i class="fas fa-paper-plane"></i>
                                <span th:text="${editReport != null} ? 'Cập nhật báo cáo' : 'Gửi báo cáo'">Gửi báo
                                    cáo</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script th:if="${showEditModal}" th:inline="javascript">
            window.addEventListener('DOMContentLoaded', function () {
                openReportModal();
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script th:src="@{/js/chitiet-phongthue-guest.js}"></script>
        <script>
            function confirmDeleteReport(reportId, contractId) {
                Swal.fire({
                    title: 'Bạn chắc chắn?',
                    text: 'Báo cáo này sẽ bị xóa khỏi hệ thống!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Xóa',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Tạo form ẩn và gửi đi
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `/khach-thue/xoa-bao-cao/${reportId}`;

                        const contractInput = document.createElement('input');
                        contractInput.type = 'hidden';
                        contractInput.name = 'contractId';
                        contractInput.value = contractId;
                        form.appendChild(contractInput);

                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('.toast-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const toast = btn.closest('.custom-toast');
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    });
                });
                setTimeout(() => {
                    document.querySelectorAll('.custom-toast').forEach(toast => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 300);
                    });
                }, 3000);
            });
        </script>
</body>

</html>