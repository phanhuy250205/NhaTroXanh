<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{/layouts/head}">
    <title>T·∫•t C·∫£ Ph√≤ng Tr·ªç - Nh√† Tr·ªç Xanh</title>
    <link rel="stylesheet" href="/css/favorite-styles.css">
</head>

<body>
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/navbar}"></div>

    <!-- LOGIN MODAL -->
    <div th:replace="~{/layouts/login-modal}"></div>

    <!-- REGISTER MODAL -->
    <div th:replace="~{/layouts/register-modal}"></div>

    <!-- VERIFICATION MODAL -->
    <div th:replace="~{/layouts/verification-modal}"></div>

    <div th:replace="~{/layouts/loc-danhmuc}"></div>

    <div class="container py-4">
        <h5 class="fw-bold">T·∫§T C·∫¢ NH√Ä TR·ªå, PH√íNG TR·ªå GI√Å R·∫∫ M·ªöI NH·∫§T</h5>
        <div class="row">
            <!-- Danh s√°ch nh√† tr·ªç -->
            <div class="col-md-8 danhmuc-nhatro">
                <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                    <p class="m-0 fw-semibold">
                        T·ªïng <span class="text-dark" id="totalPostsCount" th:text="${totalPosts}">0</span> k·∫øt qu·∫£
                    </p>
                    <div class="sort-box d-flex align-items-center">
                        <span class="w-100 text-secondary">S·∫Øp x·∫øp theo</span>
                        <select class="form-select form-select-sm sort-select" id="sortBy" name="sort">
                            <option value="latest" th:selected="${selectedSort == 'latest'}">M·ªõi nh·∫•t</option>
                            <option value="price_asc" th:selected="${selectedSort == 'price_asc'}">Gi√° tƒÉng d·∫ßn</option>
                            <option value="price_desc" th:selected="${selectedSort == 'price_desc'}">Gi√° gi·∫£m d·∫ßn
                            </option>
                        </select>
                    </div>
                </div>
                <div id="debugInfo" class="alert alert-info" style="display: none;"></div>
                <div id="loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                    <p class="mt-2">ƒêang t√¨m ki·∫øm...</p>
                </div>

                <div id="postsContainer">
                    <div class="post-card mb-3 d-flex" th:each="post : ${posts}">
                        <div class="post-img position-relative">
                            <a th:href="@{/chi-tiet/{id}(id=${post.postId})}">
                                <img th:if="${post.images != null and !post.images.isEmpty()}"
                                    th:src="${post.images[0].url}" alt="Ph√≤ng tr·ªç" class="img-fluid"
                                    onerror="this.src='/images/no-image.jpg'" />
                                <img th:unless="${post.images != null and !post.images.isEmpty()}"
                                    src="/images/no-image.jpg" alt="Kh√¥ng c√≥ ·∫£nh" class="img-fluid" />
                            </a>
                            <button class="btn-favorite" th:attr="data-post-id=${post.postId}">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>

                        <div class="post-info ps-3 d-flex flex-column justify-content-between">
                            <div>
                                <h6 class="fw-bold mb-1">
                                    <a th:href="@{/chi-tiet/{id}(id=${post.postId})}"
                                        class="text-dark text-decoration-none hover-text-primary"
                                        th:text="${post.title}">Ti√™u ƒë·ªÅ</a>
                                </h6>

                                <div class="text-muted small mb-1">
                                    <span class="text-dark">T·ª´</span>
                                    <span class="text-danger fw-bold"
                                        th:text="${#numbers.formatDecimal(post.price, 0, 'COMMA', 0, 'POINT') + ' VNƒê'}">
                                        2.5 tri·ªáu
                                    </span>
                                    <span class="text-muted">/th√°ng</span>
                                </div>

                                <div class="d-flex gap-2 mb-2">
                                    <span class="badge bg-light border text-dark small px-2"
                                        th:text="${post.area + 'm¬≤'}">Di·ªán t√≠ch</span>
                                    <span class="badge bg-primary text-white small px-2"
                                        th:text="${post.category.name}">Danh m·ª•c</span>
                                </div>

                                <div class="text-muted small">
                                    <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                    <span th:if="${post.address != null}"
                                        th:text="${post.address.street != null ? post.address.street + ', ' : ''} + 
                                                   ${post.address.ward != null ? post.address.ward.name + ', ' : ''} + 
                                                   ${post.address.ward != null and post.address.ward.district != null ? post.address.ward.district.name + ', ' : ''} + 
                                                   ${post.address.ward != null and post.address.ward.district != null and post.address.ward.district.province != null ? post.address.ward.district.province.name : ''}">
                                    </span>
                                    <span th:unless="${post.address != null}">
                                        ƒê·ªãa ch·ªâ ch∆∞a c·∫≠p nh·∫≠t
                                    </span>
                                </div>

                                <div class="text-muted small mt-1">
                                    <i class="fas fa-clock me-1"></i>
                                    <span th:text="${#dates.format(post.createdAt, 'dd/MM/yyyy')}">Ng√†y ƒëƒÉng</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="noResults" class="text-center py-4" style="display: none;">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h4>
                    <p class="text-muted">Vui l√≤ng th·ª≠ l·∫°i v·ªõi c√°c ti√™u ch√≠ kh√°c</p>
                </div>

                <!-- Pagination -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination links will be dynamically generated by JavaScript -->
                    </ul>
                </nav>
            </div>

            <!-- B·ªô l·ªçc -->
            <div class="col-md-4 danhmuc-boloc">
                <div class="filter-card">
                    <h6 class="filter-title">
                        <i class="fas fa-filter"></i> L·ªçc t√¨m ki·∫øm ph√≤ng
                    </h6>

                    <!-- Area Filter -->
                    <div class="filter-section">
                        <label class="filter-label">Di·ªán t√≠ch</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area_all" value="all" checked>
                            <label class="form-check-label" for="area_all">T·∫•t c·∫£</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area1" value="0-10">
                            <label class="form-check-label" for="area1">D∆∞·ªõi 10m¬≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area2" value="10-20">
                            <label class="form-check-label" for="area2">10 - 20m¬≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area3" value="20-25">
                            <label class="form-check-label" for="area3">20 - 25m¬≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area4" value="25-30">
                            <label class="form-check-label" for="area4">25 - 30m¬≤</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area5" value="30-">
                            <label class="form-check-label" for="area5">Tr√™n 30m¬≤</label>
                        </div>
                    </div>

                    <!-- Utilities Filter -->
                    <div class="filter-section">
                        <label class="filter-label">Ti·ªán √≠ch</label>
                        <div th:each="utility : ${utilities}" class="form-check">
                            <input class="form-check-input" type="checkbox" th:id="'utility_' + ${utility.utilityId}"
                                th:value="${utility.utilityId}" name="utilities">
                            <label class="form-check-label" th:for="'utility_' + ${utility.utilityId}"
                                th:text="${utility.name}">Ti·ªán √≠ch</label>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                        <button class="btn btn-primary" id="filter-btn">T√¨m ngay</button>
                        <button class="btn btn-secondary" id="reset-btn">X√≥a b·ªô l·ªçc</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('‚úÖ DOM Loaded');

            const filterBtn = document.getElementById('filter-btn');
            const resetBtn = document.getElementById('reset-btn');
            const sortSelect = document.getElementById('sortBy');

            // === G√ÅN S·ª∞ KI·ªÜN N√öT L·ªåC ===
            if (filterBtn) {
                filterBtn.addEventListener('click', function () {
                    console.log('üü¢ Filter button clicked');
                    applyFilter();
                });
            } else {
                console.error('‚õî Kh√¥ng t√¨m th·∫•y n√∫t l·ªçc (#filter-btn)');
            }

            // === G√ÅN S·ª∞ KI·ªÜN N√öT RESET ===
            if (resetBtn) {
                resetBtn.addEventListener('click', function () {
                    console.log('üü° Reset button clicked');
                    resetFilter();
                });
            } else {
                console.error('‚õî Kh√¥ng t√¨m th·∫•y n√∫t reset (#reset-btn)');
            }

            // === S·ª∞ KI·ªÜN THAY ƒê·ªîI S·∫ÆP X·∫æP ===
            if (sortSelect) {
                sortSelect.addEventListener('change', function () {
                    console.log('üìä Sort changed to:', this.value);
                    applyFilter(0); // Reset v·ªÅ trang ƒë·∫ßu khi sort
                });
            }

            // === T·ª∞ ƒê·ªòNG L·ªåC KHI THAY ƒê·ªîI INPUT (T·ª™Y CH·ªåN) ===
            // B·ªè comment d√≤ng d∆∞·ªõi n·∫øu mu·ªën t·ª± ƒë·ªông l·ªçc khi thay ƒë·ªïi
            // document.addEventListener('change', function (e) {
            //     if (e.target.matches('input[name="utilities"], input[name="area"]')) {
            //         console.log('üîÑ Filter input changed:', e.target);
            //         applyFilter();
            //     }
            // });

            // === G·ªåI BAN ƒê·∫¶U ===
            console.log('Province Code:', provinceCode);
            console.log('District Code:', districtCode);
            console.log('Ward Code:', wardCode);

            applyFilter();
        });

        function applyFilter(page = 0) {
            console.log('üîç Applying filter for page:', page);

            // Hi·ªÉn th·ªã loading
            showLoading(true);

            // L·∫•y gi√° tr·ªã sort
            const selectedSort = document.getElementById('sortBy')?.value || 'latest';
            const priceRange = document.querySelector('input[name="price"]:checked')?.value || '';

            // L·∫•y gi√° tr·ªã location
            const provinceCode = document.getElementById('provinceSelect')?.value?.trim();
            const districtCode = document.getElementById('districtSelect')?.value?.trim();
            const wardCode = document.getElementById('wardSelect')?.value?.trim();

            // L·∫•y t·ª´ kh√≥a t√¨m ki·∫øm (n·∫øu c√≥)
            const searchTerm = document.getElementById('searchInput')?.value?.trim() || '';

            let minPrice = null;
            let maxPrice = null;
            switch (priceRange) {
                case 'under_1m': maxPrice = 1000000; break;
                case '1_2m': minPrice = 1000000; maxPrice = 2000000; break;
                case '2_3m': minPrice = 2000000; maxPrice = 3000000; break;
                case '3_5m': minPrice = 3000000; maxPrice = 5000000; break;
                case 'over_5m': minPrice = 5000000; break;
            }
            // L·∫•y gi√° tr·ªã di·ªán t√≠ch
            let minArea = null;
            let maxArea = null;
            const areaValue = document.querySelector('input[name="area"]:checked')?.value;
            console.log('Selected area:', areaValue);

            if (areaValue && areaValue !== 'all') {
                const parts = areaValue.split('-');
                if (parts.length === 2) {
                    minArea = parts[0] !== '' ? parseInt(parts[0]) : null;
                    maxArea = parts[1] !== '' ? parseInt(parts[1]) : null;
                }
            }

            // L·∫•y ti·ªán √≠ch ƒë√£ ch·ªçn
            const selectedUtilities = Array.from(document.querySelectorAll('input[name="utilities"]:checked'))
                .map(cb => parseInt(cb.value));

            console.log('Filter params:', {
                page, selectedSort, minArea, maxArea, selectedUtilities,
                provinceCode, districtCode, wardCode, searchTerm
            });

            // T·∫°o URL v·ªõi params
            const url = new URL('/api/filter-all-posts', window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('sort', selectedSort);

            if (minPrice !== null) url.searchParams.append('minPrice', minPrice);
            if (maxPrice !== null) url.searchParams.append('maxPrice', maxPrice);
            if (provinceCode) url.searchParams.append('provinceCode', provinceCode);
            if (districtCode) url.searchParams.append('districtCode', districtCode);
            if (wardCode) url.searchParams.append('wardCode', wardCode);
            if (searchTerm) url.searchParams.append('searchTerm', searchTerm);
            if (minArea !== null) url.searchParams.append('minArea', minArea);
            if (maxArea !== null) url.searchParams.append('maxArea', maxArea);

            // Th√™m utilities v√†o URL
            selectedUtilities.forEach(id => {
                url.searchParams.append('utilities', id);
            });

            console.log('üåê Request URL:', url.toString());

            fetch(url.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ Filter response:', data);
                    showLoading(false);
                    displayPosts(data.content);
                    updatePostCount(data.totalElements);
                    updatePagination(data.number, data.totalPages);
                })
                .catch(error => {
                    console.error('‚ùå L·ªói khi l·ªçc b√†i ƒëƒÉng:', error);
                    showLoading(false);
                    showError('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const postsContainer = document.getElementById('postsContainer');
            const noResults = document.getElementById('noResults');

            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
            if (show) {
                if (postsContainer) postsContainer.style.display = 'none';
                if (noResults) noResults.style.display = 'none';
            }
        }

        function displayPosts(posts) {
            const postsContainer = document.getElementById('postsContainer');
            const noResults = document.getElementById('noResults');

            if (!postsContainer || !noResults) {
                console.error('‚ùå Posts container or no results element not found');
                return;
            }

            if (!posts || posts.length === 0) {
                console.log('üì≠ No posts found');
                postsContainer.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            console.log('üìã Displaying', posts.length, 'posts');
            postsContainer.innerHTML = posts.map(post => createPostCard(post)).join('');
            postsContainer.style.display = 'block';
            noResults.style.display = 'none';
        }

        function createPostCard(post) {
            const imageUrl = post.images && post.images.length > 0
                ? post.images[0].url
                : '/images/no-image.jpg';

            // T·∫°o ƒë·ªãa ch·ªâ an to√†n
            let address = 'ƒê·ªãa ch·ªâ ch∆∞a c·∫≠p nh·∫≠t';
            if (post.address) {
                const parts = [];
                if (post.address.street) parts.push(post.address.street);
                if (post.address.ward?.name) parts.push(post.address.ward.name);
                if (post.address.ward?.district?.name) parts.push(post.address.ward.district.name);
                if (post.address.ward?.district?.province?.name) parts.push(post.address.ward.district.province.name);
                if (parts.length > 0) {
                    address = parts.join(', ');
                }
            }

            const formattedDate = post.createdAt ? new Date(post.createdAt).toLocaleDateString('vi-VN') : '';

            return `
        <div class="post-card mb-3 d-flex">
            <div class="post-img position-relative">
                <a href="/chi-tiet/${post.postId}">
                    <img src="${imageUrl}" alt="Ph√≤ng tr·ªç" class="img-fluid" onerror="this.src='/images/no-image.jpg'" />
                </a>
                <button class="btn-favorite" data-post-id="${post.postId}">
                    <i class="far fa-heart"></i>
                </button>
            </div>
            <div class="post-info ps-3 d-flex flex-column justify-content-between">
                <div>
                    <h6 class="fw-bold mb-1">
                        <a href="/chi-tiet/${post.postId}" class="text-dark text-decoration-none hover-text-primary">
                            ${escapeHtml(post.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ')}
                        </a>
                    </h6>
                    <div class="text-muted small mb-1">
                        <span class="text-dark">T·ª´</span>
                        <span class="text-danger fw-bold">
                            ${formatPrice(post.price)} VNƒê
                        </span>
                        <span class="text-muted">/th√°ng</span>
                    </div>
                    <div class="d-flex gap-2 mb-2">
                        <span class="badge bg-light border text-dark small px-2">${post.area || 0}m¬≤</span>
                        <span class="badge bg-primary text-white small px-2">${escapeHtml(post.category?.name || 'Ch∆∞a ph√¢n lo·∫°i')}</span>
                    </div>
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                        ${escapeHtml(address)}
                    </div>
                    <div class="text-muted small mt-1">
                        <i class="fas fa-clock me-1"></i>
                        ${formattedDate}
                    </div>
                </div>
            </div>
        </div>
    `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        }

        function formatPrice(price) {
            if (!price || price === 0) return '0';
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        function updatePostCount(count) {
            const totalPostsCount = document.getElementById('totalPostsCount');
            if (totalPostsCount) {
                totalPostsCount.textContent = count || 0;
            } else {
                console.error('‚ùå Total posts count element not found');
            }
        }

        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            if (!pagination) {
                console.error('‚ùå Pagination element not found');
                return;
            }

            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return; // Kh√¥ng hi·ªÉn th·ªã pagination n·∫øu ch·ªâ c√≥ 1 trang
            }

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); applyFilter(${currentPage - 1})">Tr∆∞·ªõc</a>`;
            pagination.appendChild(prevLi);

            // Page numbers (hi·ªÉn th·ªã t·ªëi ƒëa 5 trang)
            const startPage = Math.max(0, currentPage - 2);
            const endPage = Math.min(totalPages - 1, currentPage + 2);

            if (startPage > 0) {
                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); applyFilter(0)">1</a>`;
                pagination.appendChild(li);

                if (startPage > 1) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); applyFilter(${i})">${i + 1}</a>`;
                pagination.appendChild(li);
            }

            if (endPage < totalPages - 1) {
                if (endPage < totalPages - 2) {
                    const dots = document.createElement('li');
                    dots.className = 'page-item disabled';
                    dots.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(dots);
                }

                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); applyFilter(${totalPages - 1})">${totalPages}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); applyFilter(${currentPage + 1})">Sau</a>`;
            pagination.appendChild(nextLi);
        }

        function resetFilter() {
            console.log('üîÑ Resetting filters');

            // Reset utilities checkboxes
            const utilities = document.querySelectorAll('input[name="utilities"]');
            utilities.forEach(checkbox => checkbox.checked = false);

            // Reset area radio
            const areaAll = document.getElementById('area_all');
            if (areaAll) areaAll.checked = true;

            // Reset other filters
            const priceRange = document.getElementById('priceRange');
            const province = document.getElementById('province');
            const district = document.getElementById('district');
            const ward = document.getElementById('ward');
            const searchInput = document.getElementById('searchInput');
            const sortBy = document.getElementById('sortBy');

            if (priceRange) priceRange.value = '';
            if (province) province.value = '';
            if (district) {
                district.value = '';
                district.disabled = true;
            }
            if (ward) {
                ward.value = '';
                ward.disabled = true;
            }
            if (searchInput) searchInput.value = '';
            if (sortBy) sortBy.value = 'latest';

            console.log('‚úÖ Filters reset, applying filter');
            applyFilter(0);
        }

        function showError(message) {
            const postsContainer = document.getElementById('postsContainer');
            const debugInfo = document.getElementById('debugInfo');
            const noResults = document.getElementById('noResults');

            if (debugInfo) {
                debugInfo.style.display = 'block';
                debugInfo.className = 'alert alert-danger';
                debugInfo.innerHTML = `‚ùå ${message}`;
            }

            if (postsContainer) postsContainer.style.display = 'none';
            if (noResults) noResults.style.display = 'none';

            console.error('‚ùå Error:', message);
        }

    </script>

    <!-- Include favorite handler -->
    <script src="/js/favorite-handler.js"></script>
</body>

</html>