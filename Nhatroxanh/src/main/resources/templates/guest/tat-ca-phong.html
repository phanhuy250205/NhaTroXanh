<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{/layouts/head}">
    <title>Tất Cả Phòng Trọ - Nhà Trọ Xanh</title>
    <link rel="stylesheet" href="/css/favorite-styles.css">
</head>

<body>
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/navbar}"></div>

    <!-- LOGIN MODAL -->
    <div th:replace="~{/layouts/login-modal}"></div>

    <!-- REGISTER MODAL -->
    <div th:replace="~{/layouts/register-modal}"></div>

    <!-- VERIFICATION MODAL -->
    <div th:replace="~{/layouts/verification-modal}"></div>

    <div th:replace="~{/layouts/loc-danhmuc}"></div>

    <div class="container py-4">
        <h5 class="fw-bold">TẤT CẢ NHÀ TRỌ, PHÒNG TRỌ GIÁ RẺ MỚI NHẤT</h5>
        <div class="row">
            <!-- Danh sách nhà trọ -->
            <div class="col-md-8 danhmuc-nhatro">
                <div class="d-flex justify-content-between align-items-center mb-3 px-1">
                    <p class="m-0 fw-semibold">
                        Tổng <span class="text-dark" id="totalPostsCount" th:text="${totalPosts}">0</span> kết quả
                    </p>
                    <div class="sort-box d-flex align-items-center">
                        <span class="w-100 text-secondary">Sắp xếp theo</span>
                        <select class="form-select form-select-sm sort-select" id="sortBy" name="sort">
                            <option value="latest" th:selected="${selectedSort == 'latest'}">Mới nhất</option>
                            <option value="price_asc" th:selected="${selectedSort == 'price_asc'}">Giá tăng dần</option>
                            <option value="price_desc" th:selected="${selectedSort == 'price_desc'}">Giá giảm dần
                            </option>
                        </select>
                    </div>
                </div>
                <div id="debugInfo" class="alert alert-info" style="display: none;"></div>
                <div id="loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tìm kiếm...</p>
                </div>

                <div id="postsContainer">
                    <div class="post-card mb-3 d-flex" th:each="post : ${posts}">
                        <div class="post-img position-relative">
                            <a th:href="@{/chi-tiet/{id}(id=${post.postId})}">
                                <img th:if="${post.images != null and !post.images.isEmpty()}"
                                    th:src="${post.images[0].url}" alt="Phòng trọ" class="img-fluid"
                                    onerror="this.src='/images/no-image.jpg'" />
                                <img th:unless="${post.images != null and !post.images.isEmpty()}"
                                    src="/images/no-image.jpg" alt="Không có ảnh" class="img-fluid" />
                            </a>
                            <button class="btn-favorite" th:attr="data-post-id=${post.postId}">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>

                        <div class="post-info ps-3 d-flex flex-column justify-content-between">
                            <div>
                                <h6 class="fw-bold mb-1">
                                    <a th:href="@{/chi-tiet/{id}(id=${post.postId})}"
                                        class="text-dark text-decoration-none hover-text-primary"
                                        th:text="${post.title}">Tiêu đề</a>
                                </h6>

                                <div class="text-muted small mb-1">
                                    <span class="text-dark">Từ</span>
                                    <span class="text-danger fw-bold"
                                        th:text="${#numbers.formatDecimal(post.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ'}">
                                        2.5 triệu
                                    </span>
                                    <span class="text-muted">/tháng</span>
                                </div>

                                <div class="d-flex gap-2 mb-2">
                                    <span class="badge bg-light border text-dark small px-2"
                                        th:text="${post.area + 'm²'}">Diện tích</span>
                                    <span class="badge bg-primary text-white small px-2"
                                        th:text="${post.category.name}">Danh mục</span>
                                </div>

                                <div class="text-muted small">
                                    <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                    <span th:if="${post.address != null}"
                                        th:text="${post.address.street != null ? post.address.street + ', ' : ''} + 
                                                   ${post.address.ward != null ? post.address.ward.name + ', ' : ''} + 
                                                   ${post.address.ward != null and post.address.ward.district != null ? post.address.ward.district.name + ', ' : ''} + 
                                                   ${post.address.ward != null and post.address.ward.district != null and post.address.ward.district.province != null ? post.address.ward.district.province.name : ''}">
                                    </span>
                                    <span th:unless="${post.address != null}">
                                        Địa chỉ chưa cập nhật
                                    </span>
                                </div>

                                <div class="text-muted small mt-1">
                                    <i class="fas fa-clock me-1"></i>
                                    <span th:text="${#dates.format(post.createdAt, 'dd/MM/yyyy')}">Ngày đăng</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="noResults" class="text-center py-4" style="display: none;">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4>Không tìm thấy kết quả</h4>
                    <p class="text-muted">Vui lòng thử lại với các tiêu chí khác</p>
                </div>

                <!-- Pagination -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination links will be dynamically generated by JavaScript -->
                    </ul>
                </nav>
            </div>

            <!-- Bộ lọc -->
            <div class="col-md-4 danhmuc-boloc">
                <div class="filter-card">
                    <h6 class="filter-title">
                        <i class="fas fa-filter"></i> Lọc tìm kiếm phòng
                    </h6>

                    <!-- Area Filter -->
                    <div class="filter-section">
                        <label class="filter-label">Diện tích</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area_all" value="all" checked>
                            <label class="form-check-label" for="area_all">Tất cả</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area1" value="0-10">
                            <label class="form-check-label" for="area1">Dưới 10m²</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area2" value="10-20">
                            <label class="form-check-label" for="area2">10 - 20m²</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area3" value="20-25">
                            <label class="form-check-label" for="area3">20 - 25m²</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area4" value="25-30">
                            <label class="form-check-label" for="area4">25 - 30m²</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="area" id="area5" value="30-">
                            <label class="form-check-label" for="area5">Trên 30m²</label>
                        </div>
                    </div>

                    <!-- Utilities Filter -->
                    <div class="filter-section">
                        <label class="filter-label">Tiện ích</label>
                        <div th:each="utility : ${utilities}" class="form-check">
                            <input class="form-check-input" type="checkbox" th:id="'utility_' + ${utility.utilityId}"
                                th:value="${utility.utilityId}" name="utilities">
                            <label class="form-check-label" th:for="'utility_' + ${utility.utilityId}"
                                th:text="${utility.name}">Tiện ích</label>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                        <button class="btn btn-primary" id="filter-btn">Tìm ngay</button>
                        <button class="btn btn-secondary" id="reset-btn">Xóa bộ lọc</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-apply filter when inputs change
        document.addEventListener('change', function (e) {
            if (e.target.matches('input[name="utilities"], input[name="area"], #sortBy')) {
                console.log('Filter input changed:', e.target);
                applyFilter();
            }
        });

        // Manual filter button
        const filterBtn = document.getElementById('filter-btn');
        if (filterBtn) {
            filterBtn.addEventListener('click', function () {
                console.log('Filter button clicked');
                applyFilter();
            });
        } else {
            console.error('Filter button not found');
        }

        // Reset filter button
        const resetBtn = document.getElementById('reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function () {
                console.log('Reset button clicked');
                resetFilter();
            });
        } else {
            console.error('Reset button not found');
        }

        function applyFilter(page = 0) {
            const loading = document.getElementById('loading');
            const postsContainer = document.getElementById('postsContainer');
            const noResults = document.getElementById('noResults');
            const debugInfo = document.getElementById('debugInfo');

            // Null checks for DOM elements
            if (!loading || !postsContainer || !noResults || !debugInfo) {
                console.error('One or more DOM elements not found:', {
                    loading: !!loading,
                    postsContainer: !!postsContainer,
                    noResults: !!noResults,
                    debugInfo: !!debugInfo
                });
                return;
            }

            // Show loading
            loading.style.display = 'block';
            postsContainer.style.display = 'none';
            noResults.style.display = 'none';
            debugInfo.style.display = 'none';

            const selectedUtilities = Array.from(document.querySelectorAll('input[name="utilities"]:checked'))
                .map(checkbox => checkbox.value);

            const selectedArea = document.querySelector('input[name="area"]:checked')?.value;
            let minArea = null;
            let maxArea = null;

            if (selectedArea && selectedArea !== 'all') {
                if (selectedArea.includes('-')) {
                    const parts = selectedArea.split('-');
                    minArea = parts[0] !== '' ? parseFloat(parts[0]) : null;
                    maxArea = parts[1] !== '' ? parseFloat(parts[1]) : null;
                } else if (selectedArea.endsWith('-')) {
                    minArea = parseFloat(selectedArea.replace('-', ''));
                } else if (selectedArea.startsWith('-')) {
                    maxArea = parseFloat(selectedArea.replace('-', ''));
                }
            }

            const sort = document.getElementById('sortBy')?.value || 'latest';

            const params = new URLSearchParams();
            selectedUtilities.forEach(utilityId => {
                params.append('utilities', utilityId);
            });
            if (minArea !== null) params.append('minArea', minArea);
            if (maxArea !== null) params.append('maxArea', maxArea);
            params.append('sort', sort);
            params.append('page', page);

            console.log('Filter request:', {
                selectedUtilities,
                minArea,
                maxArea,
                sort,
                page,
                url: `/api/filter-all-posts?${params.toString()}`
            });

            fetch(`/api/filter-all-posts?${params.toString()}`)
                .then(response => {
                    console.log('API response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (!data || !data.content) {
                        throw new Error('Invalid API response: content missing');
                    }
                    loading.style.display = 'none';
                    displayPosts(data.content);
                    updatePostCount(data.totalElements);
                    updatePagination(data.number, data.totalPages);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    loading.style.display = 'none';
                    debugInfo.style.display = 'block';
                    debugInfo.className = 'alert alert-danger';
                    debugInfo.innerHTML = `Lỗi: ${error.message}`;
                    showError('Có lỗi xảy ra khi tải dữ liệu: ' + error.message);
                });
        }

        function displayPosts(posts) {
            const postsContainer = document.getElementById('postsContainer');
            const noResults = document.getElementById('noResults');

            if (!postsContainer || !noResults) {
                console.error('Posts container or no results element not found');
                return;
            }

            if (!posts || posts.length === 0) {
                postsContainer.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            postsContainer.innerHTML = posts.map(post => createPostCard(post)).join('');
            postsContainer.style.display = 'block';
            noResults.style.display = 'none';
        }

        function createPostCard(post) {
            const imageUrl = post.images && post.images.length > 0
                ? post.images[0].url
                : '/images/no-image.jpg';

            const address = post.address
                ? `${post.address.street || ''}${post.address.street ? ', ' : ''}${post.address.ward?.name || ''}${post.address.ward?.name ? ', ' : ''}${post.address.ward?.district?.name || ''}${post.address.ward?.district?.name ? ', ' : ''}${post.address.ward?.district?.province?.name || ''}`
                : 'Địa chỉ chưa cập nhật';

            const formattedDate = post.createdAt ? new Date(post.createdAt).toLocaleDateString('vi-VN') : '';

            return `
                <div class="post-card mb-3 d-flex">
                    <div class="post-img position-relative">
                        <a href="/chi-tiet/${post.postId}">
                            <img src="${imageUrl}" alt="Phòng trọ" class="img-fluid" onerror="this.src='/images/no-image.jpg'" />
                        </a>
                        <button class="btn-favorite" data-post-id="${post.postId}">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                    <div class="post-info ps-3 d-flex flex-column justify-content-between">
                        <div>
                            <h6 class="fw-bold mb-1">
                                <a href="/chi-tiet/${post.postId}" class="text-dark text-decoration-none hover-text-primary">
                                    ${post.title}
                                </a>
                            </h6>
                            <div class="text-muted small mb-1">
                                <span class="text-dark">Từ</span>
                                <span class="text-danger fw-bold">
                                    ${formatPrice(post.price)} VNĐ
                                </span>
                                <span class="text-muted">/tháng</span>
                            </div>
                            <div class="d-flex gap-2 mb-2">
                                <span class="badge bg-light border text-dark small px-2">${post.area}m²</span>
                                <span class="badge bg-primary text-white small px-2">${post.category?.name || ''}</span>
                            </div>
                            <div class="text-muted small">
                                <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                ${address}
                            </div>
                            <div class="text-muted small mt-1">
                                <i class="fas fa-clock me-1"></i>
                                ${formattedDate}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatPrice(price) {
            if (!price) return '0';
            return new Intl.NumberFormat('vi-VN').format(price);
        }

        function updatePostCount(count) {
            const totalPostsCount = document.getElementById('totalPostsCount');
            if (totalPostsCount) {
                totalPostsCount.textContent = count || 0;
            } else {
                console.error('Total posts count element not found');
            }
        }

        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            if (!pagination) {
                console.error('Pagination element not found');
                return;
            }

            pagination.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="applyFilter(${currentPage - 1})">Trước</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${currentPage === i ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="applyFilter(${i})">${i + 1}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="applyFilter(${currentPage + 1})">Sau</a>`;
            pagination.appendChild(nextLi);
        }

        function resetFilter() {
            const utilities = document.querySelectorAll('input[name="utilities"]');
            const areaAll = document.getElementById('area_all');
            const sortBy = document.getElementById('sortBy');

            if (!utilities || !areaAll || !sortBy) {
                console.error('Filter elements not found for reset');
                return;
            }

            utilities.forEach(checkbox => {
                checkbox.checked = false;
            });
            areaAll.checked = true;
            sortBy.value = 'latest';

            console.log('Filters reset');
            applyFilter();
        }

        function showError(message) {
            const postsContainer = document.getElementById('postsContainer');
            const debugInfo = document.getElementById('debugInfo');
            if (!postsContainer || !debugInfo) {
                console.error('Posts container or debug info element not found');
                return;
            }

            debugInfo.style.display = 'block';
            debugInfo.className = 'alert alert-danger';
            debugInfo.innerHTML = `Lỗi: ${message}`;
            postsContainer.style.display = 'none';
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Page loaded, triggering initial applyFilter');
            applyFilter();
        });
    </script>

    <!-- Include favorite handler -->
    <script src="/js/favorite-handler.js"></script>
</body>

</html>