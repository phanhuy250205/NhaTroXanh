<!DOCTYPE html>
<html lang="en">

<head th:replace="~{/layouts/head}">
    <title>Chi Tiết - Nhà Trọ Xanh</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<style>
    .hidden-review {
        display: none;
    }

    .map-container {
        width: 100%;
        margin-top: 20px;
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #ccc;
    }

    #map {
        width: 100%;
        height: 400px;
        border: none;
    }

    .location-info p {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .location-content h3 {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .form.review-form {
        max-width: 500px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 12px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        font-family: Arial, sans-serif;
    }

    .review-form div {
        margin-bottom: 15px;
    }

    .review-form label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
    }

    .review-form input[type="number"],
    .review-form textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
        resize: vertical;
    }

    .review-form input[type="number"]::-webkit-inner-spin-button {
        height: 30px;
    }

    .review-form button {
        padding: 10px 20px;
        font-size: 14px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .review-form button:hover {
        background-color: #0056b3;
    }

    /* CSS tùy chỉnh cho phần nhận xét (textarea) giống hình */
    .review-form textarea {
        border-radius: 20px;
        /* Bo tròn giống ô nhập liệu trong hình */
        border: 1px solid #e0e0e0;
        /* Viền mỏng và sáng */
        background-color: #fff;
        /* Nền trắng */
        padding: 12px 40px 12px 12px;
        /* Padding bên phải để chứa biểu tượng */
        font-size: 14px;
        height: 50px;
        /* Chiều cao cố định giống hình */
        resize: none;
        /* Ngăn kéo giãn */
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        /* Hiệu ứng bóng nhẹ bên trong */
        position: relative;
    }

    /* Thêm biểu tượng mũi tên bên phải */
    .review-form textarea:after {
        content: "▶";
        /* Biểu tượng mũi tên */
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
        font-size: 16px;
        pointer-events: none;
        /* Ngăn chặn tương tác với biểu tượng */
    }

    /* Hiệu ứng focus */
    .review-form textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }

    /* Đảm bảo textarea không bị che bởi biểu tượng */
    .review-form textarea::-webkit-input-placeholder {
        color: #888;
    }

    .review-form textarea:-moz-placeholder {
        color: #888;
    }

    .review-form textarea::-moz-placeholder {
        color: #888;
    }

    .review-form textarea:-ms-input-placeholder {
        color: #888;
    }

    .star-rating label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
        color: #333;
    }

    #stars {
        display: flex;
        gap: 5px;
        font-size: 28px;
        cursor: pointer;
        color: #ccc;
        transition: color 0.2s;
    }

    .star-rating {
        display: inline-flex;
        font-size: 2rem;
        cursor: pointer;
        gap: 0.25rem;
    }

    .star-rating span {
        color: #ccc;
        transition: color 0.2s;
    }

    .star-rating span.hovered {
        color: orange;
    }

    .star-rating span.selected {
        color: gold;
    }
</style>

<body>
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/navbar}"></div>

    <!-- Breadcrumb -->
    <div class="container mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/danh-muc/{id}(id=${post.category != null ? post.category.categoryId : 0})}"
                        th:text="${post.category != null ? post.category.name : 'Phòng trọ'}">Phòng trọ</a>
                </li>
                <li class="breadcrumb-item active"
                    th:text="${post != null && post.title != null ? post.title : 'Tiêu đề bài đăng'}"></li>
            </ol>
        </nav>
    </div>

    <!-- Property Detail Section -->
    <section class="property-detail-section py-4">
        <div class="container">
            <div class="row">
                <!-- Image Gallery -->
                <div class="col-lg-8 col-md-7">
                    <div class="image-gallery">
                        <div class="main-image-container">
                            <img th:if="${images != null and !#lists.isEmpty(images)}" th:src="${images[0]}"
                                alt="Hình ảnh chính" class="main-image" id="mainImage"
                                onerror="this.src='/images/cards/default.jpg';">
                            <img th:unless="${images != null and !#lists.isEmpty(images)}"
                                src="/images/cards/default.jpg" alt="Hình ảnh chính" class="main-image" id="mainImage">
                            <div class="image-overlay">
                                <button class="btn-favorite-large"><i class="fas fa-heart"></i></button>
                            </div>
                        </div>
                        <!-- Thumbnail Images -->
                        <div class="thumbnail-container">
                            <div class="thumbnail-scroll d-flex" style="overflow-x: auto; white-space: nowrap;">
                                <div th:each="image, iterStat : ${images}"
                                    th:class="${iterStat.first} ? 'thumbnail-item active' : 'thumbnail-item'"
                                    th:data-image="${image}"
                                    onclick="changeMainImage(this.getAttribute('data-image'), this)">
                                    <img th:src="${image}" th:alt="'Hình ' + ${iterStat.count}"
                                        style="width: 80px; height: 60px; object-fit: cover;">
                                </div>
                            </div>
                            <button class="thumbnail-nav prev" onclick="scrollThumbnails('prev')">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="thumbnail-nav next" onclick="scrollThumbnails('next')">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button class="btn-view-all-photos mb-1" onclick="openPhotoModal()">
                            <i class="fas fa-images"></i> Tất cả (<span th:text="${#lists.size(images)}"></span>)
                        </button>
                    </div>
                    <!-- Contact Section -->
                    <div class="contact-section mt-4 p-3 border rounded">
                        <div class="contact-info">
                            <div class="owner-info d-flex align-items-center">
                                <img th:src="@{${owner.avatar != null and !owner.avatar.isEmpty() ? owner.avatar : '/images/avatar-default.png'}}"
                                    alt="Chủ trọ" class="owner-avatar rounded-circle me-3"
                                    style="width: 60px; height: 60px;" onerror="this.src='/images/avatar-default.png';">
                                <div class="owner-details">
                                    <h4 class="owner-name mb-1"
                                        th:text="'Liên hệ: ' +${owner != null ? owner.fullname : 'Chưa có tên'}">Tên chủ trọ</h4>
                                    <p class="owner-role mb-0 text-muted"
                                        th:text="${owner != null && owner.role != null ? owner.role : 'Chủ trọ'}">Chủ
                                        trọ</p>
                                </div>
                            </div>
                        </div>
                        <div class="contact-buttons mt-3" th:attr="data-post-id=${post.postId}">
                            <button class="btn btn-success btn-sm me-2" onclick="fetchContact(event, 'call')">
                                <i class="fas fa-phone"></i>
                                <span class="phone-text">Hiển thị SĐT</span>
                            </button>
                            <button class="btn btn-primary btn-sm me-2" onclick="fetchContact(event, 'sms')">
                                <i class="fas fa-comment"></i> Nhắn tin
                            </button>
                            <button class="btn btn-info btn-sm" onclick="fetchContact(event, 'zalo')">
                                <i class="fab fa-facebook-messenger"></i> Zalo
                            </button>
                            <div class="contact-loading" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <small class="text-muted ms-2">Đang tải...</small>
                            </div>
                        </div>
                        <div class="additional-actions mt-3">
                            <button class="btn btn-outline-secondary me-2" onclick="saveProperty()">
                                <i class="fas fa-bookmark"></i>
                                <span>Lưu tin</span>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" th:attr="data-post-id=${post.postId}"
                                onclick="shareProperty(event)">
                                <i class="fas fa-share-alt"></i>
                                <span>Chia sẻ</span>
                            </button>
                            <button class="btn btn-outline-danger" onclick="reportProperty()">
                                <i class="fas fa-flag"></i>
                                <span>Báo cáo</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property Information -->
                <div class="col-lg-4 col-md-5">
                    <div class="property-info p-3 border rounded">
                        <div class="property-header">
                            <h1 class="property-title h3"
                                th:text="${post != null && post.title != null ? post.title : 'Tiêu đề bài đăng'}">Tiêu
                                đề bài đăng</h1>
                            <div class="property-price">
                                <span class="price-amount"
                                    th:text="${post != null && post.price != null ? #numbers.formatDecimal(post.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ/tháng' : '0 VNĐ/tháng'}">0
                                    VNĐ/tháng</span>
                                <div class="price-note text-muted small">Chưa bao gồm phí dịch vụ</div>
                            </div>
                        </div>
                        <div class="quick-info mt-3">
                            <div class="info-item d-flex align-items-center mb-2">
                                <i class="fas fa-expand-arrows-alt me-2"></i>
                                <span class="info-label me-2 fw-bold">Diện tích:</span>
                                <span class="info-value"
                                    th:text="${post != null && post.area != null ? post.area + 'm²' : '0m²'}">0m²</span>
                            </div>
                            <div class="info-item d-flex align-items-center mb-2">
                                <i class="fas fa-home me-2"></i>
                                <span class="info-label me-2 fw-bold">Loại hình:</span>
                                <span class="info-value"
                                    th:text="${post != null && post.category != null && post.category.name != null ? post.category.name : 'Chưa phân loại'}">Chưa
                                    phân loại</span>
                            </div>
                            <div class="info-item d-flex align-items-start mb-2 mt-1">
                                <i class="fas fa-map-marker-alt me-2 ms-1 mt-1"></i>
                                <span class="info-label me-2 ms-1 fw-bold">Địa chỉ:</span>
                                <div class="info-value">
                                    <span th:if="${post.address != null}"
                                        th:text="${post.address.street != null ? post.address.street + ', ' : ''} + 
                                   ${post.address.ward != null ? post.address.ward.name + ', ' : ''} + 
                                   ${post.address.ward != null and post.address.ward.district != null ? post.address.ward.district.name + ', ' : ''} + 
                                   ${post.address.ward != null and post.address.ward.district != null and post.address.ward.district.province != null ? post.address.ward.district.province.name : ''}">
                                    </span>
                                    <span th:unless="${post.address != null}">
                                        Địa chỉ chưa cập nhật
                                    </span>
                                </div>
                            </div>
                            <div class="info-item d-flex align-items-center mb-2">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <span class="info-label me-2 fw-bold">Ngày đăng:</span>
                                <span class="info-value "
                                    th:text="${post != null && post.createdAt != null ? #dates.format(post.createdAt, 'dd/MM/yyyy') : '01/01/2024'}">01/01/2024</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Information -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="detail-tabs">
                        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-ct active" id="overview-tab" data-bs-toggle="tab"
                                    data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-info-circle"></i> Tổng quan
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-ct" id="amenities-tab" data-bs-toggle="tab"
                                    data-bs-target="#amenities" type="button" role="tab">
                                    <i class="fas fa-list-check"></i> Tiện nghi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-ct" id="location-tab" data-bs-toggle="tab" data-bs-target="#location"
                                    type="button" role="tab">
                                    <i class="fas fa-map"></i> Vị trí
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="detailTabsContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="overview-content">
                                    <h3>Giới thiệu</h3>
                                    <p
                                        th:utext="${post != null && post.description != null ? #strings.replace(post.description, '\n', '<br/>') : 'Chưa có mô tả'}">
                                        Mô tả bài đăng
                                    </p>

                                </div>
                            </div>

                            <!-- Amenities Tab -->
                            <div class="tab-pane fade" id="amenities" role="tabpanel">
                                <div class="amenities-content p-3">
                                    <h3 class="mb-3">Tiện nghi</h3>
                                    <div class="amenities-grid">
                                        <div class="amenity-category">
                                            <div class="amenity-list">
                                                <!-- Nếu không có tiện ích -->
                                                <p th:if="${utilities == null or #sets.isEmpty(utilities)}"
                                                    class="text-muted">
                                                    Phòng này hiện không có tiện ích nào.
                                                </p>
                                                <!-- Danh sách tiện ích -->
                                                <div th:unless="${utilities == null or #sets.isEmpty(utilities)}">
                                                    <ul class="list-unstyled">
                                                        <li class="amenity-item mb-2" th:each="utility : ${utilities}">
                                                            <i class="fas fa-check-circle text-success me-2"></i>
                                                            <span
                                                                th:text="${utility.name != null ? utility.name : 'Tiện ích không xác định'}"></span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Location Tab -->
                            <div class="tab-pane fade" id="location" role="tabpanel">
                                <div class="location-content p-3">
                                    <h3>Vị trí</h3>
                                    <div class="location-info">
                                        <p>
                                            <strong>Địa chỉ:</strong>
                                            <span th:if="${post != null && post.address != null}"
                                                th:text="|${post.address.street != null ? post.address.street + ', ' : ''}${post.address.ward != null ? post.address.ward.name + ', ' : ''}${post.address.ward != null && post.address.ward.district != null ? post.address.ward.district.name + ', ' : ''}${post.address.ward != null && post.address.ward.district != null && post.address.ward.district.province != null ? post.address.ward.district.province.name : ''}|">
                                            </span>
                                            <span th:unless="${post != null && post.address != null}">
                                                Địa chỉ chưa cập nhật
                                            </span>
                                        </p>
                                        <div class="map-container">
                                            <div id="map"
                                                style="height: 400px; background-color: #f8f9fa; border: 1px solid #dee2e6; display: flex; align-items: center; justify-content: center;">
                                                <span class="text-muted">Bản đồ sẽ hiển thị tại đây</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Properties -->
            <div class="row mt-5">
                <div class="col-12">
                    <h3 class="section-title mb-4">Nhà trọ tương tự</h3>
                    <div class="similar-properties">
                        <div class="row">
                            <p th:if="${similarPosts == null or #lists.isEmpty(similarPosts)}" class="text-muted">Không
                                có bài đăng tương tự</p>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4" th:each="similarPost : ${similarPosts}">
                                <div class="card property-card h-100">
                                    <div class="card-image-container position-relative">
                                        <img th:if="${similarPost.images != null and !#lists.isEmpty(similarPost.images)}"
                                            th:src="@{${similarPost.images[0].url}}" alt="Hình ảnh nhà trọ"
                                            class="card-img-top" style="height: 200px; object-fit: cover;">
                                        <img th:unless="${similarPost.images != null and !#lists.isEmpty(similarPost.images)}"
                                            src="/images/cards/default.jpg" alt="Hình ảnh nhà trọ" class="card-img-top"
                                            style="height: 200px; object-fit: cover;">
                                        <div class="card-overlay">
                                            <button class="btn-favorite">
                                                <i class="far fa-heart"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <h5 class="property-title"
                                            th:text="${similarPost != null && similarPost.title != null ? similarPost.title : 'Không có tiêu đề'}">
                                            Tiêu đề</h5>
                                        <div class="property-price mb-3">
                                            <span class="price-amount"
                                                th:text="${similarPost != null && similarPost.price != null ? #numbers.formatDecimal(similarPost.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ/tháng' : '0 VNĐ'}"></span>
                                        </div>

                                        <div class="property-location mb-3">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span th:if="${similarPost.address != null}"
                                                th:text="${similarPost.address.street != null ? similarPost.address.street + ', ' : ''} + 
            ${similarPost.address.ward != null ? similarPost.address.ward.name + ', ' : ''} + 
            ${similarPost.address.ward != null and similarPost.address.ward.district != null ? similarPost.address.ward.district.name + ', ' : ''} + 
            ${similarPost.address.ward != null and similarPost.address.ward.district != null and similarPost.address.ward.district.province != null ? similarPost.address.ward.district.province.name : ''}">
                                            </span>
                                            <span th:unless="${similarPost.address != null}">
                                                Địa chỉ chưa cập nhật
                                            </span>
                                        </div>
                                        <a th:href="@{'/chi-tiet/' + ${similarPost.postId}}" class="btn btn-view">
                                            <i class="fas fa-eye"></i> Xem chi tiết
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </section>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tất cả hình ảnh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="photo-grid">
                        <img th:each="image : ${images}" th:src="@{${image}}" alt="Hình ảnh phòng trọ">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">
                        <i class="fas fa-share-alt"></i> Chia sẻ bài đăng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="shareError" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="shareErrorMessage"></span>
                    </div>
                    <div class="alert alert-info" id="shareDebug" style="display: none;">
                        <h6>Debug Information:</h6>
                        <pre id="shareDebugContent"></pre>
                    </div>
                    <div class="share-preview mb-3" id="sharePreview" style="display: none;">
                        <div class="row">
                            <div class="col-4">
                                <img id="shareImage" src="/placeholder.svg" alt="Preview" class="img-fluid rounded">
                            </div>
                            <div class="col-8">
                                <h6 id="shareTitle" class="mb-1"></h6>
                                <p id="shareDescription" class="text-muted small mb-1"></p>
                                <span id="sharePrice" class="text-danger fw-bold"></span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3" id="shareUrlSection" style="display: none;">
                        <label for="shareUrl" class="form-label">Liên kết chia sẻ:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareUrl" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyShareUrl()">
                                <i class="fas fa-copy"></i> Sao chép
                            </button>
                        </div>
                    </div>

                    <div class="social-share" id="socialShare" style="display: none;">
                        <h6>Chia sẻ qua:</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary btn-sm" onclick="shareToFacebook()">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </button>
                            <button class="btn btn-success btn-sm" onclick="shareToMessenger()">
                                <i class="fab fa-facebook-messenger"></i> Messenger
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="shareToTelegram()">
                                <i class="fab fa-telegram"></i> Telegram
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="shareViaEmail()">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="text-center" id="shareLoading" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tạo liên kết chia sẻ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function changeMainImage(src, element) {
            document.getElementById('mainImage').src = src;
            document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        function scrollThumbnails(direction) {
            const container = document.querySelector('.thumbnail-scroll');
            const scrollAmount = 80; // Match thumbnail width
            const maxScroll = container.scrollWidth - container.clientWidth;

            if (direction === 'prev') {
                container.scrollLeft = Math.max(0, container.scrollLeft - scrollAmount);
            } else {
                container.scrollLeft = Math.min(maxScroll, container.scrollLeft + scrollAmount);
            }
        }

        function openPhotoModal() {
            $('#photoModal').modal('show');
        }

        let contactCache = new Map();

        function fetchContact(event, action) {
            event.preventDefault();
            console.log('fetchContact called with action:', action);

            const button = event.target.closest('button');
            const contactButtons = button.closest('.contact-buttons');
            const postId = contactButtons.getAttribute('data-post-id');
            const loadingDiv = contactButtons.querySelector('.contact-loading');
            const allButtons = contactButtons.querySelectorAll('button');

            console.log('PostId:', postId);

            if (!postId) {
                alert("Không tìm thấy ID bài đăng!");
                return;
            }

            // Check cache first
            if (contactCache.has(postId)) {
                console.log('Using cached data for postId:', postId);
                const cachedData = contactCache.get(postId);
                if (cachedData.success) {
                    executeContactAction(action, cachedData.phoneNumber);
                    return;
                } else {
                    alert(cachedData.message);
                    return;
                }
            }

            // Show loading state
            console.log('Showing loading state...');
            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
            }

            console.log('Making API call to:', `/api/contact/${postId}`);

            fetch(`/api/contact/${postId}`)
                .then(response => {
                    console.log('API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API response data:', data);

                    // Cache the result
                    contactCache.set(postId, data);

                    if (data.success && data.phoneNumber) {
                        updateContactButtons(contactButtons, data);
                        executeContactAction(action, data.phoneNumber);
                        // No alert notification - clean UX
                    } else {
                        alert(data.message || "Không thể lấy thông tin liên hệ");
                    }
                })
                .catch(error => {
                    console.error('Error fetching contact info:', error);
                    alert("❌ Không thể tải thông tin liên hệ. Vui lòng thử lại sau.");
                })
                .finally(() => {
                    console.log('Hiding loading state...');
                    // Hide loading state
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                    allButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                });
        }

        function updateContactButtons(contactButtons, data) {
            const phoneButton = contactButtons.querySelector('button[onclick*="call"]');
            const phoneText = phoneButton.querySelector('.phone-text');

            if (phoneText && data.phoneNumber) {
                phoneText.textContent = data.phoneNumber;
                phoneButton.classList.remove('btn-success');
                phoneButton.classList.add('btn-outline-success');
            }

            // Add owner name if available
            // if (data.ownerName) {
            //     let ownerInfo = contactButtons.querySelector('.owner-info');
            //     if (!ownerInfo) {
            //         ownerInfo = document.createElement('div');
            //         ownerInfo.className = 'owner-info text-muted small mt-1';
            //         contactButtons.appendChild(ownerInfo);
            //     }
            //     // ownerInfo.innerHTML = `<i class="fas fa-user"></i> Liên hệ: ${data.ownerName}`;
            // }
        }

        function executeContactAction(action, phoneNumber) {
            console.log('Executing action:', action, 'with phone:', phoneNumber);

            try {
                switch (action) {
                    case 'call':
                        window.location.href = `tel:${phoneNumber}`;
                        break;

                    case 'sms':
                        window.location.href = `sms:${phoneNumber}`;
                        break;

                    case 'zalo':
                        window.location.href = `zalo://chat?phone=${phoneNumber}`;
                        setTimeout(() => {
                            window.open(`https://zalo.me/${phoneNumber}`, '_blank');
                        }, 1000);
                        break;

                    default:
                        alert("Hành động không được hỗ trợ");
                }
            } catch (error) {
                console.error('Error executing contact action:', error);
                alert("Không thể thực hiện hành động này");
            }
        }

        function saveProperty() {
            alert('Đã lưu tin!');
        }

        let currentShareData = null;

        function shareProperty(event) {
            event.preventDefault();
            const button = event.target.closest('button');
            const postId = button.getAttribute('data-post-id');

            console.log("=== SHARE PROPERTY ===");
            console.log("PostId:", postId);
            console.log("PostId type:", typeof postId);

            if (!postId || postId === 'null' || postId === 'undefined') {
                showShareError("Không tìm thấy ID bài đăng!");
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('shareModal'));
            modal.show();
            hideAllSections();
            showLoading();

            console.log("Making API call to:", `/api/share/${postId}`);

            fetch(`/api/share/${postId}`)
                .then(response => {
                    console.log("API response status:", response.status);
                    console.log("API response headers:", response.headers);

                    if (!response.ok) {
                        return response.json().then(errorData => {
                            console.log("Error response data:", errorData);
                            throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                        }).catch(parseError => {
                            console.log("Failed to parse error response, trying text...");
                            return response.text().then(text => {
                                console.log("Error response text:", text);
                                throw new Error(`HTTP ${response.status}: ${text}`);
                            });
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received share data:", data);

                    if (data.success) {
                        currentShareData = data;
                        displayShareData(data);
                    } else {
                        throw new Error(data.message || "Không thể tạo liên kết chia sẻ");
                    }
                })
                .catch(error => {
                    console.error('Error fetching share URL:', error);
                    showShareError("Không thể tải liên kết chia sẻ: " + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function hideAllSections() {
            document.getElementById('shareError').style.display = 'none';
            document.getElementById('shareDebug').style.display = 'none';
            document.getElementById('sharePreview').style.display = 'none';
            document.getElementById('shareUrlSection').style.display = 'none';
            document.getElementById('socialShare').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('shareLoading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('shareLoading').style.display = 'none';
        }

        function showShareError(message) {
            document.getElementById('shareErrorMessage').textContent = message;
            document.getElementById('shareError').style.display = 'block';
        }

        function showDebugInfo(data) {
            document.getElementById('shareDebugContent').textContent = JSON.stringify(data, null, 2);
            document.getElementById('shareDebug').style.display = 'block';
        }

        function displayShareData(data) {
            document.getElementById('shareUrl').value = data.shareUrl;
            document.getElementById('shareUrlSection').style.display = 'block';
            if (data.title || data.description || data.imageUrl) {
                document.getElementById('shareTitle').textContent = data.title || 'Phòng trọ cho thuê';
                document.getElementById('shareDescription').textContent = data.description || '';
                document.getElementById('sharePrice').textContent = data.price ? data.price + ' VNĐ/tháng' : '';
                document.getElementById('shareImage').src = data.imageUrl || '/images/no-image.jpg';
                document.getElementById('sharePreview').style.display = 'block';
            }
            document.getElementById('socialShare').style.display = 'block';
        }

        function copyShareUrl() {
            const shareUrl = document.getElementById('shareUrl').value;
            if (!shareUrl) {
                showNotification("Chưa có liên kết để sao chép!", 'error');
                return;
            }

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification("Đã sao chép liên kết!", 'success');
                }).catch(error => {
                    console.error('Clipboard error:', error);
                    fallbackCopyText(shareUrl);
                });
            } else {
                fallbackCopyText(shareUrl);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showNotification("Đã sao chép liên kết!", 'success');
            } catch (error) {
                console.error('Fallback copy failed:', error);
                showNotification("Không thể sao chép. Vui lòng sao chép thủ công: " + text, 'error');
            }

            textArea.remove();
        }

        function shareToFacebook() {
            if (!currentShareData) return;
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentShareData.shareUrl)}`;
            window.open(url, '_blank', 'width=600,height=400');
        }
        function shareToMessenger() {
            if (!currentShareData) return;
            const text = `${currentShareData.title}\n${currentShareData.description}\n${currentShareData.shareUrl}`;
            const url = `https://messenger.com/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareToTelegram() {
            if (!currentShareData) return;
            const text = `${currentShareData.title}\n${currentShareData.description}`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(currentShareData.shareUrl)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareViaEmail() {
            if (!currentShareData) return;
            const subject = encodeURIComponent(currentShareData.title);
            const body = encodeURIComponent(`${currentShareData.description}\n\nXem chi tiết tại: ${currentShareData.shareUrl}`);
            const url = `mailto:?subject=${subject}&body=${body}`;
            window.location.href = url;
        }

        function showNotification(message, type = 'info') {
            if (typeof toastr !== 'undefined') {
                toastr[type](message);
            } else {
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
                alert(icon + ' ' + message);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            console.log('Contact buttons JavaScript loaded!');
            const buttons = document.querySelectorAll('.contact-buttons button');
            console.log('Found', buttons.length, 'contact buttons');

            const shareButtons = document.querySelectorAll('[data-post-id]');
            console.log('Found', shareButtons.length, 'share buttons');
            shareButtons.forEach((btn, index) => {
                const postId = btn.getAttribute('data-post-id');
                console.log(`Share button ${index}: postId = ${postId} (type: ${typeof postId})`);
            });
        });
        function reportProperty() {
            alert('Chức năng báo cáo đang được phát triển!');
        }
        let map;
        let geocoder;

        function initMap() {
            const defaultLatLng = { lat: 16.068, lng: 108.212 };
            const address = document.getElementById('address')?.value?.trim();

            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLatLng,
                zoom: 13
            });

            geocoder = new google.maps.Geocoder();

            if (!address) {
                new google.maps.Marker({
                    position: defaultLatLng,
                    map: map,
                    title: "Trung tâm TP. Đà Nẵng"
                });
                return;
            }

            geocoder.geocode({ address: address }, function (results, status) {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    map.setZoom(15);
                    new google.maps.Marker({
                        map: map,
                        position: location,
                        title: address
                    });
                } else {
                    console.warn('Không tìm thấy địa chỉ: ' + status);
                    alert('Không tìm thấy địa chỉ: ' + status);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Gắn sự kiện vào tất cả các tab Bootstrap có thuộc tính data-bs-toggle
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    if (targetId === '#location') {
                        setTimeout(() => {
                            if (!mapLoaded) {
                                loadMap();
                            } else {
                                map.invalidateSize();
                            }
                        }, 300); // Delay nhỏ giúp DOM được cập nhật đầy đủ
                    }
                });
            });
        });
        const stars = document.querySelectorAll('#stars span');
        const ratingInput = document.getElementById('rating');
        let selectedRating = 0;

        stars.forEach((star, idx) => {
            const value = parseInt(star.dataset.value);

            star.addEventListener('click', () => {
                selectedRating = value;
                ratingInput.value = selectedRating;
                highlightStars(selectedRating);
            });

            star.addEventListener('mouseover', () => {
                highlightStars(value);
            });

            star.addEventListener('mouseout', () => {
                highlightStars(selectedRating);
            });
        });

        function highlightStars(rating) {
            stars.forEach((star, idx) => {
                if (idx < rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const hiddenReviews = document.querySelectorAll('.hidden-review');
            let visibleCount = 5;
            const step = 5;

            loadMoreBtn.addEventListener('click', () => {
                const nextHidden = Array.from(hiddenReviews).slice(visibleCount - 5, visibleCount + step);
                nextHidden.forEach(item => item.classList.remove('hidden-review'));
                visibleCount += step;

                // Ẩn nút nếu không còn đánh giá nào bị ẩn
                if (visibleCount >= hiddenReviews.length + 5) {
                    loadMoreBtn.style.display = 'none';
                }
            });

            if (hiddenReviews.length === 0) {
                loadMoreBtn.style.display = 'none';
            }
        });
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAW7YMulhdUYW1RwiUNjijM3Mv222fLrWc&callback=initMap">
        </script>
</body>

</html>