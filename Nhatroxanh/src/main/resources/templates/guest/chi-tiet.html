<!DOCTYPE html>
<html lang="en">

<head th:replace="~{/layouts/head}">
    <title>Chi Tiết - Nhà Trọ Xanh</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        :root {
            --primary-blue: #3E83CC;
            --secondary-blue: #549eed;
            --dark-blue: #1f2937;
            --light-blue: #f0f8ff;
            --accent-blue: #2563eb;
            --gradient-primary: linear-gradient(135deg, #3E83CC 0%, #549eed 100%);
            --shadow-primary: 0 2px 8px rgba(62, 131, 204, 0.15);
            --shadow-hover: 0 3px 12px rgba(62, 131, 204, 0.2);
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --danger-red: #ef4444;
            --text-muted: #6b7280;
        }

        .property-detail-section {
            background-color: #f8f9fa;
        }

        .image-gallery .main-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }

        .image-overlay .btn-favorite-large {
            background: rgba(255, 255, 255, 0.8);
            border: none;
        }

        .thumbnail-item.active img {
            border: 2px solid var(--primary-blue);
            border-radius: 6px;
        }

        .thumbnail-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 5px 10px;
            z-index: 10;
        }

        .thumbnail-nav.prev {
            left: 0;
        }

        .thumbnail-nav.next {
            right: 0;
        }

        .contact-section {
            background: #fff;
            box-shadow: var(--shadow-primary);
            border-radius: 12px;
        }

        .property-info {
            background: #fff;
            box-shadow: var(--shadow-primary);
            border-radius: 12px;
        }

        .property-title {
            color: var(--dark-blue);
            font-weight: 600;
        }

        .price-amount {
            font-size: 1.5rem;
            color: var(--accent-blue);
            font-weight: bold;
        }

        .info-item i {
            color: var(--primary-blue);
        }

        .room-list-section .section-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .room-card {
            background: #fff;
            border: 1px solid rgba(62, 131, 204, 0.1);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .room-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-5px);
        }

        .room-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-blue);
        }

        .room-details {
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .room-details span {
            margin-right: 10px;
        }

        .view-detail-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .view-detail-btn:hover {
            background: linear-gradient(135deg, #2a6ab5 0%, #6ba6f0 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .detail-tabs .nav-link {
            color: var(--dark-blue);
        }

        .detail-tabs .nav-link.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary-blue);
        }

        .location-content .map-container {
            width: 100%;
            margin-top: 20px;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-primary);
            border: 1px solid #ccc;
        }

        #map {
            width: 100%;
            height: 400px;
            border: none;
        }

        .similar-properties .property-card {
            border: 1px solid rgba(62, 131, 204, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .property-card .card-image-container {
            position: relative;
        }

        .property-card .card-overlay .btn-favorite {
            background: rgba(255, 255, 255, 0.8);
            border: none;
        }

        #photoModal .photo-grid img {
            border-radius: 12px;
            box-shadow: var(--shadow-primary);
        }

        #shareModal .modal-content {
            border-radius: 12px;
        }

        #roomDetailModal .modal-content {
            border-radius: 12px;
            box-shadow: var(--shadow-primary);
        }

        #roomDetailModal .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        #roomDetailModal .modal-image {
            width: 100%;
            max-width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: var(--shadow-primary);
        }

        #roomDetailModal .modal-info strong {
            color: var(--accent-blue);
            width: 120px;
            display: inline-block;
            font-weight: 600;
        }

        #roomDetailModal .modal-info ul li {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #roomDetailModal .modal-footer {
            border-top: 1px solid rgba(62, 131, 204, 0.1);
        }

        @media (max-width: 768px) {
            .room-card {
                padding: 10px;
            }

            .room-title {
                font-size: 16px;
            }

            .view-detail-btn {
                padding: 6px 12px;
                font-size: 13px;
            }

            #roomDetailModal .modal-body {
                flex-direction: column;
            }

            #roomDetailModal .modal-image {
                max-width: 100%;
                height: 250px;
            }
        }

        @media (max-width: 576px) {
            .room-details {
                flex-direction: column;
                gap: 5px;
            }

            #roomDetailModal .modal-info p {
                font-size: 14px;
            }
        }

        .room-box {
            transition: transform 0.2s ease;
        }

        .room-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .room-img img {
            object-fit: cover;
        }

        .text-gradient {
            background: linear-gradient(to right, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Ảnh trong carousel lớn (trái) */
        #roomImageCarousel .carousel-item img {
            width: 100%;
            max-height: 350px;
            height: 350px;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Ảnh thumbnail nhỏ bên dưới */
        #roomThumbnails img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        /* Khi ảnh thumbnail được chọn */
        #roomThumbnails img.active {
            border-color: #007bff;
        }

        #roomThumbnails img:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease-in-out;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/navbar}"></div>

    <!-- LOGIN MODAL -->
    <div th:replace="~{/layouts/login-modal}"></div>

    <!-- REGISTER MODAL -->
    <div th:replace="~{/layouts/register-modal}"></div>

    <!-- VERIFICATION MODAL -->
    <div th:replace="~{/layouts/verification-modal}"></div>

    <!-- Breadcrumb -->
    <div class="container mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/danh-muc/{id}(id=${post.category != null ? post.category.categoryId : 0})}"
                        th:text="${post.category != null ? post.category.name : 'Phòng trọ'}">Phòng trọ</a>
                </li>
                <li class="breadcrumb-item active"
                    th:text="${post != null && post.title != null ? post.title : 'Tiêu đề bài đăng'}"></li>
            </ol>
        </nav>
    </div>

    <!-- Property Detail Section -->
    <section class="property-detail-section py-4">
        <div class="container">
            <div class="row">
                <!-- Image Gallery -->
                <div class="col-lg-8 col-md-7">
                    <div class="image-gallery">
                        <div class="main-image-container">
                            <img th:if="${images != null and !#lists.isEmpty(images)}" th:src="${images[0]}"
                                alt="Hình ảnh chính" class="main-image" id="mainImage"
                                onerror="this.src='/images/cards/default.jpg';">
                            <img th:unless="${images != null and !#lists.isEmpty(images)}"
                                src="/images/cards/default.jpg" alt="Hình ảnh chính" class="main-image" id="mainImage">
                            <div class="image-overlay">
                                <button class="btn-favorite-large"><i class="fas fa-heart"></i></button>
                            </div>
                        </div>
                        <!-- Thumbnail Images -->
                        <div class="thumbnail-container">
                            <div class="thumbnail-scroll d-flex" style="overflow-x: auto; white-space: nowrap;">
                                <div th:each="image, iterStat : ${images}"
                                    th:class="${iterStat.first} ? 'thumbnail-item active' : 'thumbnail-item'"
                                    th:data-image="${image}"
                                    onclick="changeMainImage(this.getAttribute('data-image'), this)">
                                    <img th:src="${image}" th:alt="'Hình ' + ${iterStat.count}"
                                        style="width: 80px; height: 60px; object-fit: cover;">
                                </div>
                            </div>
                            <button class="thumbnail-nav prev" onclick="scrollThumbnails('prev')">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="thumbnail-nav next" onclick="scrollThumbnails('next')">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <button class="btn-view-all-photos mb-1" onclick="openPhotoModal()">
                            <i class="fas fa-images"></i> Tất cả (<span th:text="${#lists.size(images)}"></span>)
                        </button>
                    </div>
                    <!-- Contact Section -->
                    <div class="contact-section mt-4 p-3 border rounded">
                        <div class="contact-info">
                            <div class="owner-info d-flex align-items-center">
                                <img th:src="@{${owner.avatar != null and !owner.avatar.isEmpty() ? owner.avatar : '/images/avatar-default.png'}}"
                                    alt="Chủ trọ" class="owner-avatar rounded-circle me-3"
                                    style="width: 60px; height: 60px;" onerror="this.src='/images/avatar-default.png';">
                                <div class="owner-details">
                                    <h4 class="owner-name mb-1"
                                        th:text="'Liên hệ: ' +${owner != null ? owner.fullname : 'Chưa có tên'}">Tên chủ
                                        trọ</h4>
                                    <p class="owner-role mb-0 text-muted" th:switch="${owner.role.name()}">
                                        <span th:case="'owner'">Chủ trọ</span>
                                        <span th:case="'admin'">Quản trị viên</span>
                                        <span th:case="'staff'">Nhân viên</span>
                                        <span th:case="'customer'">Khách thuê</span>
                                        <span th:case="*">Không xác định</span>
                                    </p>

                                </div>
                            </div>
                        </div>
                        <div class="contact-buttons mt-3" th:attr="data-post-id=${post.postId}">
                            <button class="btn btn-success btn-sm me-2" onclick="fetchContact(event, 'call')">
                                <i class="fas fa-phone"></i>
                                <span class="phone-text">Hiển thị SĐT</span>
                            </button>
                            <button class="btn btn-primary btn-sm me-2" onclick="fetchContact(event, 'sms')">
                                <i class="fas fa-comment"></i> Nhắn tin
                            </button>
                            <button class="btn btn-info btn-sm" onclick="fetchContact(event, 'zalo')">
                                <i class="fab fa-facebook-messenger"></i> Zalo
                            </button>
                            <div class="contact-loading" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <small class="text-muted ms-2">Đang tải...</small>
                            </div>
                        </div>
                        <div class="additional-actions mt-3">
                            <button class="btn btn-outline-secondary me-2" onclick="saveProperty()">
                                <i class="fas fa-bookmark"></i>
                                <span>Lưu tin</span>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" th:attr="data-post-id=${post.postId}"
                                onclick="shareProperty(event)">
                                <i class="fas fa-share-alt"></i>
                                <span>Chia sẻ</span>
                            </button>
                            <button class="btn btn-outline-danger" onclick="reportProperty()">
                                <i class="fas fa-flag"></i>
                                <span>Báo cáo</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property Information -->
                <div class="col-lg-4 col-md-5">
                    <div class="property-info p-3 border rounded">
                        <div class="property-header">
                            <h1 class="property-title h3"
                                th:text="${post != null && post.title != null ? post.title : 'Tiêu đề bài đăng'}">Tiêu
                                đề bài đăng</h1>
                            <div class="property-price">
                                <span class="price-amount"
                                    th:text="${post != null && post.price != null ? #numbers.formatDecimal(post.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ/tháng' : '0 VNĐ/tháng'}">0
                                    VNĐ/tháng</span>
                                <div class="price-note text-muted small">Chưa bao gồm phí dịch vụ</div>
                            </div>
                        </div>
                        <div class="quick-info mt-3">
                            <div class="info-item d-flex align-items-center mb-2">
                                <i class="fas fa-expand-arrows-alt me-2"></i>
                                <span class="info-label me-2 fw-bold">Diện tích:</span>
                                <span class="info-value"
                                    th:text="${post != null && post.area != null ? post.area + 'm²' : '0m²'}">0m²</span>
                            </div>
                            <div class="info-item d-flex align-items-center mb-2">
                                <i class="fas fa-home me-2"></i>
                                <span class="info-label me-2 fw-bold">Loại hình:</span>
                                <span class="info-value"
                                    th:text="${post != null && post.category != null && post.category.name != null ? post.category.name : 'Chưa phân loại'}">Chưa
                                    phân loại</span>
                            </div>
                            <div class="info-item d-flex align-items-start mb-2 mt-1">
                                <i class="fas fa-map-marker-alt me-2 ms-1 mt-1"></i>
                                <span class="info-label me-2 ms-1 fw-bold">Địa chỉ:</span>
                                <div class="info-value">
                                    <span th:if="${post.address != null}"
                                        th:text="${post.address.street != null ? post.address.street + ', ' : ''} + 
                                       ${post.address.ward != null ? post.address.ward.name + ', ' : ''} + 
                                       ${post.address.ward != null and post.address.ward.district != null ? post.address.ward.district.name + ', ' : ''} + 
                                       ${post.address.ward != null and post.address.ward.district != null and post.address.ward.district.province != null ? post.address.ward.district.province.name : ''}">
                                    </span>
                                    <span th:unless="${post.address != null}">
                                        Địa chỉ chưa cập nhật
                                    </span>
                                </div>
                            </div>
                            <div class="info-item d-flex align-items-center mb-2">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <span class="info-label me-2 fw-bold">Ngày đăng:</span>
                                <span class="info-value"
                                    th:text="${post != null && post.createdAt != null ? #dates.format(post.createdAt, 'dd/MM/yyyy') : '01/01/2024'}">01/01/2024</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Information -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="detail-tabs mb-5">
                        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-ct active" id="overview-tab" data-bs-toggle="tab"
                                    data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-info-circle"></i> Tổng quan
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-ct" id="amenities-tab" data-bs-toggle="tab"
                                    data-bs-target="#amenities" type="button" role="tab">
                                    <i class="fas fa-list-check"></i> Tiện nghi
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-ct" id="location-tab" data-bs-toggle="tab" data-bs-target="#location"
                                    type="button" role="tab">
                                    <i class="fas fa-map"></i> Vị trí
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="detailTabsContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="overview-content">
                                    <h3>Giới thiệu</h3>
                                    <p
                                        th:utext="${post != null && post.description != null ? #strings.replace(post.description, '\n', '<br/>') : 'Chưa có mô tả'}">
                                        Mô tả bài đăng
                                    </p>
                                </div>
                            </div>

                            <!-- Amenities Tab -->
                            <div class="tab-pane fade" id="amenities" role="tabpanel">
                                <div class="amenities-content p-3">
                                    <h3 class="mb-3">Tiện nghi</h3>
                                    <div class="amenities-grid">
                                        <div class="amenity-category">
                                            <div class="amenity-list">
                                                <p th:if="${utilities == null or #sets.isEmpty(utilities)}"
                                                    class="text-muted">
                                                    Phòng này hiện không có tiện ích nào.
                                                </p>
                                                <div th:unless="${utilities == null or #sets.isEmpty(utilities)}">
                                                    <ul class="list-unstyled">
                                                        <li class="amenity-item mb-2" th:each="utility : ${utilities}">
                                                            <i class="fas fa-check-circle text-success me-2"></i>
                                                            <span
                                                                th:text="${utility.name != null ? utility.name : 'Tiện ích không xác định'}"></span>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Location Tab -->
                            <div class="tab-pane fade" id="location" role="tabpanel">
                                <div class="location-content p-3">
                                    <h3>Vị trí</h3>
                                    <div class="location-info">
                                        <p>
                                            <strong>Địa chỉ:</strong>
                                            <span th:if="${post != null && post.address != null}"
                                                th:text="|${post.address.street != null ? post.address.street + ', ' : ''}${post.address.ward != null ? post.address.ward.name + ', ' : ''}${post.address.ward != null && post.address.ward.district != null ? post.address.ward.district.name + ', ' : ''}${post.address.ward != null && post.address.ward.district != null && post.address.ward.district.province != null ? post.address.ward.district.province.name : ''}|">
                                            </span>
                                            <span th:unless="${post != null && post.address != null}">
                                                Địa chỉ chưa cập nhật
                                            </span>
                                        </p>
                                        <div class="map-container">
                                            <div id="map"
                                                style="height: 400px; background-color: #f8f9fa; border: 1px solid #dee2e6; display: flex; align-items: center; justify-content: center;">
                                                <span class="text-muted">Bản đồ sẽ hiển thị tại đây</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Room List Section -->
            <div class="detail-tabs">
                <div class="room-list-section container my-5">
                    <h4 class="section-title mb-4 text-gradient">Chi tiết các phòng trong khu trọ</h4>

                    <div th:if="${rooms == null or #lists.isEmpty(rooms)}" class="text-muted">
                        Nhà trọ này hiện không có phòng nào.
                    </div>

                    <div th:unless="${rooms == null or #lists.isEmpty(rooms)}" class="row">
                        <div class="col-lg-3 col-md-6 col-sm-12 mb-4" th:each="room : ${rooms}">
                            <div class="card property-card h-100">
                                <div class="card-image-container position-relative">
                                    <img th:src="@{${room.images[0].url}}" class="card-img-top"
                                        style="height: 200px; object-fit: cover;" alt="Ảnh phòng" />
                                </div>
                                <div class="card-body">
                                    <h5 th:text="${room.namerooms}" class="property-title">Phòng</h5>
                                    <p><strong>Diện tích:</strong> <span th:text="${room.acreage} + ' m²'">20m²</span>
                                    </p>
                                    <p class="property-price mb-3">
                                        <strong>Giá:</strong>
                                        <span class="price-amount"
                                            th:text="${#numbers.formatDecimal(room.price, 1, 'COMMA', 0, 'POINT')} + ' VNĐ/tháng'">
                                            2 triệu/tháng
                                        </span>
                                    </p>
                                    <p><strong>Trạng thái:</strong>
                                        <span th:if="${room.status.name() == 'unactive'}"
                                            class="text-danger">Trống</span>
                                        <span th:if="${room.status.name() == 'active'}" class="text-success">Đã
                                            thuê</span>
                                        <span th:if="${room.status.name() == 'repair'}" class="text-warning">Bảo
                                            trì</span>
                                    </p>
                                    <button class="btn btn-outline-primary w-100" th:attr="data-room-id=${room.room_id}"
                                        onclick="openRoomDetailModal(this.getAttribute('data-room-id'))">
                                        <i class="fas fa-eye me-1"></i> Xem chi tiết
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Similar Properties -->
            <div class="row mt-5">
                <div class="col-12">
                    <h3 class="section-title mb-4">Nhà trọ tương tự</h3>
                    <div class="similar-properties">
                        <div class="row">
                            <p th:if="${similarPosts == null or #lists.isEmpty(similarPosts)}" class="text-muted">Không
                                có bài đăng tương tự</p>
                            <div class="col-lg-3 col-md-6 col-sm-12 mb-4" th:each="similarPost : ${similarPosts}">
                                <div class="card property-card h-100">
                                    <div class="card-image-container position-relative">
                                        <img th:if="${similarPost.images != null and !#lists.isEmpty(similarPost.images)}"
                                            th:src="@{${similarPost.images[0].url}}" alt="Hình ảnh nhà trọ"
                                            class="card-img-top" style="height: 200px; object-fit: cover;">
                                        <img th:unless="${similarPost.images != null and !#lists.isEmpty(similarPost.images)}"
                                            src="/images/cards/default.jpg" alt="Hình ảnh nhà trọ" class="card-img-top"
                                            style="height: 200px; object-fit: cover;">
                                        <div class="card-overlay">
                                            <button class="btn-favorite">
                                                <i class="far fa-heart"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <h5 class="property-title"
                                            th:text="${similarPost != null && similarPost.title != null ? similarPost.title : 'Không có tiêu đề'}">
                                            Tiêu đề</h5>
                                        <div class="property-price mb-3">
                                            <span class="price-amount"
                                                th:text="${similarPost != null && similarPost.price != null ? #numbers.formatDecimal(similarPost.price, 0, 'COMMA', 0, 'POINT') + ' VNĐ/tháng' : '0 VNĐ'}"></span>
                                        </div>
                                        <div class="property-location mb-3">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span th:if="${similarPost.address != null}"
                                                th:text="${similarPost.address.street != null ? similarPost.address.street + ', ' : ''} + 
            ${similarPost.address.ward != null ? similarPost.address.ward.name + ', ' : ''} + 
            ${similarPost.address.ward != null and similarPost.address.ward.district != null ? similarPost.address.ward.district.name + ', ' : ''} + 
            ${similarPost.address.ward != null and similarPost.address.ward.district != null and similarPost.address.ward.district.province != null ? similarPost.address.ward.district.province.name : ''}">
                                            </span>
                                            <span th:unless="${similarPost.address != null}">
                                                Địa chỉ chưa cập nhật
                                            </span>
                                        </div>
                                        <a th:href="@{'/chi-tiet/' + ${similarPost.postId}}" class="btn btn-view">
                                            <i class="fas fa-eye"></i> Xem chi tiết
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tất cả hình ảnh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="photo-grid row">
                        <div th:each="image : ${images}" class="col-md-4 mb-3">
                            <img th:src="@{${image}}" alt="Hình ảnh phòng trọ" class="img-fluid rounded">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">
                        <i class="fas fa-share-alt"></i> Chia sẻ bài đăng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="shareError" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="shareErrorMessage"></span>
                    </div>
                    <div class="alert alert-info" id="shareDebug" style="display: none;">
                        <h6>Debug Information:</h6>
                        <pre id="shareDebugContent"></pre>
                    </div>
                    <div class="share-preview mb-3" id="sharePreview" style="display: none;">
                        <div class="row">
                            <div class="col-4">
                                <img id="shareImage" src="/placeholder.svg" alt="Preview" class="img-fluid rounded">
                            </div>
                            <div class="col-8">
                                <h6 id="shareTitle" class="mb-1"></h6>
                                <p id="shareDescription" class="text-muted small mb-1"></p>
                                <span id="sharePrice" class="text-danger fw-bold"></span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3" id="shareUrlSection" style="display: none;">
                        <label for="shareUrl" class="form-label">Liên kết chia sẻ:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareUrl" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyShareUrl()">
                                <i class="fas fa-copy"></i> Sao chép
                            </button>
                        </div>
                    </div>
                    <div class="social-share" id="socialShare" style="display: none;">
                        <h6>Chia sẻ qua:</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary btn-sm" onclick="shareToFacebook()">
                                <i class="fab fa-facebook-f"></i> Facebook
                            </button>
                            <button class="btn btn-success btn-sm" onclick="shareToMessenger()">
                                <i class="fab fa-facebook-messenger"></i> Messenger
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="shareToTelegram()">
                                <i class="fab fa-telegram"></i> Telegram
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="shareViaEmail()">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                        </div>
                    </div>
                    <div class="text-center" id="shareLoading" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-2">Đang tạo liên kết chia sẻ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="roomDetailModal" tabindex="-1" aria-labelledby="roomDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết phòng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Bên trái: ảnh -->
                        <div class="col-md-6">
                            <!-- Carousel ảnh -->
                            <div id="roomImageCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                                <div class="carousel-inner" id="roomDetailCarouselInner"></div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#roomImageCarousel"
                                    data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#roomImageCarousel"
                                    data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            </div>

                            <!-- Thumbnails -->
                            <div class="d-flex justify-content-center gap-2 flex-wrap" id="roomThumbnails"></div>
                        </div>

                        <!-- Bên phải: thông tin -->
                        <div class="col-md-6">
                            <p><strong>Tên phòng:</strong> <span id="roomDetailName"></span></p>
                            <p><strong>Giá:</strong> <span id="roomDetailPrice"></span></p>
                            <p><strong>Diện tích:</strong> <span id="roomDetailAcreage"></span></p>
                            <p><strong>Số người tối đa:</strong> <span id="roomDetailMaxTenants"></span></p>
                            <p><strong>Trạng thái:</strong> <span id="roomDetailStatus"></span></p>
                            <p><strong>Mô tả:</strong> <span id="roomDetailDescription"></span></p>
                            <div>
                                <strong>Tiện nghi:</strong>
                                <ul id="roomDetailUtilities" class="list-unstyled mt-2"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function changeMainImage(src, element) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = src;
            document.querySelectorAll('.thumbnail-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        function scrollThumbnails(direction) {
            const container = document.querySelector('.thumbnail-scroll');
            const scrollAmount = 80;
            if (direction === 'prev') {
                container.scrollLeft -= scrollAmount;
            } else {
                container.scrollLeft += scrollAmount;
            }
        }

        function openPhotoModal() {
            $('#photoModal').modal('show');
        }

        async function openRoomDetailModal(roomId) {
            try {
                const response = await fetch(`/api/rooms/${roomId}`);
                if (!response.ok) throw new Error('Không thể tải thông tin phòng');
                const room = await response.json();

                if (room.error) {
                    alert('Lỗi: ' + room.error);
                    return;
                }

                // Set thông tin cơ bản
                document.getElementById('roomDetailName').textContent = room.name || 'Chưa xác định';
                document.getElementById('roomDetailPrice').textContent = room.price ? new Intl.NumberFormat('vi-VN').format(room.price) + ' VNĐ/tháng' : 'Chưa xác định';
                document.getElementById('roomDetailAcreage').textContent = room.acreage ? room.acreage.toFixed(0) + ' m²' : 'Chưa xác định';
                document.getElementById('roomDetailMaxTenants').textContent = room.maxTenants || 'Chưa xác định';
                document.getElementById('roomDetailStatus').textContent = room.status || 'Chưa xác định';
                document.getElementById('roomDetailDescription').textContent = room.description || 'Chưa có mô tả';

                // ====== ẢNH ======
                const images = Array.from(new Set(
                    room.images && room.images.length > 0 ? room.images : ['/images/cards/default.jpg']
                ));

                const carouselInner = document.getElementById('roomDetailCarouselInner');
                const thumbnails = document.getElementById('roomThumbnails');
                carouselInner.innerHTML = '';
                thumbnails.innerHTML = '';

                images.forEach((imgUrl, index) => {
                    // Slide lớn
                    const slide = document.createElement('div');
                    slide.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                    slide.innerHTML = `<img src="${imgUrl}" 
     class="d-block w-100 rounded" 
     style="width: 100%; height: 350px; object-fit: cover; border-radius: 8px;" 
     alt="Ảnh phòng">
`;
                    carouselInner.appendChild(slide);

                    // Thumbnail nhỏ
                    const thumb = document.createElement('img');
                    thumb.src = imgUrl;
                    thumb.className = 'img-thumbnail me-2 mb-2';
                    thumb.style = 'width:120px; height: 70px; width: auto; cursor: pointer;';
                    if (index === 0) thumb.classList.add('border-primary');
                    thumb.addEventListener('click', () => {
                        const slides = carouselInner.querySelectorAll('.carousel-item');
                        slides.forEach(s => s.classList.remove('active'));
                        slides[index].classList.add('active');
                    });
                    thumbnails.appendChild(thumb);
                });

                // ====== TIỆN ÍCH ======
                const utilitiesList = document.getElementById('roomDetailUtilities');
                utilitiesList.innerHTML = '';
                if (room.utilities && room.utilities.length > 0) {
                    room.utilities.forEach(utility => {
                        const li = document.createElement('li');
                        li.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${utility}`;
                        utilitiesList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'Không có tiện ích';
                    utilitiesList.appendChild(li);
                }

                const modal = new bootstrap.Modal(document.getElementById('roomDetailModal'));
                modal.show();
            } catch (error) {
                console.error('Lỗi khi tải chi tiết phòng:', error);
                alert('Không thể tải thông tin phòng. Vui lòng thử lại.');
            }
        }



        let contactCache = new Map();
        function fetchContact(event, action) {
            event.preventDefault();
            const button = event.target.closest('button');
            const contactButtons = button.closest('.contact-buttons');
            const postId = contactButtons.getAttribute('data-post-id');
            const loadingDiv = contactButtons.querySelector('.contact-loading');
            const allButtons = contactButtons.querySelectorAll('button');

            if (!postId) {
                alert("Không tìm thấy ID bài đăng!");
                return;
            }

            if (contactCache.has(postId)) {
                const cachedData = contactCache.get(postId);
                if (cachedData.success) {
                    executeContactAction(action, cachedData.phoneNumber);
                    return;
                } else {
                    alert(cachedData.message);
                    return;
                }
            }

            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
            if (loadingDiv) loadingDiv.style.display = 'block';

            fetch(`/api/contact/${postId}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    contactCache.set(postId, data);
                    if (data.success && data.phoneNumber) {
                        updateContactButtons(contactButtons, data);
                        executeContactAction(action, data.phoneNumber);
                    } else {
                        alert(data.message || "Không thể lấy thông tin liên hệ");
                    }
                })
                .catch(error => {
                    console.error('Error fetching contact info:', error);
                    alert("❌ Không thể tải thông tin liên hệ. Vui lòng thử lại sau.");
                })
                .finally(() => {
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    allButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                });
        }

        function updateContactButtons(contactButtons, data) {
            const phoneButton = contactButtons.querySelector('button[onclick*="call"]');
            const phoneText = phoneButton.querySelector('.phone-text');
            if (phoneText && data.phoneNumber) {
                phoneText.textContent = data.phoneNumber;
                phoneButton.classList.remove('btn-success');
                phoneButton.classList.add('btn-outline-success');
            }
        }

        function executeContactAction(action, phoneNumber) {
            try {
                switch (action) {
                    case 'call': window.location.href = `tel:${phoneNumber}`; break;
                    case 'sms': window.location.href = `sms:${phoneNumber}`; break;
                    case 'zalo': window.location.href = `zalo://chat?phone=${phoneNumber}`; setTimeout(() => window.open(`https://zalo.me/${phoneNumber}`, '_blank'), 1000); break;
                    default: alert("Hành động không được hỗ trợ");
                }
            } catch (error) {
                console.error('Error executing contact action:', error);
                alert("Không thể thực hiện hành động này");
            }
        }

        function saveProperty() { alert('Đã lưu tin!'); }

        let currentShareData = null;
        function shareProperty(event) {
            event.preventDefault();
            const button = event.target.closest('button');
            const postId = button.getAttribute('data-post-id');

            if (!postId || postId === 'null' || postId === 'undefined') {
                showShareError("Không tìm thấy ID bài đăng!");
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('shareModal'));
            modal.show();
            hideAllSections();
            showLoading();

            fetch(`/api/share/${postId}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                        }).catch(parseError => {
                            return response.text().then(text => {
                                throw new Error(`HTTP ${response.status}: ${text}`);
                            });
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        currentShareData = data;
                        displayShareData(data);
                    } else {
                        throw new Error(data.message || "Không thể tạo liên kết chia sẻ");
                    }
                })
                .catch(error => {
                    console.error('Error fetching share URL:', error);
                    showShareError("Không thể tải liên kết chia sẻ: " + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function hideAllSections() {
            document.getElementById('shareError').style.display = 'none';
            document.getElementById('shareDebug').style.display = 'none';
            document.getElementById('sharePreview').style.display = 'none';
            document.getElementById('shareUrlSection').style.display = 'none';
            document.getElementById('socialShare').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('shareLoading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('shareLoading').style.display = 'none';
        }

        function showShareError(message) {
            document.getElementById('shareErrorMessage').textContent = message;
            document.getElementById('shareError').style.display = 'block';
        }

        function showDebugInfo(data) {
            document.getElementById('shareDebugContent').textContent = JSON.stringify(data, null, 2);
            document.getElementById('shareDebug').style.display = 'block';
        }

        function displayShareData(data) {
            document.getElementById('shareUrl').value = data.shareUrl;
            document.getElementById('shareUrlSection').style.display = 'block';
            if (data.title || data.description || data.imageUrl) {
                document.getElementById('shareTitle').textContent = data.title || 'Phòng trọ cho thuê';
                document.getElementById('shareDescription').textContent = data.description || '';
                document.getElementById('sharePrice').textContent = data.price ? data.price + ' VNĐ/tháng' : '';
                document.getElementById('shareImage').src = data.imageUrl || '/images/no-image.jpg';
                document.getElementById('sharePreview').style.display = 'block';
            }
            document.getElementById('socialShare').style.display = 'block';
        }

        function copyShareUrl() {
            const shareUrl = document.getElementById('shareUrl').value;
            if (!shareUrl) {
                showNotification("Chưa có liên kết để sao chép!", 'error');
                return;
            }

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification("Đã sao chép liên kết!", 'success');
                }).catch(error => {
                    console.error('Clipboard error:', error);
                    fallbackCopyText(shareUrl);
                });
            } else {
                fallbackCopyText(shareUrl);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showNotification("Đã sao chép liên kết!", 'success');
            } catch (error) {
                console.error('Fallback copy failed:', error);
                showNotification("Không thể sao chép. Vui lòng sao chép thủ công: " + text, 'error');
            }

            textArea.remove();
        }

        function shareToFacebook() {
            if (!currentShareData) return;
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentShareData.shareUrl)}`;
            window.open(url, '_blank', 'width=600,height=400');
        }

        function shareToMessenger() {
            if (!currentShareData) return;
            const text = `${currentShareData.title}\n${currentShareData.description}\n${currentShareData.shareUrl}`;
            const url = `https://messenger.com/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareToTelegram() {
            if (!currentShareData) return;
            const text = `${currentShareData.title}\n${currentShareData.description}`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(currentShareData.shareUrl)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareViaEmail() {
            if (!currentShareData) return;
            const subject = encodeURIComponent(currentShareData.title);
            const body = encodeURIComponent(`${currentShareData.description}\n\nXem chi tiết tại: ${currentShareData.shareUrl}`);
            const url = `mailto:?subject=${subject}&body=${body}`;
            window.location.href = url;
        }

        function showNotification(message, type = 'info') {
            if (typeof toastr !== 'undefined') {
                toastr[type](message);
            } else {
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
                alert(icon + ' ' + message);
            }
        }

        function reportProperty() {
            alert('Chức năng báo cáo đang được phát triển!');
        }

        let map;
        function initMap() {
            const defaultLatLng = { lat: 16.068, lng: 108.212 };
            const address = document.querySelector('.location-info p span[th:text]')?.textContent?.trim();
            map = new google.maps.Map(document.getElementById('map'), { center: defaultLatLng, zoom: 13 });
            const geocoder = new google.maps.Geocoder();

            if (!address) {
                new google.maps.Marker({ position: defaultLatLng, map, title: "Trung tâm TP. Đà Nẵng" });
                return;
            }

            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    map.setZoom(15);
                    new google.maps.Marker({ map, position: location, title: address });
                } else {
                    console.warn('Không tìm thấy địa chỉ: ' + status);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mapScript = document.createElement('script');
            mapScript.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAW7YMulhdUYW1RwiUNjijM3Mv222fLrWc&callback=initMap';
            mapScript.async = true;
            mapScript.defer = true;
            document.body.appendChild(mapScript);

            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    if (event.target.getAttribute('data-bs-target') === '#location') {
                        setTimeout(() => initMap(), 300);
                    }
                });
            });

            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const hiddenReviews = document.querySelectorAll('.hidden-review');
            let visibleCount = 5;
            const step = 5;

            loadMoreBtn?.addEventListener('click', () => {
                const nextHidden = Array.from(hiddenReviews).slice(visibleCount - 5, visibleCount + step);
                nextHidden.forEach(item => item.classList.remove('hidden-review'));
                visibleCount += step;

                if (visibleCount >= hiddenReviews.length + 5) {
                    loadMoreBtn.style.display = 'none';
                }
            });

            if (hiddenReviews.length === 0) {
                loadMoreBtn.style.display = 'none';
            }
        });

        const stars = document.querySelectorAll('#stars span');
        const ratingInput = document.getElementById('rating');
        let selectedRating = 0;

        stars?.forEach((star, idx) => {
            const value = parseInt(star.dataset.value);

            star.addEventListener('click', () => {
                selectedRating = value;
                ratingInput.value = selectedRating;
                highlightStars(selectedRating);
            });

            star.addEventListener('mouseover', () => {
                highlightStars(value);
            });

            star.addEventListener('mouseout', () => {
                highlightStars(selectedRating);
            });
        });

        function highlightStars(rating) {
            stars.forEach((star, idx) => {
                if (idx < rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }
    </script>
</body>

</html>