<!DOCTYPE html>
<html lang="en">

<head th:replace="~{/layouts/head}">
  <title>Chi Ti·∫øt - Nh√† Tr·ªç Xanh</title>
</head>

<body>
<!-- NAVBAR -->
<div th:replace="~{/layouts/sidebar-host}"></div>
<div class="main-content">
  <h5 class="fw-bold mb-4">Danh s√°ch h·ª£p ƒë·ªìng</h5>

  <!-- Th·ªëng k√™ h·ª£p ƒë·ªìng -->
  <div class="row g-3 host-stats">
    <div class="col-md-6 col-xl-3">
      <div class="host-card-stat host-stat-blue">
        <div class="host-stat-icon"><i class="fa fa-file-alt"></i></div>
        <div class="host-stat-text">
          <div class="host-stat-label">T·ªïng h·ª£p ƒë·ªìng</div>
          <div class="host-stat-number" id="total-contracts">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="host-card-stat host-stat-green">
        <div class="host-stat-icon"><i class="fa fa-check-circle"></i></div>
        <div class="host-stat-text">
          <div class="host-stat-label">ƒêang ho·∫°t ƒë·ªông</div>
          <div class="host-stat-number" id="active-contracts">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="host-card-stat host-stat-yellow">
        <div class="host-stat-icon"><i class="fa fa-edit"></i></div>
        <div class="host-stat-text">
          <div class="host-stat-label">B·∫£n nh√°p</div>
          <div class="host-stat-number" id="draft-contracts">0</div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="host-card-stat host-stat-purple">
        <div class="host-stat-icon"><i class="fa fa-calendar-times"></i></div>
        <div class="host-stat-text">
          <div class="host-stat-label">S·∫Øp h·∫øt h·∫°n</div>
          <div class="host-stat-number" id="expiring-contracts">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading spinner -->
  <div id="loading" class="text-center mt-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ƒêang t·∫£i...</span>
    </div>
  </div>

  <!-- Danh s√°ch h·ª£p ƒë·ªìng -->
  <div class="card mt-4 shadow-sm host-contract-table" id="contracts-table" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center bg-white">
      <h6 class="mb-0 fw-bold">Danh s√°ch c√°c h·ª£p ƒë·ªìng cho thu√™</h6>
      <a href="/chu-tro/hop-dong">
        <button class="btn btn-sm btn-outline-primary">
          <i class="fa fa-plus-circle"></i> H·ª£p ƒë·ªìng m·ªõi
        </button>
      </a>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered mb-0 text-center">
        <thead class="table-light">
        <tr>
          <th>M√É S·ªê Hƒê</th>
          <th>NG∆Ø·ªúI THU√ä</th>
          <th>NG√ÄY B·∫ÆT ƒê·∫¶U</th>
          <th>NG√ÄY K·∫æT TH√öC</th>
          <th>S·ªê ƒêI·ªÜN THO·∫†I</th>
          <th>TR·∫†NG TH√ÅI</th>
          <th>H√ÄNH ƒê·ªòNG</th>
        </tr>
        </thead>
        <tbody id="contracts-tbody">
        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
        </tbody>
      </table>
    </div>
    <div class="card-footer d-flex justify-content-between">
      <small id="pagination-info">Hi·ªÉn th·ªã 0 ƒë·∫øn 0 trong s·ªë 0 h·ª£p ƒë·ªìng</small>
      <nav>
        <ul class="pagination pagination-sm mb-0" id="pagination">
          <!-- Pagination s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
        </ul>
      </nav>
    </div>
  </div>

  <!-- Error message -->
  <div id="error-message" class="alert alert-danger mt-4" style="display: none;">
    <i class="fa fa-exclamation-triangle"></i>
    <span id="error-text">C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu</span>
  </div>
</div>

<script>
  // üöÄ LOAD D·ªÆ LI·ªÜU KHI TRANG ƒê∆Ø·ª¢C T·∫¢I
  document.addEventListener('DOMContentLoaded', function() {
    loadContracts();
  });

  // üìä H√ÄM LOAD DANH S√ÅCH H·ª¢P ƒê·ªíNG
  async function loadContracts() {
    try {
      showLoading(true);

      const response = await fetch('/api/contracts/list', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();

      if (data.success) {
        displayContracts(data.contracts);
        updateStats(data.contracts);
        updatePagination(data.totalContracts);
      } else {
        showError(data.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu h·ª£p ƒë·ªìng');
      }
    } catch (error) {
      console.error('Error loading contracts:', error);
      showError('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.');
    } finally {
      showLoading(false);
    }
  }

  function displayContracts(contracts) {
    const tbody = document.getElementById('contracts-tbody');

    if (!contracts || contracts.length === 0) {
      tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-muted">
                    <i class="fa fa-inbox"></i><br>
                    Kh√¥ng c√≥ h·ª£p ƒë·ªìng n√†o
                </td>
            </tr>
        `;
      return;
    }

    tbody.innerHTML = contracts.map(contract => `
        <tr>
            <td><strong>${contract.contractId}</strong></td>
            <td>${contract.tenantName || 'N/A'}</td>
            <td>${formatDate(contract.startDate)}</td>
            <td>${formatDate(contract.endDate)}</td>
            <td>${contract.tenantPhone || 'N/A'}</td>
            <td>${getStatusSelect(contract.contractId, contract.status)}</td>
            <td>
                <button
                    class="btn btn-sm btn-outline-primary"
                    onclick="editContract(${contract.contractId})"
                    title="Ch·ªânh s·ª≠a">
                    <i class="fa fa-pen"></i>
                </button>
            </td>
        </tr>
    `).join('');

    document.getElementById('contracts-table').style.display = 'block';
  }
  // üè∑Ô∏è T·∫†O SELECT TR·∫†NG TH√ÅI
  function getStatusSelect(contractId, currentStatus) {
    const statusOptions = [
      { value: 'DRAFT', label: 'B·∫£n nh√°p', class: 'text-secondary' },
      { value: 'PENDING', label: 'Ch·ªù x√°c nh·∫≠n', class: 'text-warning' },
      { value: 'ACTIVE', label: 'ƒêang thu√™', class: 'text-success' },
      { value: 'EXPIRING', label: 'S·∫Øp h·∫øt h·∫°n', class: 'text-warning' },
      { value: 'CANCELLED', label: 'ƒê√£ h·ªßy', class: 'text-danger' }
    ];

    const options = statusOptions.map(option =>
            `<option value="${option.value}"
               class="${option.class}"
               ${option.value === currentStatus ? 'selected' : ''}>
         ${option.label}
       </option>`
    ).join('');

    return `
      <select class="form-select form-select-sm status-select"
              data-contract-id="${contractId}"
              data-current-status="${currentStatus}"
              onchange="updateContractStatus(${contractId}, this.value)"
              style="min-width: 130px;">
        ${options}
      </select>
    `;
  }


  // üîß C·∫¨P NH·∫¨T JAVASCRIPT V·ªöI ENUM Status
  async function updateContractStatus(contractId, newStatus) {
    console.log('üîÑ Updating contract status');
    console.log('üìù Contract ID:', contractId);
    console.log('üìù New Status:', newStatus);

    // üîç VALIDATE STATUS TR∆Ø·ªöC KHI G·ª¨I
    const validStatuses = ['DRAFT', 'ACTIVE', 'TERMINATED', 'EXPIRED'];
    const upperStatus = newStatus.toUpperCase();

    if (!validStatuses.includes(upperStatus)) {
      throw new Error(`Status kh√¥ng h·ª£p l·ªá: ${newStatus}. C√°c gi√° tr·ªã cho ph√©p: ${validStatuses.join(', ')}`);
    }

    const requestData = {
      status: upperStatus // ƒê·∫£m b·∫£o g·ª≠i uppercase
    };

    console.log('üì§ Sending request:', requestData);

    try {
      const response = await fetch(`/api/contracts/hop-dong/update-status/${contractId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
      });

      console.log('üì• Response status:', response.status);

      const result = await response.json();
      console.log('üì• Response data:', result);

      if (!response.ok) {
        throw new Error(result.message || `HTTP error! status: ${response.status}`);
      }

      console.log('‚úÖ Update successful:', result);
      return result;

    } catch (error) {
      console.error('‚ùå Error updating contract status:', error);
      throw error;
    }
  }

  // üîß FUNCTION L·∫§Y VALID STATUSES
  async function getValidStatuses() {
    try {
      const response = await fetch('/chu-tro/hop-dong/valid-statuses');
      const result = await response.json();

      if (result.success) {
        console.log('‚úÖ Valid statuses:', result.statuses);
        return result.statuses;
      } else {
        throw new Error('Failed to get valid statuses');
      }
    } catch (error) {
      console.error('‚ùå Error getting valid statuses:', error);
      return ['DRAFT', 'ACTIVE', 'TERMINATED', 'EXPIRED']; // fallback
    }
  }

  // üé® HI·ªÇN TH·ªä TH√îNG B√ÅO
  function showSuccessMessage(message) {
    // T√πy ch·ªânh theo UI c·ªßa b·∫°n
    alert('‚úÖ ' + message);
  }

  function showErrorMessage(message) {
    // T√πy ch·ªânh theo UI c·ªßa b·∫°n
    alert('‚ùå ' + message);
  }



  // üìà C·∫¨P NH·∫¨T TH·ªêNG K√ä
  function updateStats(contracts) {
    const stats = {
      total: contracts.length,
      active: contracts.filter(c => c.status === 'ACTIVE').length,
      draft: contracts.filter(c => c.status === 'DRAFT').length,
      expiring: contracts.filter(c => c.status === 'EXPIRING').length
    };

    document.getElementById('total-contracts').textContent = stats.total;
    document.getElementById('active-contracts').textContent = stats.active;
    document.getElementById('draft-contracts').textContent = stats.draft;
    document.getElementById('expiring-contracts').textContent = stats.expiring;
  }

  // üìÖ FORMAT NG√ÄY TH√ÅNG
  function formatDate(dateString) {
    if (!dateString) return 'N/A';

    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }

  // üìÑ C·∫¨P NH·∫¨T PAGINATION
  function updatePagination(totalContracts) {
    document.getElementById('pagination-info').textContent =
            `Hi·ªÉn th·ªã 1 ƒë·∫øn ${totalContracts} trong s·ªë ${totalContracts} h·ª£p ƒë·ªìng`;
  }

  // ‚è≥ HI·ªÇN TH·ªä/·∫®N LOADING
  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
    document.getElementById('contracts-table').style.display = show ? 'none' : 'block';
  }

  // ‚ùå HI·ªÇN TH·ªä L·ªñI
  function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').style.display = 'block';
    document.getElementById('contracts-table').style.display = 'none';
  }

  function editContract(contractId) {
    console.log('üîç Attempting to edit contract with ID:', contractId);
    window.location.href = `/chu-tro/hop-dong/edit/${contractId}`;
  }


  // ‚úÖ HI·ªÇN TH·ªä TH√îNG B√ÅO TH√ÄNH C√îNG
  function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
      <i class="fa fa-check-circle"></i> ${message}
      <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 5000);
  }

  // ‚ùå HI·ªÇN TH·ªä TH√îNG B√ÅO L·ªñI
  function showErrorMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-danger position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
      <i class="fa fa-exclamation-triangle"></i> ${message}
      <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 5000);
  }
</script>

<style>
  .cursor-pointer {
    cursor: pointer;
  }

  .cursor-pointer:hover {
    opacity: 0.7;
  }

  .spinner-border {
    width: 3rem;
    height: 3rem;
  }

  .status-select {
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
  }

  .status-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }

  .status-select:disabled {
    background-color: #f8f9fa;
    cursor: not-allowed;
  }

  /* Custom toast styles */
  .alert.position-fixed {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    animation: slideInRight 0.3s ease-out;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Select option colors */
  .status-select option.text-success {
    color: #198754 !important;
  }

  .status-select option.text-warning {
    color: #ffc107 !important;
  }

  .status-select option.text-danger {
    color: #dc3545 !important;
  }

  .status-select option.text-secondary {
    color: #6c757d !important;
  }
</style>
</body>
</html>
