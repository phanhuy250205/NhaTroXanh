<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <!-- ICON -->
    <link rel="icon" th:href="@{/images/logo/nhatroxanh(title).png}" type="image/x-icon">
    <!-- Font Awesome -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/host.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">

    <!-- Validation Styles -->
    <style>
        /* Validation Styles */
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .invalid-feedback {
            display: block !important;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
            font-weight: 500;
        }

        .invalid-feedback i {
            margin-right: 0.25rem;
        }

        /* Error animation */
        .is-invalid {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Validation summary styles */
        #validation-summary {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tab with errors indicator */
        .nav-link.has-errors {
            position: relative;
        }

        .nav-link.has-errors::after {
            content: "";
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: #dc3545;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Success message styles */
        .alert-success {
            border-left: 4px solid #28a745;
            animation: slideDown 0.3s ease-out;
        }

        /* Loading button styles */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Form field focus styles */
        .form-control:focus,
        .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Error field focus override */
        .form-control.is-invalid:focus,
        .form-select.is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Responsive error messages */
        @media (max-width: 768px) {
            .invalid-feedback {
                font-size: 0.8em;
            }

            #validation-summary {
                font-size: 0.9em;
            }
        }
    </style>
</head>

<body>
<!-- NAVBAR -->
<div th:replace="~{/layouts/sidebar-host}"></div>

<!-- Main Content -->
<div class="nha-tro-main-content">
    <div class="nha-tro-header">
        <h5>
            <a href="javascript:history.back()" class="nha-tro-back-btn">
                <i class="fa fa-arrow-left"></i>
            </a>
            Tạo hợp đồng thuê nhà
        </h5>
        <hr>
    </div>

    <div class="container-fluid mt-4">
        <div class="row mt-3">
            <!-- Form Column -->
            <div class="col-lg-7">
                <form th:action="@{/api/contracts}" method="post" enctype="multipart/form-data"
                      th:object="${contract}" novalidate id="contractForm">

                    <!-- Basic Info Card -->
                    <div class="card nha-tro-card mb-3">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">
                                        Số điện thoại <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" placeholder="Số điện thoại người thuê"
                                           id="tenant-phone" required pattern="[0-9]{10}" maxlength="10">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">
                                        Ngày lập hợp đồng <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" name="contractDate" id="contract-date"
                                           required
                                           th:value="${contract.contractDate != null} ? ${#temporals.format(contract.contractDate, 'yyyy-MM-dd')} : ''">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">
                                        Trạng thái <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" name="status" id="contract-status" required
                                            th:value="${contract.status}">
                                        <option value="">Trạng thái</option>
                                        <option value="active" th:selected="${contract.status == 'active'}">Đang
                                            hiệu lực</option>
                                        <option value="expired" th:selected="${contract.status == 'expired'}">Hết
                                            hiệu lực</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs nha-tro-tabs" id="contractTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-tab="tenantInfo" href="#tenantInfo">
                                <i class="fa fa-user me-2"></i> Người thuê
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="ownerInfo" href="#ownerInfo">
                                <i class="fa fa-id-card me-2"></i> Chủ trọ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="roomInfo" href="#roomInfo">
                                <i class="fa fa-house me-2"></i> Nhà trọ
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-tab="terms" href="#terms">
                                <i class="fa fa-file-contract me-2"></i> Điều khoản
                            </a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content card p-4 nha-tro-tab-content" style="border-radius: 0px;">
                        <!-- Tenant Info Tab -->
                        <div class="tab-pane fade show active" id="tenantInfo">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Thông tin người thuê</h6>
                                <button type="button"
                                        class="btn btn-outline-success btn-sm nha-tro-host-btn-add-customer"
                                        id="btn-add-customer-host" data-bs-toggle="modal" data-bs-target="#addCustomerModal-host">
                                    <i class="fa fa-user-plus me-1"></i> Thêm khách mới
                                </button>
                            </div>
                            <hr class="mb-4">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        Họ và tên <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="tenant-name" th:field="*{tenant.fullName}" required
                                           placeholder="Nhập họ và tên">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">
                                        Ngày sinh <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="tenant-dob" required
                                            th:field="*{tenant.birthday}" max="2006-12-31">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">
                                        Số CMND/CCCD <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="tenant-id" required
                                           pattern="[0-9]{12}" maxlength="12" placeholder="12 chữ số" th:field="*{tenant.cccdNumber}">
                                </div>

                                <div class="col-md-5">
                                    <label class="form-label">
                                        Ngày cấp <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="tenant-id-date" th:field="*{tenant.issueDate}" required>
                                </div>

                                <div class="col-md-7">
                                    <label class="form-label">
                                        Nơi cấp <span class="text-danger" th:field="*{tenant.issuePlace}">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="tenant-id-place" required
                                           placeholder="Nơi cấp CMND/CCCD">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">
                                        Tỉnh/Thành phố <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="tenant-province">
                                        <option value="">Tỉnh/Thành phố</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">
                                        Quận/Huyện <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="tenant-district">
                                        <option value="">Quận/Huyện</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">
                                        Phường/Xã <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="tenant-ward">
                                        <option value="">Phường/Xã</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        Tên đường/Số nhà <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="tenant-street" required
                                           placeholder="Số nhà, tên đường">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Email (nếu có)</label>
                                    <input type="email" class="form-control" id="tenant-email"
                                           pattern=".*@gmail\.com$" placeholder="example@gmail.com">
                                </div>

                                <!-- CCCD Images -->
                                <div class="col-md-6">
                                    <label class="form-label">Ảnh CCCD mặt trước</label>
                                    <div class="nha-tro-image-upload"
                                         onclick="document.getElementById('cccd-front').click()">
                                        <input type="file" id="cccd-front" accept="image/*" style="display: none;">
                                        <div id="cccd-front-preview" class="nha-tro-image-preview">
                                            <i class="fa fa-camera fa-2x"></i>
                                            <div class="mt-2">Tải ảnh mặt trước</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Ảnh CCCD mặt sau</label>
                                    <div class="nha-tro-image-upload"
                                         onclick="document.getElementById('cccd-back').click()">
                                        <input type="file" id="cccd-back" accept="image/*" style="display: none;">
                                        <div id="cccd-back-preview" class="nha-tro-image-preview">
                                            <i class="fa fa-camera fa-2x"></i>
                                            <div class="mt-2">Tải ảnh mặt sau</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary nha-tro-btn-next" id="btn-next-owner">
                                    Tiếp tục <i class="fa fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Owner Info Tab -->
                        <div class="tab-pane fade" id="ownerInfo">
                            <h6 class="mb-3">Thông tin chủ trọ</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="owner-name"  th:field="*{owner.fullName}" required
                                           placeholder="Nhập họ và tên">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">
                                        Ngày sinh <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="owner-dob" th:field="*{owner.birthday}" required>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">
                                        Số CMND/CCCD <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="owner-id" required
                                           pattern="[0-9]{12}" maxlength="12" placeholder="12 chữ số" th:field="*{owner.cccdNumber}">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">Ngày cấp <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="owner-id-date" th:field="*{owner.issueDate}" required>
                                </div>

                                <div class="col-md-9">
                                    <label class="form-label">Nơi cấp <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="owner-id-place" th:field="*{owner.issuePlace}" required
                                           placeholder="Nơi cấp CMND/CCCD">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Tỉnh/Thành phố</label>
                                    <select class="form-select" th:field="*{owner.province}" id="owner-province">
                                        <option value="">Tỉnh/Thành phố</option>
                                        <option th:value="${contract.owner.province}"
                                                th:text="${contract.owner.province}"
                                                th:unless="${contract.owner.province == null}">
                                            [[${contract.owner.province}]]
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Quận/Huyện</label>
                                    <select class="form-select" th:field="*{owner.district}" id="owner-district">
                                        <option value="">Quận/Huyện</option>
                                        <option th:value="${contract.owner.district}"
                                                th:text="${contract.owner.district}"
                                                th:unless="${contract.owner.district == null}">
                                            [[${contract.owner.district}]]
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Phường/Xã</label>
                                    <select class="form-select" th:field="*{owner.ward}" id="owner-ward">
                                        <option value="">Phường/Xã</option>
                                        <option th:value="${contract.owner.ward}" th:text="${contract.owner.ward}"
                                                th:unless="${contract.owner.ward == null}">
                                            [[${contract.owner.ward}]]
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Tên đường/Số nhà</label>
                                    <input type="text" class="form-control" th:field="*{owner.street}"
                                           th:value="${contract.owner.street != null ? contract.owner.street : ''}"
                                           placeholder="Số nhà, tên đường">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Email (nếu có)</label>
                                    <input type="email" class="form-control" id="owner-email" th:field="*{owner.email}"
                                           pattern=".*@gmail\.com$" placeholder="example@gmail.com">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        Số điện thoại <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="owner-phone" th:field="*{owner.phone}" required
                                           pattern="[0-9]{10}" maxlength="10" placeholder="10 chữ số">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Tài khoản ngân hàng (nếu có)</label>
                                    <input type="text" class="form-control" th:field="*{owner.bankAccount}"
                                           placeholder="Số tài khoản ngân hàng">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="btn-prev-tenant">
                                    <i class="fa fa-arrow-left me-1"></i> Quay lại
                                </button>
                                <button type="button" class="btn btn-primary nha-tro-btn-next" id="btn-next-room">
                                    Tiếp tục <i class="fa fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Room Info Tab -->
                        <div class="tab-pane fade" id="roomInfo">
                            <h6 class="mb-3">Thông tin nhà trọ</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">

                                        <i class="fa fa-building me-1"></i>Chọn khu trọ <span
                                            class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="hostelId" onchange="NhaTroContract.filterRooms()" required>
                                        <option value="">-- Chọn khu trọ --</option>
                                        <option th:each="hostel : ${hostels}" th:value="${hostel.hostelId}"
                                                th:text="${hostel.name}"
                                                th:selected="${hostel.hostelId == contract.room?.hostelId}"></option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label" th:fragment="roomSelect">
                                        <i class="fa fa-door-open me-1"></i>Chọn phòng trọ <span
                                            class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="roomId" name="room.roomId"
                                            th:class="${#fields.hasErrors('room.roomId')} ? 'form-control is-invalid' : 'form-control'"
                                            required>
                                        <option value="">-- Chọn phòng trọ --</option>
                                        <option th:each="room : ${rooms}" th:value="${room.roomId}"
                                                th:text="${room.roomName} + ' (' + room.address + ')'"
                                                th:data-hostel-id="${room.hostelId}"></option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Tỉnh/Thành phố</label>
                                    <select class="form-select" id="room-province">
                                        <option value="">Tỉnh/Thành phố</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quận/Huyện</label>
                                    <select class="form-select" id="room-district">
                                        <option value="">Quận/Huyện</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Phường/Xã</label>
                                    <select class="form-select" id="room-ward">
                                        <option value="">Phường/Xã</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Tên đường/Số nhà</label>
                                    <input type="text" class="form-control" id="room-street">
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">Số phòng</label>
                                    <input type="text" class="form-control" id="room-number" readonly>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">Diện tích (m²)</label>
                                    <input type="number" class="form-control" id="room-area">
                                </div>

                                <!-- Residents Section -->
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <label class="form-label mb-0">
                                            <i class="fa fa-users me-2"></i>Số người ở
                                            <span class="badge bg-primary ms-2" id="residents-count">0</span>
                                        </label>
                                        <button type="button"
                                                class="btn btn-outline-primary btn-sm nha-tro-host-btn-add-resident"
                                                id="btn-add-resident" data-bs-toggle="modal" data-bs-target="#addResidentModal">
                                            <i class="fa fa-user-plus me-1"></i> Thêm người ở
                                        </button>
                                    </div>
                                    <div id="residents-list" class="nha-tro-residents-container">
                                        <div class="text-center text-muted py-4" id="no-residents-message">
                                            <i class="fa fa-users fa-2x mb-2"></i>
                                            <p>Chưa có người ở nào được thêm</p>
                                            <small>Nhấn "Thêm người ở" để bắt đầu</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Amenities Section -->
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label">Tiện ích</label>
                                        <button type="button"
                                                class="btn btn-outline-primary btn-sm nha-tro-host-btn-add-amenity"
                                                id="btn-add-amenity-host" data-bs-toggle="modal" data-bs-target="#addAmenityModal-host">
                                            <i class="fa fa-plus me-1"></i> Thêm tiện ích
                                        </button>
                                    </div>
                                    <div class="nha-tro-amenities" id="amenities-list-host">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wifi">
                                            <label class="form-check-label" for="wifi">Wifi</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="ac">
                                            <label class="form-check-label" for="ac">Máy lạnh</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="fridge">
                                            <label class="form-check-label" for="fridge">Tủ lạnh</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="kitchen">
                                            <label class="form-check-label" for="kitchen">Bếp</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="parking">
                                            <label class="form-check-label" for="parking">Chỗ để xe</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="security">
                                            <label class="form-check-label" for="security">Camera an ninh</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Ghi chú</label>
                                    <textarea class="form-control" rows="3" id="room-notes"></textarea>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="btn-prev-owner">
                                    <i class="fa fa-arrow-left me-1"></i> Quay lại
                                </button>
                                <button type="button" class="btn btn-primary nha-tro-btn-next" id="btn-next-terms">
                                    Tiếp tục <i class="fa fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Terms Tab -->
                        <div class="tab-pane fade" id="terms">
                            <h6 class="mb-3">Điều khoản & Thanh toán</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        Giá thuê hàng tháng (VND) <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="rent-price" required min="1"
                                           placeholder="Nhập giá thuê">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        Phương thức thanh toán <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="payment-method" required>
                                        <option value="">Chọn phương thức</option>
                                        <option value="cash">Tiền mặt</option>
                                        <option value="transfer">Chuyển khoản</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        Ngày thanh toán hàng tháng <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="payment-date" required
                                           placeholder="Ví dụ: Ngày 5 hằng tháng">
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        Thời hạn hợp đồng <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" value="0" id="contract-duration" th:field="*{terms.duration}"
                                               required min="1" placeholder="Số tháng">
                                        <span class="input-group-text">Tháng</span>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">
                                        Ngày bắt đầu HĐ <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="start-date" name="terms.startDate" th:field="*{terms.startDate}" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Đặt cọc trước</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" value="2" id="deposit-months"
                                               min="0">
                                        <span class="input-group-text">tháng tiền nhà</span>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Điều khoản chung</label>
                                    <textarea class="form-control" rows="4" id="terms-conditions"
                                              placeholder="Nhập các điều khoản chung của hợp đồng..."></textarea>
                                </div>
                            </div>

                            <div class="d-flex justify-content-start mt-4">
                                <button type="button" class="btn btn-secondary" id="btn-prev-room">
                                    <i class="fa fa-arrow-left me-1"></i> Quay lại
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
                        <button type="button" class="btn btn-outline-info flex-fill" id="btn-update">
                            <i class="fa fa-pen-to-square me-1"></i> Cập nhật hợp đồng
                        </button>

                        <button type="button" class="btn btn-success flex-fill" id="btn-print">
                            <i class="fa fa-print me-1"></i> In hợp đồng
                        </button>

                        <button type="button" class="btn nha-tro-btn-purple flex-fill" id="btn-save">
                            <i class="fa fa-floppy-disk me-1"></i> Lưu hợp đồng
                        </button>
                    </div>
                </form>
            </div>

            <!-- Preview Column -->
            <div class="col-lg-5">
                <div class="card nha-tro-contract-preview">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <strong>Xem trước hợp đồng</strong>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="btn-zoom-out" title="Thu nhỏ">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button class="btn btn-outline-secondary" id="btn-zoom-in" title="Phóng to">
                                <i class="fa fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-secondary" id="btn-reset-zoom" title="Kích thước gốc">
                                <i class="fa fa-refresh"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body nha-tro-preview-content" id="contract-preview">
                        <div id="preview-container"
                             style="transform-origin: top left; transition: transform 0.3s ease;">
                            <div class="text-center mb-4">
                                <p><strong>CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM<br>Độc lập - Tự do - Hạnh
                                    phúc</strong></p>
                                <p><strong>HỢP ĐỒNG THUÊ NHÀ</strong></p>
                            </div>

                            <p>Hôm nay, ngày <span id="preview-sign-date"
                                                   class="nha-tro-highlight">........................</span>, chúng tôi gồm:</p>

                            <div class="mb-3">
                                <p><strong>BÊN CHO THUÊ (Bên A):</strong> <span id="preview-owner-name"
                                                                                class="nha-tro-highlight"
                                                                                th:text="${contract.owner.fullName != null ? contract.owner.fullName : '........................'}">........................</span>
                                </p>
                                <p>Sinh ngày: <span id="preview-owner-dob" class="nha-tro-highlight"
                                                    th:text="${contract.owner.birthday != null ? #dates.format(contract.owner.birthday, 'yyyy-MM-dd') : '........................'}">........................</span>
                                </p>
                                <p>Số CMND/CCCD: <span id="preview-owner-id" class="nha-tro-highlight"
                                                       th:text="${contract.owner.cccdNumber != null ? contract.owner.cccdNumber : '........................'}">........................</span>
                                    cấp ngày <span id="preview-owner-id-date" class="nha-tro-highlight"
                                                   th:text="${contract.owner.issueDate != null ? #dates.format(contract.owner.issueDate, 'yyyy-MM-dd') : '........................'}">........................</span>
                                    tại <span id="preview-owner-id-place" class="nha-tro-highlight"
                                              th:text="${contract.owner.issuePlace != null ? contract.owner.issuePlace : '........................'}">........................</span>
                                </p>
                                <p>Địa chỉ: <span id="preview-owner-address" class="nha-tro-highlight"
                                                  th:text="${contract.owner.street != null ? contract.owner.street : '........................'} + ', ' + ${contract.owner.ward != null ? contract.owner.ward : ''} + ', ' + ${contract.owner.district != null ? contract.owner.district : ''} + ', ' + ${contract.owner.province != null ? contract.owner.province : ''}">........................</span>
                                </p>

                                <p>Số điện thoại: <span id="preview-owner-phone" class="nha-tro-highlight"
                                                        th:text="${contract.owner.phone != null ? contract.owner.phone : '........................'}">........................</span>
                                </p>
                            </div>

                            <div class="mb-3">
                                <p><strong>BÊN THUÊ (Bên B):</strong></p>
                                <p>Họ tên: <span id="preview-tenant-name" class="nha-tro-highlight">........................</span></p>
                                <p>Sinh ngày: <span id="preview-tenant-dob" class="nha-tro-highlight">........................</span></p>
                                <p>Số CMND/CCCD: <span id="preview-tenant-id" class="nha-tro-highlight">........................</span> cấp ngày <span
                                        id="preview-tenant-id-date" class="nha-tro-highlight">........................</span> tại <span
                                        id="preview-tenant-id-place" class="nha-tro-highlight">........................</span></p>
                                <p>Địa chỉ: <span id="preview-tenant-address" class="nha-tro-highlight">........................</span></p>
                                <p>Số điện thoại: <span id="preview-tenant-phone" class="nha-tro-highlight">........................</span></p>
                            </div>

                            <div id="preview-residents-section" style="display: none;" class="mb-3">
                                <p><strong>Danh sách người ở:</strong><br>
                                    <span id="preview-residents"
                                          class="nha-tro-highlight">........................</span>
                                </p>
                            </div>

                            <p>Sau khi bàn bạc trên tinh thần dân chủ, hai bên thống nhất ký kết hợp đồng thuê nhà
                                với các điều khoản sau:</p>

                            <div class="mb-3">
                                <p><strong>Điều 1: Đối tượng hợp đồng</strong></p>
                                <p>Bên A đồng ý cho Bên B thuê căn nhà tại địa chỉ: <span id="preview-room-address"
                                                                                          class="nha-tro-highlight">........................</span>, phòng số <span
                                        id="preview-room-number"
                                        class="nha-tro-highlight">........................</span>, diện tích <span
                                        id="preview-room-area"
                                        class="nha-tro-highlight">........................</span> m².</p>
                            </div>

                            <div class="mb-3">
                                <p><strong>Điều 2: Thời hạn thuê</strong></p>
                                <p>Thời gian thuê: <span id="preview-duration"
                                                         class="nha-tro-highlight">........................</span> tháng, kể từ ngày
                                    <span id="preview-start-date"
                                          class="nha-tro-highlight">........................</span> đến ngày <span
                                            id="preview-end-date"
                                            class="nha-tro-highlight">........................</span>
                                </p>
                            </div>

                            <div class="mb-3">
                                <p><strong>Điều 3: Giá thuê và phương thức thanh toán</strong></p>
                                <p>Giá thuê: <span id="preview-rent"
                                                   class="nha-tro-highlight">........................</span> VNĐ/tháng. Thanh
                                    toán <span id="preview-payment-date"
                                               class="nha-tro-highlight">........................</span> bằng <span
                                            id="preview-payment-method"
                                            class="nha-tro-highlight">........................</span>.</p>
                                <p>Tiền đặt cọc: <span id="preview-deposit"
                                                       class="nha-tro-highlight">........................</span> VNĐ (tương đương
                                    <span id="preview-deposit-months"
                                          class="nha-tro-highlight">........................</span> tháng tiền nhà).
                                </p>
                            </div>

                            <div class="mb-3">
                                <p><strong>Điều 4: Tiện ích và trang thiết bị</strong></p>
                                <p>Phòng được trang bị: <span id="preview-amenities"
                                                              class="nha-tro-highlight">........................</span></p>
                            </div>

                            <div class="mb-3">
                                <p><strong>Điều 5: Trách nhiệm các bên</strong></p>
                                <p>Bên A cam kết giao nhà đúng thời gian và đúng hiện trạng. Bên B có trách nhiệm sử
                                    dụng đúng mục đích, bảo quản tài sản và trả nhà đúng hạn.</p>
                            </div>

                            <div class="mb-3">
                                <p><strong>Điều 6: Điều khoản khác</strong></p>
                                <p><span id="preview-terms"
                                         class="nha-tro-highlight">........................</span></p>
                            </div>

                            <div class="mb-4">
                                <p><strong>Điều 7: Cam kết chung</strong></p>
                                <p>Hai bên cam kết thực hiện đúng các điều khoản. Nếu có tranh chấp, sẽ giải quyết
                                    theo pháp luật Việt Nam.</p>
                            </div>

                            <p class="mb-4">Hợp đồng được lập thành 02 bản, mỗi bên giữ 01 bản và có giá trị pháp lý
                                như nhau.</p>

                            <div class="row text-center mt-5">
                                <div class="col-6">
                                    <p><strong>BÊN CHO THUÊ</strong></p>
                                    <p class="mt-5">(Ký, ghi rõ họ tên)</p>
                                    <p><span id="preview-owner-signature"
                                             class="nha-tro-highlight">........................</span></p>
                                </div>
                                <div class="col-6">
                                    <p><strong>BÊN THUÊ</strong></p>
                                    <p class="mt-5">(Ký, ghi rõ họ tên)</p>
                                    <p><span id="preview-tenant-signature"
                                             class="nha-tro-highlight">........................</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Resident Modal -->
<div class="modal fade" id="addResidentModal" tabindex="-1" aria-labelledby="addResidentModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content nha-tro-host-modal">
            <div class="modal-header nha-tro-host-modal-header">
                <h5 class="modal-title" id="addResidentModalLabel">
                    <i class="fa fa-user-plus me-2"></i>Thêm người ở
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body nha-tro-host-modal-body">
                <div>
                    <h6 class="mb-3">
                        <i class="fa fa-user-plus me-2"></i>Thêm người mới
                    </h6>
                    <form id="addResidentForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="resident-name" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Năm sinh <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="resident-birth-year" min="1900"
                                       max="2024" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="resident-phone">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số CMND/CCCD</label>
                                <input type="text" class="form-control" id="resident-id">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ghi chú</label>
                                <textarea class="form-control" id="resident-notes" rows="2"
                                          placeholder="Ghi chú thêm về người ở..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer nha-tro-host-modal-footer">
                <button type="button" class="btn btn-secondary nha-tro-host-btn-cancel" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Hủy
                </button>
                <button type="button" class="btn btn-success nha-tro-host-btn-save" id="btn-save-resident">
                    <i class="fa fa-check me-1"></i>Thêm người ở
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Amenity Modal -->
<div class="modal fade" id="addAmenityModal-host" tabindex="-1" aria-labelledby="addAmenityModalLabel-host"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content nha-tro-host-modal">
            <div class="modal-header nha-tro-host-modal-header">
                <h5 class="modal-title" id="addAmenityModalLabel-host">
                    <i class="fa fa-plus-circle me-2"></i>Thêm tiện ích mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body nha-tro-host-modal-body">
                <form id="addAmenityForm-host">
                    <div class="mb-3">
                        <label for="amenityName-host" class="form-label">Tên tiện ích</label>
                        <input type="text" class="form-control nha-tro-host-input" id="amenityName-host"
                               placeholder="Nhập tên tiện ích..." required>
                        <div class="invalid-feedback">
                            Vui lòng nhập tên tiện ích
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer nha-tro-host-modal-footer">
                <button type="button" class="btn btn-secondary nha-tro-host-btn-cancel" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary nha-tro-host-btn-save" id="saveAmenity-host">
                    <i class="fa fa-check me-1"></i>Lưu tiện ích
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Customer Modal -->
<div class="modal fade" id="addCustomerModal-host" tabindex="-1" aria-labelledby="addCustomerModalLabel-host"
     aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content nha-tro-host-modal">
            <div class="modal-header nha-tro-host-modal-header">
                <h5 class="modal-title" id="addCustomerModalLabel-host">
                    <i class="fa fa-user-plus me-2"></i>Thêm khách thuê mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body nha-tro-host-modal-body">
                <form id="addCustomerForm-host">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Họ và tên</label>
                            <input type="text" class="form-control nha-tro-host-input" id="newCustomer-name">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" class="form-control nha-tro-host-input" id="newCustomer-dob">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Số CMND/CCCD</label>
                            <input type="text" class="form-control nha-tro-host-input" id="newCustomer-id">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Ngày cấp</label>
                            <input type="date" class="form-control nha-tro-host-input" id="newCustomer-id-date">
                        </div>
                        <div class="col-md-7">
                            <label class="form-label">Nơi cấp</label>
                            <input type="text" class="form-control nha-tro-host-input" id="newCustomer-id-place">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control nha-tro-host-input" id="newCustomer-phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email (tùy chọn)</label>
                            <input type="email" class="form-control nha-tro-host-input" id="newCustomer-email">
                        </div>
                        <div class="col-12">
                            <hr class="my-4">
                            <h6 class="mb-0">
                                <i class="fa fa-users me-2"></i>Mối quan hệ
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mối quan hệ với chủ hợp đồng</label>
                            <select class="form-select nha-tro-host-input" id="newCustomer-relationship">
                                <option value="">Chọn mối quan hệ</option>
                                <option value="chu-hop-dong">Chủ hợp đồng</option>
                                <option value="vo-chong">Vợ/Chồng</option>
                                <option value="con">Con</option>
                                <option value="cha-me">Cha/Mẹ</option>
                                <option value="anh-chi-em">Anh/Chị/Em</option>
                                <option value="ban-be">Bạn bè</option>
                                <option value="dong-nghiep">Đồng nghiệp</option>
                                <option value="nguoi-than">Người thân</option>
                                <option value="khac">Khác</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ghi chú mối quan hệ</label>
                            <input type="text" class="form-control nha-tro-host-input"
                                   id="newCustomer-relationship-note" placeholder="Ghi chú thêm về mối quan hệ...">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tỉnh/Thành phố</label>
                            <select class="form-select nha-tro-host-input" id="newCustomer-province">
                                <option value="">Chọn Tỉnh/Thành phố</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quận/Huyện</label>
                            <select class="form-select nha-tro-host-input" id="newCustomer-district">
                                <option value="">Chọn Quận/Huyện</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phường/Xã</label>
                            <select class="form-select nha-tro-host-input" id="newCustomer-ward">
                                <option value="">Chọn Phường/Xã</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Tên đường/Số nhà</label>
                            <input type="text" class="form-control nha-tro-host-input" id="newCustomer-street">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ảnh CCCD mặt trước</label>
                            <div class="nha-tro-image-upload"
                                 onclick="document.getElementById('newCustomer-cccd-front').click()">
                                <input type="file" id="newCustomer-cccd-front" accept="image/*"
                                       style="display: none;">
                                <div id="newCustomer-cccd-front-preview" class="nha-tro-image-preview">
                                    <i class="fa fa-camera fa-2x"></i>
                                    <div class="mt-2">Tải ảnh mặt trước</div>
                                    <small class="text-muted">Nhấn để chọn ảnh</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ảnh CCCD mặt sau</label>
                            <div class="nha-tro-image-upload"
                                 onclick="document.getElementById('newCustomer-cccd-back').click()">
                                <input type="file" id="newCustomer-cccd-back" accept="image/*"
                                       style="display: none;">
                                <div id="newCustomer-cccd-back-preview" class="nha-tro-image-preview">
                                    <i class="fa fa-camera fa-2x"></i>
                                    <div class="mt-2">Tải ảnh mặt sau</div>
                                    <small class="text-muted">Nhấn để chọn ảnh</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ghi chú (tùy chọn)</label>
                            <textarea class="form-control nha-tro-host-input" id="newCustomer-notes" rows="3"
                                      placeholder="Ghi chú thêm về khách thuê..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer nha-tro-host-modal-footer">
                <button type="button" class="btn btn-secondary nha-tro-host-btn-cancel" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Hủy
                </button>
                <button type="button" class="btn btn-success nha-tro-host-btn-save" id="saveCustomer-host">
                    <i class="fa fa-check me-1"></i>Lưu thông tin
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // CCCD Province Codes Mapping - Move this OUTSIDE the class
    const CCCD_PROVINCE_CODES = {
        "Hà Nội": ["001", "002", "003", "004", "005", "006", "007", "008", "009", "010", "011", "012"],
        "TP. Hồ Chí Minh": ["079", "080", "081", "082", "083", "084", "085", "086", "087", "088", "089", "090"],
        "Hải Phòng": ["031", "032", "033", "034", "035"],
        "Đà Nẵng": ["048", "049"],
        "Cần Thơ": ["065", "066", "067"],
        "An Giang": ["089", "090"],
        "Bà Rịa - Vũng Tàu": ["077", "078"],
        "Bắc Giang": ["024", "025"],
        "Bắc Kạn": ["006"],
        "Bạc Liêu": ["095"],
        "Bắc Ninh": ["027"],
        "Bến Tre": ["075"],
        "Bình Định": ["052"],
        "Bình Dương": ["074"],
        "Bình Phước": ["070"],
        "Bình Thuận": ["060"],
        "Cà Mau": ["096"],
        "Cao Bằng": ["004"],
        "Đắk Lắk": ["062"],
        "Đắk Nông": ["067"],
        "Điện Biên": ["011"],
        "Đồng Nai": ["075"],
        "Đồng Tháp": ["087"],
        "Gia Lai": ["064"],
        "Hà Giang": ["002"],
        "Hà Nam": ["035"],
        "Hà Tĩnh": ["042"],
        "Hải Dương": ["030"],
        "Hậu Giang": ["093"],
        "Hòa Bình": ["017"],
        "Hưng Yên": ["033"],
        "Khánh Hòa": ["058"],
        "Kiên Giang": ["091"],
        "Kon Tum": ["066"],
        "Lai Châu": ["012"],
        "Lâm Đồng": ["068"],
        "Lạng Sơn": ["009"],
        "Lào Cai": ["010"],
        "Long An": ["080"],
        "Nam Định": ["036"],
        "Nghệ An": ["040"],
        "Ninh Bình": ["037"],
        "Ninh Thuận": ["059"],
        "Phú Thọ": ["025"],
        "Phú Yên": ["054"],
        "Quảng Bình": ["044"],
        "Quảng Nam": ["049"],
        "Quảng Ngãi": ["051"],
        "Quảng Ninh": ["022"],
        "Quảng Trị": ["045"],
        "Sóc Trăng": ["094"],
        "Sơn La": ["014"],
        "Tây Ninh": ["072"],
        "Thái Bình": ["034"],
        "Thái Nguyên": ["019"],
        "Thanh Hóa": ["038"],
        "Thừa Thiên Huế": ["046"],
        "Tiền Giang": ["082"],
        "Trà Vinh": ["084"],
        "Tuyên Quang": ["008"],
        "Vĩnh Long": ["086"],
        "Vĩnh Phúc": ["026"],
        "Yên Bái": ["015"]
    };

    // Sample room data for each housing area


    // Handle housing area selection change
    housingAreaSelect.addEventListener('change', function() {
        const selectedArea = this.value;

        // Clear room selection
        roomSelectionSelect.innerHTML = '<option value="">-- Chọn phòng trọ --</option>';

        if (selectedArea && roomData[selectedArea]) {
            // Enable room selection
            roomSelectionSelect.disabled = false;

            // Populate room options
            roomData[selectedArea].forEach(room => {
                const option = document.createElement('option');
                option.value = room.value;
                option.textContent = room.text;
                roomSelectionSelect.appendChild(option);
            });
        } else {
            // Disable room selection if no area selected
            roomSelectionSelect.disabled = true;
            // Clear form fields
            document.getElementById('room-number').value = '';
            document.getElementById('room-area').value = '';
            document.getElementById('rent-price').value = '';

            // Update preview
            if (window.NhaTroContract) {
                window.NhaTroContract.updatePreviewField('room-number', 'preview-room-number');
                window.NhaTroContract.updatePreviewField('room-area', 'preview-room-area');
                window.NhaTroContract.updatePreviewField('rent-price', 'preview-rent');
            }
        }
    });

    // Handle room selection change
    roomSelectionSelect.addEventListener('change', function() {
        const selectedArea = housingAreaSelect.value;
        const selectedRoomValue = this.value;

        if (selectedArea && selectedRoomValue && roomData[selectedArea]) {
            // Find the selected room data
            const selectedRoom = roomData[selectedArea].find(room => room.value === selectedRoomValue);

            if (selectedRoom) {
                // Auto-fill room information
                document.getElementById('room-number').value = selectedRoom.number;
                document.getElementById('room-area').value = selectedRoom.area;
                document.getElementById('rent-price').value = selectedRoom.price;

                // Update contract preview using the existing NhaTroContract methods
                if (window.NhaTroContract) {
                    // Update preview fields with highlight effect
                    window.NhaTroContract.updatePreviewField('room-number', 'preview-room-number');
                    window.NhaTroContract.updatePreviewField('room-area', 'preview-room-area');
                    window.NhaTroContract.updatePreviewField('rent-price', 'preview-rent');

                    // Recalculate deposit based on new rent price
                    window.NhaTroContract.calculateDeposit();

                    // Show notification
                    window.NhaTroContract.showNotification(
                        `Đã chọn ${selectedRoom.number} - Diện tích: ${selectedRoom.area}m² - Giá: ${new Intl.NumberFormat('vi-VN').format(selectedRoom.price)} VNĐ/tháng`,
                        'success'
                    );
                }
            }
        } else {
            // Clear fields if no room selected
            document.getElementById('room-number').value = '';
            document.getElementById('room-area').value = '';
            document.getElementById('rent-price').value = '';

            // Update preview
            if (window.NhaTroContract) {
                window.NhaTroContract.updatePreviewField('room-number', 'preview-room-number');
                window.NhaTroContract.updatePreviewField('room-area', 'preview-room-area');
                window.NhaTroContract.updatePreviewField('rent-price', 'preview-rent');
                window.NhaTroContract.calculateDeposit();
            }
        }
    });

</script>

<script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/contract.js}"></script>
</body>

</html>
