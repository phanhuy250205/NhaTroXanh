<!DOCTYPE html>
<html lang="en">

<head>
    <!-- ICON -->
    <link rel="icon" th:href="@{/images/logo/nhatroxanh(title).png}" type="image/x-icon">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/bootstrap/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/host.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">

    <!-- Validation Styles -->
    <style>
        /* Validation Styles */
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .invalid-feedback {
            display: block !important;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
            font-weight: 500;
        }

        .invalid-feedback i {
            margin-right: 0.25rem;
        }

        /* Error animation */
        .is-invalid {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Validation summary styles */
        #validation-summary {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tab with errors indicator */
        .nav-link.has-errors {
            position: relative;
        }

        .nav-link.has-errors::after {
            content: "";
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: #dc3545;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Success message styles */
        .alert-success {
            border-left: 4px solid #28a745;
            animation: slideDown 0.3s ease-out;
        }

        /* Loading button styles */
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Form field focus styles */
        .form-control:focus,
        .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Error field focus override */
        .form-control.is-invalid:focus,
        .form-select.is-invalid:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        /* Responsive error messages */
        @media (max-width: 768px) {
            .invalid-feedback {
                font-size: 0.8em;
            }

            #validation-summary {
                font-size: 0.9em;
            }
        }

        /* Terms list styles */
        .terms-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #f8f9fa;
        }

        .term-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: all 0.2s ease;
        }

        .term-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.1);
        }

        .term-content {
            flex: 1;
            margin-right: 0.75rem;
            line-height: 1.4;
        }

        .term-number {
            font-weight: 600;
            color: #007bff;
            margin-right: 0.5rem;
        }

        .term-text {
            color: #495057;
        }

        .term-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-term-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }

        .empty-terms {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        /* Input group for adding terms */
        .add-term-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .add-term-input {
            resize: vertical;
            min-height: 80px;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <!-- <div th:replace="~{/layouts/sidebar-host}"></div> -->

    <!-- Main Content -->
    <div class="nha-tro-main-content">
        <div class="nha-tro-header">
            <h5>
                <a href="javascript:history.back()" class="nha-tro-back-btn">
                    <i class="fa fa-arrow-left"></i>
                </a>
                Tạo hợp đồng thuê nhà
            </h5>
            <hr>
        </div>

        <div class="container-fluid mt-4">
            <div class="row mt-3">
                <!-- Form Column -->
                <div class="col-lg-7">
                    <form th:action="@{/api/contracts}" method="post" enctype="multipart/form-data"
                        th:object="${contract}" novalidate id="contractForm">

                        <!-- Basic Info Card -->
                        <div class="card nha-tro-card mb-3">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">
                                            Số điện thoại <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" placeholder="Số điện thoại người thuê"
                                            id="tenant-phone" required pattern="[0-9]{10}" maxlength="10">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">
                                            Ngày lập hợp đồng <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" name="contractDate" id="contract-date"
                                            required
                                            th:value="${contract.contractDate != null} ? ${#temporals.format(contract.contractDate, 'yyyy-MM-dd')} : ''">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">
                                            Trạng thái <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" name="status" id="contract-status" required
                                            th:value="${contract.status}">
                                            <option value="">Trạng thái</option>
                                            <option value="active" th:selected="${contract.status == 'active'}">Đang
                                                hiệu lực</option>
                                            <option value="expired" th:selected="${contract.status == 'expired'}">Hết
                                                hiệu lực</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs Navigation -->
                        <ul class="nav nav-tabs nha-tro-tabs" id="contractTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-tab="tenantInfo" href="#tenantInfo">
                                    <i class="fa fa-user me-2"></i> Người thuê
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-tab="ownerInfo" href="#ownerInfo">
                                    <i class="fa fa-id-card me-2"></i> Chủ trọ
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-tab="roomInfo" href="#roomInfo">
                                    <i class="fa fa-house me-2"></i> Nhà trọ
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-tab="terms" href="#terms">
                                    <i class="fa fa-file-contract me-2"></i> Điều khoản
                                </a>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content card p-4 nha-tro-tab-content" style="border-radius: 0px;">
                            <!-- Tenant Info Tab -->
                            <div class="tab-pane fade show active" id="tenantInfo">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Thông tin người thuê</h6>
                                    <button type="button"
                                        class="btn btn-outline-success btn-sm nha-tro-host-btn-add-customer"
                                        id="btn-add-customer-host" data-bs-toggle="modal" data-bs-target="#addCustomerModal-host">
                                        <i class="fa fa-user-plus me-1"></i> Thêm khách mới
                                    </button>
                                </div>
                                <hr class="mb-4">

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Họ và tên <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="tenant-name" required
                                            placeholder="Nhập họ và tên">
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">
                                            Ngày sinh <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" id="tenant-dob" required
                                            max="2006-12-31">
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">
                                            Số CMND/CCCD <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="tenant-id" required
                                            pattern="[0-9]{12}" maxlength="12" placeholder="12 chữ số">
                                    </div>

                                    <div class="col-md-5">
                                        <label class="form-label">
                                            Ngày cấp <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" id="tenant-id-date" required>
                                    </div>

                                    <div class="col-md-7">
                                        <label class="form-label">
                                            Nơi cấp <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="tenant-id-place" required
                                            placeholder="Nơi cấp CMND/CCCD">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">
                                            Tỉnh/Thành phố <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="tenant-province">
                                            <option value="">Tỉnh/Thành phố</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">
                                            Quận/Huyện <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="tenant-district">
                                        <option value="">Quận/Huyện</option>
                                    </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">
                                            Phường/Xã <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="tenant-ward">
                                            <option value="">Phường/Xã</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Tên đường/Số nhà <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="tenant-street" required
                                            placeholder="Số nhà, tên đường">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Email (nếu có)</label>
                                        <input type="email" class="form-control" id="tenant-email"
                                            pattern=".*@gmail\.com$" placeholder="example@gmail.com">
                                    </div>

                                    <!-- CCCD Images -->
                                    <div class="col-md-6">
                                        <label class="form-label">Ảnh CCCD mặt trước</label>
                                        <div class="nha-tro-image-upload"
                                            onclick="document.getElementById('cccd-front').click()">
                                            <input type="file" id="cccd-front" accept="image/*" style="display: none;">
                                            <div id="cccd-front-preview" class="nha-tro-image-preview">
                                                <i class="fa fa-camera fa-2x"></i>
                                                <div class="mt-2">Tải ảnh mặt trước</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Ảnh CCCD mặt sau</label>
                                        <div class="nha-tro-image-upload"
                                            onclick="document.getElementById('cccd-back').click()">
                                            <input type="file" id="cccd-back" accept="image/*" style="display: none;">
                                            <div id="cccd-back-preview" class="nha-tro-image-preview">
                                                <i class="fa fa-camera fa-2x"></i>
                                                <div class="mt-2">Tải ảnh mặt sau</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end mt-4">
                                    <button type="button" class="btn btn-primary nha-tro-btn-next" id="btn-next-owner">
                                        Tiếp tục <i class="fa fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Owner Info Tab -->
                            <div class="tab-pane fade" id="ownerInfo">
                                <h6 class="mb-3">Thông tin chủ trọ</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Họ và tên <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" th:field="*{owner.fullName}" required
                                            placeholder="Nhập họ và tên">
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">
                                            Ngày sinh <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" th:field="*{owner.birthday}" required>
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">
                                            Số CMND/CCCD <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" th:field="*{owner.id}" required
                                            pattern="[0-9]{12}" maxlength="12" placeholder="12 chữ số">
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">
                                            Ngày cấp <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" th:field="*{owner.issueDate}" required>
                                    </div>

                                    <div class="col-md-9">
                                        <label class="form-label">
                                            Nơi cấp <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" th:field="*{owner.issuePlace}" required
                                            placeholder="Nơi cấp CMND/CCCD">
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Tỉnh/Thành phố</label>
                                        <select class="form-select" th:field="*{owner.province}" id="owner-province">
                                            <option value="">Tỉnh/Thành phố</option>
                                            <option th:value="${contract.owner.province}"
                                                th:text="${contract.owner.province}"
                                                th:unless="${contract.owner.province == null}">
                                                [[${contract.owner.province}]]
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Quận/Huyện</label>
                                        <select class="form-select" th:field="*{owner.district}" id="owner-district">
                                            <option value="">Quận/Huyện</option>
                                            <option th:value="${contract.owner.district}"
                                                th:text="${contract.owner.district}"
                                                th:unless="${contract.owner.district == null}">
                                                [[${contract.owner.district}]]
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Phường/Xã</label>
                                        <select class="form-select" th:field="*{owner.ward}" id="owner-ward">
                                            <option value="">Phường/Xã</option>
                                            <option th:value="${contract.owner.ward}" th:text="${contract.owner.ward}"
                                                th:unless="${contract.owner.ward == null}">
                                                [[${contract.owner.ward}]]
                                            </option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Tên đường/Số nhà</label>
                                        <input type="text" class="form-control" th:field="*{owner.street}"
                                            th:value="${contract.owner.street != null ? contract.owner.street : ''}"
                                            placeholder="Số nhà, tên đường">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Email (nếu có)</label>
                                        <input type="email" class="form-control" th:field="*{owner.email}"
                                            pattern=".*@gmail\.com$" placeholder="example@gmail.com">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Số điện thoại <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" th:field="*{owner.phone}" required
                                            pattern="[0-9]{10}" maxlength="10" placeholder="10 chữ số">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Tài khoản ngân hàng (nếu có)</label>
                                        <input type="text" class="form-control" th:field="*{owner.bankAccount}"
                                            placeholder="Số tài khoản ngân hàng">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-secondary" id="btn-prev-tenant">
                                        <i class="fa fa-arrow-left me-1"></i> Quay lại
                                    </button>
                                    <button type="button" class="btn btn-primary nha-tro-btn-next" id="btn-next-room">
                                        Tiếp tục <i class="fa fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Room Info Tab -->
                            <div class="tab-pane fade" id="roomInfo">
                                <h6 class="mb-3">Thông tin nhà trọ</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            
                                            <i class="fa fa-building me-1"></i>Chọn khu trọ <span
                                                class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="hostelId" onchange="filterRooms()" required>
                                            <option value="">-- Chọn khu trọ --</option>
                                            <option th:each="hostel : ${hostels}" th:value="${hostel.hostelId}"
                                                th:text="${hostel.name}"
                                                th:selected="${hostel.hostelId == contract.room?.hostelId}"></option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label" th:fragment="roomSelect">
                                            <i class="fa fa-door-open me-1"></i>Chọn phòng trọ <span
                                                class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="roomId" name="room.roomId"
                                            th:class="${#fields.hasErrors('room.roomId')} ? 'form-control is-invalid' : 'form-control'"
                                            required>
                                            <option value="">-- Chọn phòng trọ --</option>
                                            <option th:each="room : ${rooms}" th:value="${room.roomId}"
                                                th:text="${room.roomName} + ' (' + room.address + ')'"
                                                th:data-hostel-id="${room.hostelId}"></option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Tỉnh/Thành phố</label>
                                        <select class="form-select" id="room-province">
                                            <option value="">Tỉnh/Thành phố</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Quận/Huyện</label>
                                        <select class="form-select" id="room-district">
                                            <option value="">Quận/Huyện</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Phường/Xã</label>
                                        <select class="form-select" id="room-ward">
                                            <option value="">Phường/Xã</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Tên đường/Số nhà</label>
                                        <input type="text" class="form-control" id="room-street">
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">Số phòng</label>
                                        <input type="text" class="form-control" id="room-number">
                                    </div>

                                    <div class="col-md-3">
                                        <label class="form-label">Diện tích (m²)</label>
                                        <input type="number" class="form-control" id="room-area">
                                    </div>

                                    <!-- Residents Section -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <label class="form-label mb-0">
                                                <i class="fa fa-users me-2"></i>Số người ở
                                                <span class="badge bg-primary ms-2" id="residents-count">0</span>
                                            </label>
                                            <button type="button"
                                                class="btn btn-outline-primary btn-sm nha-tro-host-btn-add-resident"
                                                id="btn-add-resident" data-bs-toggle="modal" data-bs-target="#addResidentModal">
                                                <i class="fa fa-user-plus me-1"></i> Thêm người ở
                                            </button>
                                        </div>
                                        <div id="residents-list" class="nha-tro-residents-container">
                                            <div class="text-center text-muted py-4" id="no-residents-message">
                                                <i class="fa fa-users fa-2x mb-2"></i>
                                                <p>Chưa có người ở nào được thêm</p>
                                                <small>Nhấn "Thêm người ở" để bắt đầu</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Amenities Section -->
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label">Tiện ích</label>
                                            <button type="button"
                                                class="btn btn-outline-primary btn-sm nha-tro-host-btn-add-amenity"
                                                id="btn-add-amenity-host" data-bs-toggle="modal" data-bs-target="#addAmenityModal-host">
                                                <i class="fa fa-plus me-1"></i> Thêm tiện ích
                                            </button>
                                        </div>
                                        <div class="nha-tro-amenities" id="amenities-list-host">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="wifi">
                                                <label class="form-check-label" for="wifi">Wifi</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="ac">
                                                <label class="form-check-label" for="ac">Máy lạnh</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="fridge">
                                                <label class="form-check-label" for="fridge">Tủ lạnh</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="kitchen">
                                                <label class="form-check-label" for="kitchen">Bếp</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="parking">
                                                <label class="form-check-label" for="parking">Chỗ để xe</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="security">
                                                <label class="form-check-label" for="security">Camera an ninh</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label">Ghi chú</label>
                                        <textarea class="form-control" rows="3" id="room-notes"></textarea>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button type="button" class="btn btn-secondary" id="btn-prev-owner">
                                        <i class="fa fa-arrow-left me-1"></i> Quay lại
                                    </button>
                                    <button type="button" class="btn btn-primary nha-tro-btn-next" id="btn-next-terms">
                                        Tiếp tục <i class="fa fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Terms Tab -->
                            <!-- Terms Tab -->
                            <div class="tab-pane fade" id="terms">
                                <h6 class="mb-3">Điều khoản & Thanh toán</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Giá thuê hàng tháng (VND) <span class="text-danger">*</span>
                                        </label>
                                        <input type="number" class="form-control" id="rent-price" required min="1"
                                            placeholder="Nhập giá thuê">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Phương thức thanh toán <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="payment-method" required>
                                            <option value="">Chọn phương thức</option>
                                            <option value="cash">Tiền mặt</option>
                                            <option value="transfer">Chuyển khoản</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Ngày thanh toán hàng tháng <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="payment-date" required
                                            placeholder="Ví dụ: Ngày 5 hằng tháng">
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Thời hạn hợp đồng <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" value="0" id="contract-duration"
                                                required min="1" placeholder="Số tháng">
                                            <span class="input-group-text">Tháng</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">
                                            Ngày bắt đầu HĐ <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" id="start-date" required>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Đặt cọc trước</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" value="2" id="deposit-months"
                                                min="0">
                                            <span class="input-group-text">tháng tiền nhà</span>
                                        </div>
                                    </div>

                                    <!-- Improved Terms Section -->
                                    <div class="col-12">
                                        <label class="form-label">
                                            <i class="fa fa-list-ul me-2"></i>Điều khoản chung
                                            <span class="badge bg-primary ms-2" id="terms-count">0</span>
                                        </label>
                                        
                                        <!-- Add Term Container -->
                                        <div class="add-term-container">
                                            <div class="row g-2">
                                                <div class="col-12">
                                                    <textarea class="form-control add-term-input" 
                                                        id="new-term-input" 
                                                        placeholder="Nhập điều khoản mới (ví dụ: Bên B không được nuôi thú cưng trong phòng trọ)"
                                                        rows="3"></textarea>
                                                </div>
                                                <div class="col-12 text-end">
                                                    <button type="button" class="btn btn-primary btn-sm" id="btn-add-term">
                                                        <i class="fa fa-plus me-1"></i>Thêm điều khoản
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Terms List -->
                                        <div class="terms-list" id="terms-list">
                                            <div class="empty-terms" id="empty-terms-message">
                                                <i class="fa fa-file-contract fa-2x mb-2 text-muted"></i>
                                                <p class="mb-0">Chưa có điều khoản nào</p>
                                                <small>Nhập điều khoản ở trên và nhấn "Thêm điều khoản"</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-start mt-4">
                                    <button type="button" class="btn btn-secondary" id="btn-prev-room">
                                        <i class="fa fa-arrow-left me-1"></i> Quay lại
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
                            <button type="button" class="btn btn-outline-info flex-fill" id="btn-update">
                                <i class="fa fa-pen-to-square me-1"></i> Cập nhật hợp đồng
                            </button>

                            <button type="button" class="btn btn-success flex-fill" id="btn-print">
                                <i class="fa fa-print me-1"></i> In hợp đồng
                            </button>

                            <button type="button" class="btn nha-tro-btn-purple flex-fill" id="btn-save">
                                <i class="fa fa-floppy-disk me-1"></i> Lưu hợp đồng
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Preview Column -->
                <div class="col-lg-5">
                    <div class="card nha-tro-contract-preview">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <strong>Xem trước hợp đồng</strong>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" id="btn-zoom-out" title="Thu nhỏ">
                                    <i class="fa fa-minus"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="btn-zoom-in" title="Phóng to">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <button class="btn btn-outline-secondary" id="btn-reset-zoom" title="Kích thước gốc">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body nha-tro-preview-content" id="contract-preview">
                            <div id="preview-container"
                                style="transform-origin: top left; transition: transform 0.3s ease;">
                                <div class="text-center mb-4">
                                    <p><strong>CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM<br>Độc lập - Tự do - Hạnh
                                            phúc</strong></p>
                                    <p><strong>HỢP ĐỒNG THUÊ NHÀ</strong></p>
                                </div>

                                <p>Hôm nay, ngày <span id="preview-sign-date"
                                        class="nha-tro-highlight">........................</span>, chúng tôi gồm:</p>

                                <div class="mb-3">
                                    <p><strong>BÊN CHO THUÊ (Bên A):</strong> <span id="preview-owner-name"
                                            class="nha-tro-highlight">........................</span>
                                    </p>
                                    <p>Sinh ngày: <span id="preview-owner-dob" class="nha-tro-highlight">........................</span>
                                    </p>
                                    <p>Số CMND/CCCD: <span id="preview-owner-id" class="nha-tro-highlight">........................</span>
                                        cấp ngày <span id="preview-owner-id-date" class="nha-tro-highlight">........................</span>
                                        tại <span id="preview-owner-id-place" class="nha-tro-highlight">........................</span>
                                    </p>
                                    <p>Địa chỉ: <span id="preview-owner-address" class="nha-tro-highlight">........................</span>
                                    </p>
                                    <p>Số điện thoại: <span id="preview-owner-phone" class="nha-tro-highlight">........................</span>
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <p><strong>BÊN THUÊ (Bên B):</strong></p>
                                    <p>Họ tên: <span id="preview-tenant-name"
                                            class="nha-tro-highlight">........................</span></p>
                                    <p>Sinh ngày: <span id="preview-tenant-dob"
                                            class="nha-tro-highlight">........................</span></p>
                                    <p>Số CMND/CCCD: <span id="preview-tenant-id"
                                            class="nha-tro-highlight">........................</span> cấp ngày <span
                                            id="preview-tenant-id-date"
                                            class="nha-tro-highlight">........................</span> tại <span
                                            id="preview-tenant-id-place"
                                            class="nha-tro-highlight">........................</span></p>
                                    <p>Địa chỉ: <span id="preview-tenant-address"
                                            class="nha-tro-highlight">........................</span></p>
                                    <p>Số điện thoại: <span id="preview-tenant-phone"
                                            class="nha-tro-highlight">........................</span></p>
                                </div>

                                <div id="preview-residents-section" style="display: none;" class="mb-3">
                                    <p><strong>Danh sách người ở:</strong><br>
                                        <span id="preview-residents"
                                            class="nha-tro-highlight">........................</span>
                                    </p>
                                </div>

                                <p>Sau khi bàn bạc trên tinh thần dân chủ, hai bên thống nhất ký kết hợp đồng thuê nhà
                                    với các điều khoản sau:</p>

                                <div class="mb-3">
                                    <p><strong>Điều 1: Đối tượng hợp đồng</strong></p>
                                    <p>Bên A đồng ý cho Bên B thuê căn nhà tại địa chỉ: <span id="preview-room-address"
                                            class="nha-tro-highlight">........................</span>, phòng số <span
                                            id="preview-room-number"
                                            class="nha-tro-highlight">........................</span>, diện tích <span
                                            id="preview-room-area"
                                            class="nha-tro-highlight">........................</span> m².</p>
                                </div>

                                <div class="mb-3">
                                    <p><strong>Điều 2: Thời hạn thuê</strong></p>
                                    <p>Thời gian thuê: <span id="preview-duration"
                                            class="nha-tro-highlight">........................</span> tháng, kể từ ngày
                                        <span id="preview-start-date"
                                            class="nha-tro-highlight">........................</span> đến ngày <span
                                            id="preview-end-date"
                                            class="nha-tro-highlight">........................</span>
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <p><strong>Điều 3: Giá thuê và phương thức thanh toán</strong></p>
                                    <p>Giá thuê: <span id="preview-rent"
                                            class="nha-tro-highlight">........................</span> VNĐ/tháng. Thanh
                                        toán <span id="preview-payment-date"
                                            class="nha-tro-highlight">........................</span> bằng <span
                                            id="preview-payment-method"
                                            class="nha-tro-highlight">........................</span>.</p>
                                    <p>Tiền đặt cọc: <span id="preview-deposit"
                                            class="nha-tro-highlight">........................</span> VNĐ (tương đương
                                        <span id="preview-deposit-months"
                                            class="nha-tro-highlight">........................</span> tháng tiền nhà).
                                    </p>
                                </div>

                                <div class="mb-3">
                                    <p><strong>Điều 4: Tiện ích và trang thiết bị</strong></p>
                                    <p>Phòng được trang bị: <span id="preview-amenities"
                                            class="nha-tro-highlight">........................</span></p>
                                </div>

                                <div class="mb-3">
                                    <p><strong>Điều 5: Trách nhiệm các bên</strong></p>
                                    <p>Bên A cam kết giao nhà đúng thời gian và đúng hiện trạng. Bên B có trách nhiệm sử
                                        dụng đúng mục đích, bảo quản tài sản và trả nhà đúng hạn.</p>
                                </div>

                                <!-- Updated Terms Preview Section -->
                                <div class="mb-3">
                                    <p><strong>Điều 6: Điều khoản khác</strong></p>
                                    <div id="preview-terms-list">
                                        <p class="text-muted fst-italic">Chưa có điều khoản nào được thêm</p>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <p><strong>Điều 7: Cam kết chung</strong></p>
                                    <p>Hai bên cam kết thực hiện đúng các điều khoản. Nếu có tranh chấp, sẽ giải quyết
                                        theo pháp luật Việt Nam.</p>
                                </div>

                                <p class="mb-4">Hợp đồng được lập thành 02 bản, mỗi bên giữ 01 bản và có giá trị pháp lý
                                    như nhau.</p>

                                <div class="row text-center mt-5">
                                    <div class="col-6">
                                        <p><strong>BÊN CHO THUÊ</strong></p>
                                        <p class="mt-5">(Ký, ghi rõ họ tên)</p>
                                        <p><span id="preview-owner-signature"
                                                class="nha-tro-highlight">........................</span></p>
                                    </div>
                                    <div class="col-6">
                                        <p><strong>BÊN THUÊ</strong></p>
                                        <p class="mt-5">(Ký, ghi rõ họ tên)</p>
                                        <p><span id="preview-tenant-signature"
                                                class="nha-tro-highlight">........................</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Resident Modal -->
    <div class="modal fade" id="addResidentModal" tabindex="-1" aria-labelledby="addResidentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content nha-tro-host-modal">
                <div class="modal-header nha-tro-host-modal-header">
                    <h5 class="modal-title" id="addResidentModalLabel">
                        <i class="fa fa-user-plus me-2"></i>Thêm người ở
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body nha-tro-host-modal-body">
                    <div>
                        <h6 class="mb-3">
                            <i class="fa fa-user-plus me-2"></i>Thêm người mới
                        </h6>
                        <form id="addResidentForm">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="resident-name" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Năm sinh <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="resident-birth-year" min="1900"
                                        max="2024" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="resident-phone">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Số CMND/CCCD</label>
                                    <input type="text" class="form-control" id="resident-id">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="resident-notes" rows="2"
                                        placeholder="Ghi chú thêm về người ở..."></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer nha-tro-host-modal-footer">
                    <button type="button" class="btn btn-secondary nha-tro-host-btn-cancel" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-success nha-tro-host-btn-save" id="btn-save-resident">
                        <i class="fa fa-check me-1"></i>Thêm người ở
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Amenity Modal -->
    <div class="modal fade" id="addAmenityModal-host" tabindex="-1" aria-labelledby="addAmenityModalLabel-host"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content nha-tro-host-modal">
                <div class="modal-header nha-tro-host-modal-header">
                    <h5 class="modal-title" id="addAmenityModalLabel-host">
                        <i class="fa fa-plus-circle me-2"></i>Thêm tiện ích mới
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body nha-tro-host-modal-body">
                    <form id="addAmenityForm-host">
                        <div class="mb-3">
                            <label for="amenityName-host" class="form-label">Tên tiện ích</label>
                            <input type="text" class="form-control nha-tro-host-input" id="amenityName-host"
                                placeholder="Nhập tên tiện ích..." required>
                            <div class="invalid-feedback">
                                Vui lòng nhập tên tiện ích
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer nha-tro-host-modal-footer">
                    <button type="button" class="btn btn-secondary nha-tro-host-btn-cancel" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-primary nha-tro-host-btn-save" id="saveAmenity-host">
                        <i class="fa fa-check me-1"></i>Lưu tiện ích
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Customer Modal -->
    <div class="modal fade" id="addCustomerModal-host" tabindex="-1" aria-labelledby="addCustomerModalLabel-host"
        aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content nha-tro-host-modal">
                <div class="modal-header nha-tro-host-modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel-host">
                        <i class="fa fa-user-plus me-2"></i>Thêm khách thuê mới
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body nha-tro-host-modal-body">
                    <form id="addCustomerForm-host">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Họ và tên</label>
                                <input type="text" class="form-control nha-tro-host-input" id="newCustomer-name">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ngày sinh</label>
                                <input type="date" class="form-control nha-tro-host-input" id="newCustomer-dob">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Số CMND/CCCD</label>
                                <input type="text" class="form-control nha-tro-host-input" id="newCustomer-id">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Ngày cấp</label>
                                <input type="date" class="form-control nha-tro-host-input" id="newCustomer-id-date">
                            </div>
                            <div class="col-md-7">
                                <label class="form-label">Nơi cấp</label>
                                <input type="text" class="form-control nha-tro-host-input" id="newCustomer-id-place">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control nha-tro-host-input" id="newCustomer-phone">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email (tùy chọn)</label>
                                <input type="email" class="form-control nha-tro-host-input" id="newCustomer-email">
                            </div>
                            <div class="col-12">
                                <hr class="my-4">
                                <h6 class="mb-0">
                                    <i class="fa fa-users me-2"></i>Mối quan hệ
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Mối quan hệ với chủ hợp đồng</label>
                                <select class="form-select nha-tro-host-input" id="newCustomer-relationship">
                                    <option value="">Chọn mối quan hệ</option>
                                    <option value="chu-hop-dong">Chủ hợp đồng</option>
                                    <option value="vo-chong">Vợ/Chồng</option>
                                    <option value="con">Con</option>
                                    <option value="cha-me">Cha/Mẹ</option>
                                    <option value="anh-chi-em">Anh/Chị/Em</option>
                                    <option value="ban-be">Bạn bè</option>
                                    <option value="dong-nghiep">Đồng nghiệp</option>
                                    <option value="nguoi-than">Người thân</option>
                                    <option value="khac">Khác</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ghi chú mối quan hệ</label>
                                <input type="text" class="form-control nha-tro-host-input"
                                    id="newCustomer-relationship-note" placeholder="Ghi chú thêm về mối quan hệ...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tỉnh/Thành phố</label>
                                <select class="form-select nha-tro-host-input" id="newCustomer-province">
                                    <option value="">Chọn Tỉnh/Thành phố</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quận/Huyện</label>
                                <select class="form-select nha-tro-host-input" id="newCustomer-district">
                                    <option value="">Chọn Quận/Huyện</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Phường/Xã</label>
                                <select class="form-select nha-tro-host-input" id="newCustomer-ward">
                                    <option value="">Chọn Phường/Xã</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Tên đường/Số nhà</label>
                                <input type="text" class="form-control nha-tro-host-input" id="newCustomer-street">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ảnh CCCD mặt trước</label>
                                <div class="nha-tro-image-upload"
                                    onclick="document.getElementById('newCustomer-cccd-front').click()">
                                    <input type="file" id="newCustomer-cccd-front" accept="image/*"
                                        style="display: none;">
                                    <div id="newCustomer-cccd-front-preview" class="nha-tro-image-preview">
                                        <i class="fa fa-camera fa-2x"></i>
                                        <div class="mt-2">Tải ảnh mặt trước</div>
                                        <small class="text-muted">Nhấn để chọn ảnh</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ảnh CCCD mặt sau</label>
                                <div class="nha-tro-image-upload"
                                    onclick="document.getElementById('newCustomer-cccd-back').click()">
                                    <input type="file" id="newCustomer-cccd-back" accept="image/*"
                                        style="display: none;">
                                    <div id="newCustomer-cccd-back-preview" class="nha-tro-image-preview">
                                        <i class="fa fa-camera fa-2x"></i>
                                        <div class="mt-2">Tải ảnh mặt sau</div>
                                        <small class="text-muted">Nhấn để chọn ảnh</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Ghi chú (tùy chọn)</label>
                                <textarea class="form-control nha-tro-host-input" id="newCustomer-notes" rows="3"
                                    placeholder="Ghi chú thêm về khách thuê..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer nha-tro-host-modal-footer">
                    <button type="button" class="btn btn-secondary nha-tro-host-btn-cancel" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-success nha-tro-host-btn-save" id="saveCustomer-host">
                        <i class="fa fa-check me-1"></i>Lưu thông tin
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CCCD Province Codes Mapping - Move this OUTSIDE the class
        const CCCD_PROVINCE_CODES = {
            "Hà Nội": ["001", "002", "003", "004", "005", "006", "007", "008", "009", "010", "011", "012"],
            "TP. Hồ Chí Minh": ["079", "080", "081", "082", "083", "084", "085", "086", "087", "088", "089", "090"],
            "Hải Phòng": ["031", "032", "033", "034", "035"],
            "Đà Nẵng": ["048", "049"],
            "Cần Thơ": ["065", "066", "067"],
            "An Giang": ["089", "090"],
            "Bà Rịa - Vũng Tàu": ["077", "078"],
            "Bắc Giang": ["024", "025"],
            "Bắc Kạn": ["006"],
            "Bạc Liêu": ["095"],
            "Bắc Ninh": ["027"],
            "Bến Tre": ["075"],
            "Bình Định": ["052"],
            "Bình Dương": ["074"],
            "Bình Phước": ["070"],
            "Bình Thuận": ["060"],
            "Cà Mau": ["096"],
            "Cao Bằng": ["004"],
            "Đắk Lắk": ["062"],
            "Đắk Nông": ["067"],
            "Điện Biên": ["011"],
            "Đồng Nai": ["075"],
            "Đồng Tháp": ["087"],
            "Gia Lai": ["064"],
            "Hà Giang": ["002"],
            "Hà Nam": ["035"],
            "Hà Tĩnh": ["042"],
            "Hải Dương": ["030"],
            "Hậu Giang": ["093"],
            "Hòa Bình": ["017"],
            "Hưng Yên": ["033"],
            "Khánh Hòa": ["058"],
            "Kiên Giang": ["091"],
            "Kon Tum": ["066"],
            "Lai Châu": ["012"],
            "Lâm Đồng": ["068"],
            "Lạng Sơn": ["009"],
            "Lào Cai": ["010"],
            "Long An": ["080"],
            "Nam Định": ["036"],
            "Nghệ An": ["040"],
            "Ninh Bình": ["037"],
            "Ninh Thuận": ["059"],
            "Phú Thọ": ["025"],
            "Phú Yên": ["054"],
            "Quảng Bình": ["044"],
            "Quảng Nam": ["049"],
            "Quảng Ngãi": ["051"],
            "Quảng Ninh": ["022"],
            "Quảng Trị": ["045"],
            "Sóc Trăng": ["094"],
            "Sơn La": ["014"],
            "Tây Ninh": ["072"],
            "Thái Bình": ["034"],
            "Thái Nguyên": ["019"],
            "Thanh Hóa": ["038"],
            "Thừa Thiên Huế": ["046"],
            "Tiền Giang": ["082"],
            "Trà Vinh": ["084"],
            "Tuyên Quang": ["008"],
            "Vĩnh Long": ["086"],
            "Vĩnh Phúc": ["026"],
            "Yên Bái": ["015"]
        };

        // Contract Form Validation
        class ContractValidator {
            constructor() {
                this.initializeValidation()
            }

            initializeValidation() {
                // Add event listeners for update and save buttons
                document.getElementById("btn-update")?.addEventListener("click", (e) => {
                    e.preventDefault()
                    this.validateForm("update")
                })

                document.getElementById("btn-save")?.addEventListener("click", (e) => {
                    e.preventDefault()
                    this.validateForm("save")
                })

                // Real-time validation on input blur
                this.addRealTimeValidation()
            }

            validateForm(action) {
                let isValid = true

                // Clear all previous errors
                this.clearAllErrors()

                // Validate each section
                const tenantValid = this.validateTenantInfo()
                const ownerValid = this.validateOwnerInfo()
                const roomValid = this.validateRoomInfo()
                const termsValid = this.validateTerms()

                isValid = tenantValid && ownerValid && roomValid && termsValid

                if (isValid) {
                    if (action === "save") {
                        this.submitForm()
                    } else if (action === "update") {
                        this.updateContract()
                    }
                } else {
                    // Show first tab with errors
                    this.showFirstErrorTab()
                    this.showValidationSummary()
                }

                return isValid
            }

            validateTenantInfo() {
                let isValid = true

                // Validate tenant phone
                const tenantPhone = document.getElementById("tenant-phone");
                if (tenantPhone.value && !this.validatePhone(tenantPhone.value)) {
                    this.showError(tenantPhone, "Số điện thoại phải có đúng 10 chữ số và bắt đầu bằng số 0");
                    isValid = false;
                }

                // Validate tenant name
                const tenantName = document.getElementById("tenant-name")
                if (!this.validateRequired(tenantName.value)) {
                    this.showError(tenantName, "Họ và tên là bắt buộc")
                    isValid = false
                }

                // Validate tenant ID (CCCD)
                const tenantId = document.getElementById("tenant-id")
                if (!this.validateCCCD(tenantId.value)) {
                    this.showError(tenantId, "Số CMND/CCCD phải có đúng 12 chữ số")
                    isValid = false
                } else {
                    // Validate CCCD by province
                    const selectedProvince = this.getSelectedProvince("tenant-province")
                    if (selectedProvince && !this.validateCCCDByProvince(tenantId.value, selectedProvince)) {
                        this.showError(tenantId, `Số CCCD không hợp lệ cho tỉnh ${selectedProvince}`)
                        isValid = false
                    }
                }

                // Validate tenant date of birth
                const tenantDob = document.getElementById("tenant-dob")
                if (!this.validateRequired(tenantDob.value)) {
                    this.showError(tenantDob, "Ngày sinh là bắt buộc")
                    isValid = false
                } else if (!this.validateAge(tenantDob.value)) {
                    this.showError(tenantDob, "Người thuê phải đủ 18 tuổi")
                    isValid = false
                }

                // Validate ID issue date
                const tenantIdDate = document.getElementById("tenant-id-date")
                if (!this.validateRequired(tenantIdDate.value)) {
                    this.showError(tenantIdDate, "Ngày cấp CMND/CCCD là bắt buộc")
                    isValid = false
                }

                // Validate ID issue place
                const tenantIdPlace = document.getElementById("tenant-id-place")
                if (!this.validateRequired(tenantIdPlace.value)) {
                    this.showError(tenantIdPlace, "Nơi cấp CMND/CCCD là bắt buộc")
                    isValid = false
                }

                // Validate address fields
                const tenantProvince = document.getElementById("tenant-province")
                if (!this.validateRequired(tenantProvince.value)) {
                    this.showError(tenantProvince, "Vui lòng chọn Tỉnh/Thành phố")
                    isValid = false
                }

                const tenantDistrict = document.getElementById("tenant-district")
                if (!this.validateRequired(tenantDistrict.value)) {
                    this.showError(tenantDistrict, "Vui lòng chọn Quận/Huyện")
                    isValid = false
                }

                const tenantWard = document.getElementById("tenant-ward")
                if (!this.validateRequired(tenantWard.value)) {
                    this.showError(tenantWard, "Vui lòng chọn Phường/Xã")
                    isValid = false
                }

                const tenantStreet = document.getElementById("tenant-street")
                if (!this.validateRequired(tenantStreet.value)) {
                    this.showError(tenantStreet, "Tên đường/Số nhà là bắt buộc")
                    isValid = false
                }

                return isValid
            }

            validateOwnerInfo() {
                let isValid = true

                // Get owner fields using th:field names
                const ownerName = document.querySelector('input[name="owner.fullName"]')
                if (ownerName && !this.validateRequired(ownerName.value)) {
                    this.showError(ownerName, "Họ và tên chủ trọ là bắt buộc")
                    isValid = false
                }

                const ownerPhone = document.querySelector('input[name="owner.phone"]')
                if (ownerPhone && !this.validatePhone(ownerPhone.value)) {
                    this.showError(ownerPhone, "Số điện thoại phải có đúng 10 chữ số và bắt đầu bằng số 0")
                    isValid = false
                }
                const ownerId = document.querySelector('input[name="owner.id"]')
                if (ownerId && !this.validateCCCD(ownerId.value)) {
                    this.showError(ownerId, "Số CMND/CCCD phải có đúng 12 chữ số")
                    isValid = false
                } else if (ownerId && ownerId.value) {
                    // Validate CCCD by province for owner
                    const ownerProvinceSelect = document.querySelector('select[name="owner.province"]')
                    if (ownerProvinceSelect) {
                        const selectedOption = ownerProvinceSelect.options[ownerProvinceSelect.selectedIndex]
                        const selectedProvince = selectedOption ? selectedOption.text : null
                        if (selectedProvince && !this.validateCCCDByProvince(ownerId.value, selectedProvince)) {
                            this.showError(ownerId, `Số CCCD không hợp lệ cho tỉnh ${selectedProvince}`)
                            isValid = false
                        }
                    }
                }

                const ownerBirthday = document.querySelector('input[name="owner.birthday"]')
                if (ownerBirthday && !this.validateRequired(ownerBirthday.value)) {
                    this.showError(ownerBirthday, "Ngày sinh là bắt buộc")
                    isValid = false
                } else if (ownerBirthday && ownerBirthday.value && !this.validateAge(ownerBirthday.value)) {
                    this.showError(ownerBirthday, "Chủ trọ phải đủ 18 tuổi")
                    isValid = false
                }

                const ownerIssueDate = document.querySelector('input[name="owner.issueDate"]')
                if (ownerIssueDate && !this.validateRequired(ownerIssueDate.value)) {
                    this.showError(ownerIssueDate, "Ngày cấp CMND/CCCD là bắt buộc")
                    isValid = false
                }

                const ownerIssuePlace = document.querySelector('input[name="owner.issuePlace"]')
                if (ownerIssuePlace && !this.validateRequired(ownerIssuePlace.value)) {
                    this.showError(ownerIssuePlace, "Nơi cấp CMND/CCCD là bắt buộc")
                    isValid = false
                }

                return isValid
            }

            validateRoomInfo() {
                let isValid = true

                // Validate hostel selection
                const hostelId = document.getElementById("hostelId")
                if (!this.validateRequired(hostelId.value)) {
                    this.showError(hostelId, "Vui lòng chọn khu trọ")
                    isValid = false
                }

                // Validate room selection
                const roomId = document.getElementById("roomId")
                if (!this.validateRequired(roomId.value)) {
                    this.showError(roomId, "Vui lòng chọn phòng trọ")
                    isValid = false
                }

                return isValid
            }

            validateTerms() {
                let isValid = true

                // Validate rent price
                const rentPrice = document.getElementById("rent-price")
                if (!this.validateRequired(rentPrice.value) || !this.validateNumber(rentPrice.value)) {
                    this.showError(rentPrice, "Giá thuê phải là số và lớn hơn 0")
                    isValid = false
                }

                // Validate contract duration
                const contractDuration = document.getElementById("contract-duration")
                if (!this.validateRequired(contractDuration.value) || !this.validateNumber(contractDuration.value)) {
                    this.showError(contractDuration, "Thời hạn hợp đồng phải là số và lớn hơn 0")
                    isValid = false
                }

                // Validate start date
                const startDate = document.getElementById("start-date")
                if (!this.validateRequired(startDate.value)) {
                    this.showError(startDate, "Ngày bắt đầu hợp đồng là bắt buộc")
                    isValid = false
                }

                // Validate payment date
                const paymentDate = document.getElementById("payment-date")
                if (!this.validateRequired(paymentDate.value)) {
                    this.showError(paymentDate, "Ngày thanh toán hàng tháng là bắt buộc")
                    isValid = false
                }

                // Validate contract date
                const contractDate = document.getElementById("contract-date")
                if (!this.validateRequired(contractDate.value)) {
                    this.showError(contractDate, "Ngày lập hợp đồng là bắt buộc")
                    isValid = false
                }

                return isValid
            }

            validateAge(dateOfBirth) {
                if (!dateOfBirth) return false;

                const today = new Date();
                const birthDate = new Date(dateOfBirth);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();

                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }

                return age >= 18;
            }

            validateCCCDByProvince(cccd, province) {
                if (!cccd || !province || cccd.length !== 12) return false;

                const cccdPrefix = cccd.substring(0, 3);
                const provinceCodes = CCCD_PROVINCE_CODES[province];

                if (!provinceCodes) return true; // If province not in list, skip validation

                return provinceCodes.includes(cccdPrefix);
            }

            getSelectedProvince(elementId) {
                const provinceSelect = document.getElementById(elementId);
                if (!provinceSelect) return null;

                const selectedOption = provinceSelect.options[provinceSelect.selectedIndex];
                return selectedOption ? selectedOption.text : null;
            }

            // Validation helper methods
            validateRequired(value) {
                return value && value.toString().trim() !== ""
            }

            validatePhone(phone) {
                const phoneRegex = /^0[0-9]{9}$/;
                return phoneRegex.test(phone);
            }

            validateCCCD(cccd) {
                const cccdRegex = /^[0-9]{12}$/
                return cccdRegex.test(cccd)
            }

            validateEmail(email) {
                return email.includes("@gmail.com") && email.indexOf("@gmail.com") > 0
            }

            validateNumber(value) {
                return !isNaN(value) && Number.parseFloat(value) > 0
            }

            // Error display methods
            showError(element, message) {
                // Remove existing error
                this.clearError(element)

                // Add error class to element
                element.classList.add("is-invalid")

                // Create error message element
                const errorDiv = document.createElement("div")
                errorDiv.className = "invalid-feedback d-block"
                errorDiv.textContent = message
                errorDiv.setAttribute("data-error-for", element.id || element.name)

                // Insert error message after the element
                element.parentNode.insertBefore(errorDiv, element.nextSibling)

                // If element is in a select or input group, adjust positioning
                if (element.parentNode.classList.contains("input-group")) {
                    element.parentNode.parentNode.insertBefore(errorDiv, element.parentNode.nextSibling)
                }
            }

            clearError(element) {
                element.classList.remove("is-invalid")

                // Remove existing error messages
                const errorElements = element.parentNode.querySelectorAll(`[data-error-for="${element.id || element.name}"]`)
                errorElements.forEach((error) => error.remove())

                // Also check parent container for input groups
                if (element.parentNode.classList.contains("input-group")) {
                    const parentErrorElements = element.parentNode.parentNode.querySelectorAll(
                        `[data-error-for="${element.id || element.name}"]`,
                    )
                    parentErrorElements.forEach((error) => error.remove())
                }
            }

            clearAllErrors() {
                // Remove all error classes
                document.querySelectorAll(".is-invalid").forEach((element) => {
                    element.classList.remove("is-invalid")
                })

                // Remove all error messages
                document.querySelectorAll(".invalid-feedback").forEach((error) => {
                    error.remove()
                })
            }

            showFirstErrorTab() {
                // Find first tab with errors
                const tabs = ["tenantInfo", "ownerInfo", "roomInfo", "terms"]

                for (const tabId of tabs) {
                    const tabPane = document.getElementById(tabId)
                    if (tabPane && tabPane.querySelector(".is-invalid")) {
                        // Activate this tab
                        const tabLink = document.querySelector(`[data-tab="${tabId}"]`)
                        if (tabLink) {
                            // Remove active class from all tabs
                            document.querySelectorAll(".nav-link").forEach((link) => {
                                link.classList.remove("active")
                            })
                            document.querySelectorAll(".tab-pane").forEach((pane) => {
                                pane.classList.remove("show", "active")
                            })

                            // Activate the error tab
                            tabLink.classList.add("active")
                            tabPane.classList.add("show", "active")
                        }
                        break
                    }
                }
            }

            showValidationSummary() {
                const errorCount = document.querySelectorAll(".is-invalid").length

                // Create or update validation summary
                let summaryDiv = document.getElementById("validation-summary")
                if (!summaryDiv) {
                    summaryDiv = document.createElement("div")
                    summaryDiv.id = "validation-summary"
                    summaryDiv.className = "alert alert-danger mt-3"

                    // Insert at the top of the form
                    const form = document.querySelector("form")
                    form.insertBefore(summaryDiv, form.firstChild)
                }

                summaryDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fa fa-exclamation-triangle me-2"></i>
                <strong>Vui lòng kiểm tra lại thông tin!</strong>
            </div>
            <small>Có ${errorCount} trường thông tin cần được điền chính xác.</small>
        `

                // Auto hide after 5 seconds
                setTimeout(() => {
                    if (summaryDiv) {
                        summaryDiv.style.display = "none"
                    }
                }, 5000)
            }

            addRealTimeValidation() {
                // Add blur event listeners for real-time validation
                const phoneInputs = ["tenant-phone", "owner.phone"]
                phoneInputs.forEach((id) => {
                    const element = document.getElementById(id) || document.querySelector(`input[name="${id}"]`)
                    if (element) {
                        element.addEventListener("blur", () => {
                            if (element.value && !this.validatePhone(element.value)) {
                                this.showError(element, "Số điện thoại phải có đúng 10 chữ số và bắt đầu bằng số 0")
                            } else {
                                this.clearError(element)
                            }
                        })
                    }
                })

                const cccdInputs = ["tenant-id", "owner.id"]
                cccdInputs.forEach((id) => {
                    const element = document.getElementById(id) || document.querySelector(`input[name="${id}"]`)
                    if (element) {
                        element.addEventListener("blur", () => {
                            if (element.value && !this.validateCCCD(element.value)) {
                                this.showError(element, "Số CMND/CCCD phải có đúng 12 chữ số")
                            } else {
                                this.clearError(element)
                            }
                        })
                    }
                })

                const emailInputs = ["tenant-email", "owner.email"]
                emailInputs.forEach((id) => {
                    const element = document.getElementById(id) || document.querySelector(`input[name="${id}"]`)
                    if (element) {
                        element.addEventListener("blur", () => {
                            if (element.value && !this.validateEmail(element.value)) {
                                this.showError(element, "Email phải có định dạng @gmail.com")
                            } else {
                                this.clearError(element)
                            }
                        })
                    }
                })

                // Add real-time validation for age
                const dobInputs = ["tenant-dob"]
                dobInputs.forEach((id) => {
                    const element = document.getElementById(id)
                    if (element) {
                        element.addEventListener("blur", () => {
                            if (element.value && !this.validateAge(element.value)) {
                                this.showError(element, "Phải đủ 18 tuổi")
                            } else {
                                this.clearError(element)
                            }
                        })
                    }
                })

                // Add real-time validation for owner birthday
                const ownerBirthday = document.querySelector('input[name="owner.birthday"]')
                if (ownerBirthday) {
                    ownerBirthday.addEventListener("blur", () => {
                        if (ownerBirthday.value && !this.validateAge(ownerBirthday.value)) {
                            this.showError(ownerBirthday, "Phải đủ 18 tuổi")
                        } else {
                            this.clearError(ownerBirthday)
                        }
                    })
                }

                // Add real-time validation for CCCD by province
                const tenantIdInput = document.getElementById("tenant-id");
                const tenantProvinceSelect = document.getElementById("tenant-province");

                if (tenantIdInput && tenantProvinceSelect) {
                    const validateTenantCCCD = () => {
                        const cccd = tenantIdInput.value;
                        const selectedProvince = this.getSelectedProvince("tenant-province");

                        console.log("Real-time validation:", { cccd, selectedProvince }); // Debug log

                        if (cccd && selectedProvince && this.validateCCCD(cccd)) {
                            if (!this.validateCCCDByProvince(cccd, selectedProvince)) {
                                this.showError(tenantIdInput, `Số CCCD không hợp lệ cho tỉnh ${selectedProvince}. Ba số đầu phải là: ${CCCD_PROVINCE_CODES[selectedProvince]?.join(', ')}`);
                            } else {
                                this.clearError(tenantIdInput);
                            }
                        }
                    };

                    tenantIdInput.addEventListener("blur", validateTenantCCCD);
                    tenantIdInput.addEventListener("input", validateTenantCCCD); // Thêm validation khi nhập
                    tenantProvinceSelect.addEventListener("change", validateTenantCCCD);
                }
            }
            validateCCCDWithProvince() {
                const tenantIdInput = document.getElementById("tenant-id");
                const cccd = tenantIdInput.value;
                const selectedProvince = this.getSelectedProvince("tenant-province");

                if (cccd && selectedProvince && this.validateCCCD(cccd)) {
                    if (!this.validateCCCDByProvince(cccd, selectedProvince)) {
                        this.showError(tenantIdInput, `Số CCCD không hợp lệ cho tỉnh ${selectedProvince}. Ba số đầu phải là: ${CCCD_PROVINCE_CODES[selectedProvince]?.join(', ')}`);
                    }
                }
            }
            submitForm() {
                // Submit the form
                const form = document.querySelector("form")
                if (form) {
                    // Show loading state
                    const saveBtn = document.getElementById("btn-save")
                    const originalText = saveBtn.innerHTML
                    saveBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Đang lưu...'
                    saveBtn.disabled = true

                    // Submit form
                    form.submit()
                }
            }

            updateContract() {
                // Handle contract update
                const updateBtn = document.getElementById("btn-update")
                const originalText = updateBtn.innerHTML
                updateBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Đang cập nhật...'
                updateBtn.disabled = true

                // Simulate update process
                setTimeout(() => {
                    updateBtn.innerHTML = originalText
                    updateBtn.disabled = false

                    // Show success message
                    this.showSuccessMessage("Hợp đồng đã được cập nhật thành công!")
                }, 2000)
            }

            showSuccessMessage(message) {
                // Create success alert
                const alertDiv = document.createElement("div")
                alertDiv.className = "alert alert-success alert-dismissible fade show mt-3"
                alertDiv.innerHTML = `
            <i class="fa fa-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `

                // Insert at the top of the form
                const form = document.querySelector("form")
                form.insertBefore(alertDiv, form.firstChild)

                // Auto hide after 3 seconds
                setTimeout(() => {
                    alertDiv.remove()
                }, 3000)
            }
        }

        // Initialize validation when DOM is loaded
        document.addEventListener("DOMContentLoaded", () => {
            new ContractValidator()
        })

    </script> 

    <script th:src="@{/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/contract.js}"></script>
</body>

</html>
