<!DOCTYPE html>
<html lang="en">

<head th:replace="~{/layouts/head}">
    <title>Chi Ti·∫øt - Nh√† Tr·ªç Xanh</title>
</head>

<body>
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/sidebar-host}"></div>
    <div class="main-content">
        <h4 class="mb-4">Th√¥ng tin t√†i kho·∫£n</h4>
        <hr>
        <form th:action="@{/chu-tro/profile-host}" th:object="${hostInfo}" method="post" enctype="multipart/form-data">
            <div class="row g-4">
                <!-- C·ªôt tr√°i -->
                <div class="col-12 col-lg-4 text-center text-lg-start">
                    <div class="host-card text-center">
                        <input type="file" id="avatarInput" name="avatarFile" class="d-none" accept="image/*">
                        <img th:src="${user.avatar != null and user.avatar.startsWith('/uploads/') 
              ? user.avatar 
              : '/uploads/' + user.avatar}" class="host-profile-img mb-3" alt="Avatar" id="avatarPreview"
                            style="cursor: pointer;" onclick="document.getElementById('avatarInput').click()" />


                        <h5 th:text="${user.fullname != null ? user.fullname : 'Ch∆∞a c√≥ t√™n'}">Nguy·ªÖn VƒÉn A</h5>
                        <span th:if="${user.enabled}" class="host-badge host-verified ms-1">ƒêang ho·∫°t ƒë·ªông</span>
                        <span th:if="${!user.enabled}" class="host-badge host-inactive ms-1">Ch∆∞a k√≠ch ho·∫°t</span>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm"><i class="fa fa-pen"></i> Ch·ªânh s·ª≠a</button>
                        </div>

                        <div class="host-section mt-4 text-start">
                            <h6><i class="fa fa-circle-info me-1"></i> Th√¥ng tin b·ªï sung</h6>
                            <p class="mb-1">Ng√†y tham gia: <strong>01/06/2025</strong></p>
                            <p class="mb-1">T·ªïng s·ªë khu tr·ªç: <strong th:text="${totalHostels}">5 khu tr·ªç</strong></p>
                            <p class="mb-1">X√°c minh t√†i kho·∫£n:
                                <span class="host-badge host-verified ms-1"><i class="fa fa-check-circle"></i> ƒê√£ x√°c
                                    minh</span>
                            </p>
                            <p class="mb-0">ƒê√°nh gi√°: <span class="host-rating">‚òÖ 4.8/5</span> (30 ƒë√°nh gi√°)</p>
                        </div>
                    </div>
                </div>
                <!-- C·ªôt ph·∫£i -->
                <div class="col-12 col-lg-8">
                    <!-- Th√¥ng tin c√° nh√¢n -->
                    <div class="host-section mb-4">
                        <h6><i class="fa fa-user me-1"></i> Th√¥ng tin c√° nh√¢n</h6>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">H·ªç v√† t√™n</label>
                                <input type="text" class="form-control" th:field="*{fullname}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ng√†y sinh</label>
                                <input type="date" class="form-control" th:field="*{birthday}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">S·ªë CMND/CCCD</label>
                                <input type="text" class="form-control" th:field="*{cccd}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ng√†y c·∫•p</label>
                                <input type="date" class="form-control" th:field="*{issueDate}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">N∆°i c·∫•p</label>
                                <input type="text" class="form-control" th:field="*{issuePlace}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-block">Gi·ªõi t√≠nh</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="genderNam"
                                        value="true" th:checked="${hostInfo.gender} == true">
                                    <label class="form-check-label" for="genderNam">Nam</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="genderNu"
                                        value="false" th:checked="${hostInfo.gender} == false">
                                    <label class="form-check-label" for="genderNu">N·ªØ</label>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Th√¥ng tin li√™n h·ªá -->
                    <div class="host-section">
                        <h6><i class="fa fa-envelope me-1"></i> Th√¥ng tin li√™n h·ªá</h6>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" th:field="*{email}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="text" class="form-control" th:field="*{phone}">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">T·ªânh/Th√†nh ph·ªë</label>
                                <select class="form-select" id="province" name="province"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Qu·∫≠n/Huy·ªán</label>
                                <select class="form-select" id="district" name="district"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ph∆∞·ªùng/X√£</label>
                                <select class="form-select" id="ward" name="ward"></select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">T√™n ƒë∆∞·ªùng/S·ªë nh√†</label>
                                <input type="text" class="form-control" id="street" name="street">
                            </div>
                            <!-- üîπ Hidden ch·ª©a ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß -->
                            <input type="hidden" name="address" th:field="*{address}" id="fullAddress">
                            <input type="hidden" id="savedAddress" th:value="*{address}" />
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    </div>

    <script>
        document.getElementById('avatarInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        class VietnamAddressAPI {
            constructor() {
                this.provinceSelect = document.getElementById('province');
                this.districtSelect = document.getElementById('district');
                this.wardSelect = document.getElementById('ward');
                this.streetInput = document.getElementById('street');
                this.fullAddress = document.getElementById('fullAddress');

                this.init();
            }

            async init() {
                await this.loadProvinces();
                this.addListeners();
            }

            async loadProvinces() {
                const res = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await res.json();
                this.provinceSelect.innerHTML = '<option value="">Ch·ªçn T·ªânh/TP</option>';
                provinces.forEach(p => {
                    this.provinceSelect.innerHTML += `<option value="${p.code}">${p.name}</option>`;
                });
            }

            async loadDistricts(provinceCode) {
                const res = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const data = await res.json();
                this.districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
                data.districts.forEach(d => {
                    this.districtSelect.innerHTML += `<option value="${d.code}">${d.name}</option>`;
                });
                this.wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
            }

            async loadWards(districtCode) {
                const res = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                const data = await res.json();
                this.wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
                data.wards.forEach(w => {
                    this.wardSelect.innerHTML += `<option value="${w.code}">${w.name}</option>`;
                });
            }

            addListeners() {
                this.provinceSelect.addEventListener('change', async (e) => {
                    const code = e.target.value;
                    if (code) await this.loadDistricts(code);
                    this.updateFullAddress();
                });

                this.districtSelect.addEventListener('change', async (e) => {
                    const code = e.target.value;
                    if (code) await this.loadWards(code);
                    this.updateFullAddress();
                });

                this.wardSelect.addEventListener('change', () => this.updateFullAddress());
                this.streetInput.addEventListener('input', () => this.updateFullAddress());
            }

            updateFullAddress() {
                const street = this.streetInput.value;
                const wardText = this.wardSelect.options[this.wardSelect.selectedIndex]?.text || '';
                const districtText = this.districtSelect.options[this.districtSelect.selectedIndex]?.text || '';
                const provinceText = this.provinceSelect.options[this.provinceSelect.selectedIndex]?.text || '';
                const address = [street, wardText, districtText, provinceText].filter(Boolean).join(', ');
                this.fullAddress.value = address;
            }

            async setInitialAddress(fullAddress) {
                if (!fullAddress) return;

                const parts = fullAddress.split(',').map(p => p.trim());
                if (parts.length < 4) return;

                const [street, wardName, districtName, provinceName] = parts;

                this.streetInput.value = street;

                const provincesRes = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await provincesRes.json();
                const province = provinces.find(p => p.name.toLowerCase().includes(provinceName.toLowerCase()));
                if (!province) return;
                this.provinceSelect.value = province.code;
                await this.loadDistricts(province.code);

                const districtsRes = await fetch(`https://provinces.open-api.vn/api/p/${province.code}?depth=2`);
                const districtData = await districtsRes.json();
                const district = districtData.districts.find(d => d.name.toLowerCase().includes(districtName.toLowerCase()));
                if (!district) return;
                this.districtSelect.value = district.code;
                await this.loadWards(district.code);

                const wardsRes = await fetch(`https://provinces.open-api.vn/api/d/${district.code}?depth=2`);
                const wardData = await wardsRes.json();
                const ward = wardData.wards.find(w => w.name.toLowerCase().includes(wardName.toLowerCase()));
                if (ward) this.wardSelect.value = ward.code;

                this.updateFullAddress();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const api = new VietnamAddressAPI();
            const savedAddress = document.getElementById('savedAddress')?.value;
            if (savedAddress) {
                await api.setInitialAddress(savedAddress);
            }
        });

    </script>

</body>

</html>