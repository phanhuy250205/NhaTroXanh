<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{/layouts/head}">
    <title>Chi Tiết - Nhà Trọ Xanh</title>
</head>
<style>
    .toast-container-host {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 300px;
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .alert-host {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        margin-bottom: 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        position: relative;
        animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .alert-host.success {
        background-color: #d1e7dd;
        color: #0f5132;
        border-left: 5px solid #198754;
    }

    .alert-host.danger {
        background-color: #f8d7da;
        color: #842029;
        border-left: 5px solid #dc3545;
    }

    .alert-icon {
        margin-right: 10px;
        font-size: 1.2rem;
    }

    .alert-message {
        flex-grow: 1;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        color: inherit;
        margin-left: 10px;
    }

    .host-profile-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
    }

    .host-verified {
        background-color: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .host-inactive {
        background-color: #dc3545;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .host-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .verification-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .verification-label {
        flex: 0 0 auto;
    }

    .verification-badge {
        flex: 0 0 auto;
    }
</style>

<body>
    <!-- NAVBAR -->
    <div th:replace="~{/layouts/sidebar-host}"></div>
    <div class="main-content">
        <div class="toast-container-host" id="toastContainer">
            <div th:if="${success}" class="alert-host success" role="alert">
                <i class="alert-icon fas fa-check-circle"></i>
                <span class="alert-message" th:text="${success}"></span>
                <button type="button" class="btn-close" aria-label="Đóng thông báo">×</button>
            </div>
            <div th:if="${error}" class="alert-host danger" role="alert">
                <i class="alert-icon fas fa-exclamation-circle"></i>
                <span class="alert-message" th:text="${error}"></span>
                <button type="button" class="btn-close" aria-label="Đóng thông báo">×</button>
            </div>
        </div>
        <h4 class="mb-4">Thông tin tài khoản</h4>
        <hr>
        <form th:action="@{/chu-tro/profile-host}" th:object="${hostInfo}" method="post" enctype="multipart/form-data">
            <div class="row g-4">
                <!-- Cột trái -->
                <div class="col-12 col-lg-4 text-center text-lg-start">
                    <div class="host-card text-center">
                        <input type="file" id="avatarInput" name="avatarFile" class="d-none" accept="image/*">
                        <img th:src="${user.avatar != null and user.avatar.startsWith('/uploads/') 
              ? user.avatar 
              : '/uploads/' + user.avatar}" class="host-profile-img mb-3" alt="Avatar" id="avatarPreview"
                            style="cursor: pointer;" onclick="document.getElementById('avatarInput').click()" />

                        <h5 th:text="${user.fullname != null ? user.fullname : 'Chưa có tên'}">Nguyễn Văn A</h5>
                        <span th:if="${user.enabled}" class="host-badge host-verified ms-1">Đang hoạt động</span>
                        <span th:if="${!user.enabled}" class="host-badge host-inactive ms-1">Chưa kích hoạt</span>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-outline-primary btn-sm"><i class="fa fa-pen"></i> Cập
                                nhật</button>
                        </div>

                        <div class="host-section mt-4 text-start">
                            <h6><i class="fa fa-circle-info me-1"></i> Thông tin bổ sung</h6>
                            <p class="mb-1">Ngày tham gia: <strong>01/06/2025</strong></p>
                            <p class="mb-1">Tổng số khu trọ: <strong th:text="${totalHostels}">5 khu trọ</strong></p>
                            <p class="mb-1">Xác minh tài khoản:
                                <span
                                    th:if="${hostInfo.cccdNumber != null and hostInfo.cccdNumber != '' and user.avatar != null and user.avatar != ''}"
                                    class="host-badge host-verified ms-1">
                                    <i class="fa fa-check-circle"></i> Đã xác minh
                                </span>
                                <span
                                    th:if="${hostInfo.cccdNumber == null or hostInfo.cccdNumber == '' or user.avatar == null or user.avatar == ''}"
                                    class="host-badge host-inactive ms-1">
                                    <i class="fa fa-times-circle"></i> Chưa xác minh
                                </span>
                            </p>
                            <p class="mb-0">Đánh giá: <span class="host-rating">★ 4.8/5</span> (30 đánh giá)</p>
                        </div>
                    </div>
                </div>
                <!-- Cột phải -->
                <div class="col-12 col-lg-8">
                    <!-- Thông tin cá nhân -->
                    <div class="host-section mb-4">
                        <h6><i class="fa fa-user me-1"></i> Thông tin cá nhân</h6>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Họ và tên</label>
                                <input type="text" class="form-control" th:field="*{fullname}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày sinh</label>
                                <input type="date" class="form-control" th:field="*{birthday}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số CMND/CCCD</label>
                                <input type="text" class="form-control" th:field="*{cccdNumber}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ngày cấp</label>
                                <input type="date" class="form-control" th:field="*{issueDate}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nơi cấp</label>
                                <input type="text" class="form-control" th:field="*{issuePlace}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-block">Giới tính</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="genderNam"
                                        value="true" th:checked="${hostInfo.gender} == true">
                                    <label class="form-check-label" for="genderNam">Nam</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="genderNu"
                                        value="false" th:checked="${hostInfo.gender} == false">
                                    <label class="form-check-label" for="genderNu">Nữ</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thông tin liên hệ -->
                    <div class="host-section">
                        <h6><i class="fa fa-envelope me-1"></i> Thông tin liên hệ</h6>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" th:field="*{email}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Số điện thoại</label>
                                <input type="text" class="form-control" th:field="*{phone}" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tỉnh/Thành phố</label>
                                <select class="form-select" id="province" name="province"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quận/Huyện</label>
                                <select class="form-select" id="district" name="district"></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Phường/Xã</label>
                                <select class="form-select" id="ward" name="ward"></select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Tên đường/Số nhà</label>
                                <input type="text" class="form-control" id="street" name="street">
                            </div>
                            <!-- Hidden chứa địa chỉ đầy đủ -->
                            <input type="hidden" name="address" th:field="*{address}" id="fullAddress">
                            <input type="hidden" id="savedAddress" th:value="*{address}" />
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- JavaScript for Avatar Preview and Address API -->
    <script>
        // Avatar Preview
        document.getElementById('avatarInput').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Vietnam Address API
        class VietnamAddressAPI {
            constructor() {
                this.provinceSelect = document.getElementById('province');
                this.districtSelect = document.getElementById('district');
                this.wardSelect = document.getElementById('ward');
                this.streetInput = document.getElementById('street');
                this.fullAddress = document.getElementById('fullAddress');

                this.init();
            }

            async init() {
                await this.loadProvinces();
                this.addListeners();
            }

            async loadProvinces() {
                const res = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await res.json();
                this.provinceSelect.innerHTML = '<option value="">Chọn Tỉnh/TP</option>';
                provinces.forEach(p => {
                    this.provinceSelect.innerHTML += `<option value="${p.code}">${p.name}</option>`;
                });
            }

            async loadDistricts(provinceCode) {
                const res = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const data = await res.json();
                this.districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                data.districts.forEach(d => {
                    this.districtSelect.innerHTML += `<option value="${d.code}">${d.name}</option>`;
                });
                this.wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
            }

            async loadWards(districtCode) {
                const res = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
                const data = await res.json();
                this.wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                data.wards.forEach(w => {
                    this.wardSelect.innerHTML += `<option value="${w.code}">${w.name}</option>`;
                });
            }

            addListeners() {
                this.provinceSelect.addEventListener('change', async (e) => {
                    const code = e.target.value;
                    if (code) await this.loadDistricts(code);
                    this.updateFullAddress();
                });

                this.districtSelect.addEventListener('change', async (e) => {
                    const code = e.target.value;
                    if (code) await this.loadWards(code);
                    this.updateFullAddress();
                });

                this.wardSelect.addEventListener('change', () => this.updateFullAddress());
                this.streetInput.addEventListener('input', () => this.updateFullAddress());
            }

            updateFullAddress() {
                const street = this.streetInput.value;
                const wardText = this.wardSelect.options[this.wardSelect.selectedIndex]?.text || '';
                const districtText = this.districtSelect.options[this.districtSelect.selectedIndex]?.text || '';
                const provinceText = this.provinceSelect.options[this.provinceSelect.selectedIndex]?.text || '';
                const address = [street, wardText, districtText, provinceText].filter(Boolean).join(', ');
                this.fullAddress.value = address;
            }

            async setInitialAddress(fullAddress) {
                if (!fullAddress) return;

                const parts = fullAddress.split(',').map(p => p.trim());
                if (parts.length < 4) return;

                const [street, wardName, districtName, provinceName] = parts;

                this.streetInput.value = street;

                const provincesRes = await fetch('https://provinces.open-api.vn/api/p/');
                const provinces = await provincesRes.json();
                const province = provinces.find(p => p.name.toLowerCase().includes(provinceName.toLowerCase()));
                if (!province) return;
                this.provinceSelect.value = province.code;
                await this.loadDistricts(province.code);

                const districtsRes = await fetch(`https://provinces.open-api.vn/api/p/${province.code}?depth=2`);
                const districtData = await districtsRes.json();
                const district = districtData.districts.find(d => d.name.toLowerCase().includes(districtName.toLowerCase()));
                if (!district) return;
                this.districtSelect.value = district.code;
                await this.loadWards(district.code);

                const wardsRes = await fetch(`https://provinces.open-api.vn/api/d/${district.code}?depth=2`);
                const wardData = await wardsRes.json();
                const ward = wardData.wards.find(w => w.name.toLowerCase().includes(wardName.toLowerCase()));
                if (ward) this.wardSelect.value = ward.code;

                this.updateFullAddress();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const api = new VietnamAddressAPI();
            const savedAddress = document.getElementById('savedAddress')?.value;
            if (savedAddress) {
                await api.setInitialAddress(savedAddress);
            }
        });
        document.addEventListener("DOMContentLoaded", function () {
            const alerts = document.querySelectorAll(".alert-host");
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => alert.remove(), 500);
                }, 3000);

                // Đóng khi nhấn nút X
                const closeBtn = alert.querySelector(".btn-close");
                if (closeBtn) {
                    closeBtn.addEventListener("click", () => alert.remove());
                }
            });
        });
    </script>
</body>

</html>